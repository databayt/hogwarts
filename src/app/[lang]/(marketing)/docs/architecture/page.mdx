---
title: "Architecture"
description: "Comprehensive architecture documentation for Hogwarts School Automation Platform"
---

# Architecture

## Overview

This section provides access to the comprehensive **Architecture Documentation** for the Hogwarts School Automation Platform. The architecture follows **enterprise-grade patterns** for multi-tenant SaaS, ensuring scalability, security, and maintainability.

**Current Scale:** 50+ schools, 12,000+ students, 800+ teachers in production

**Status:** âœ… 100% MVP Complete, Production-Ready

---

## Documents

### ğŸ—ï¸ architecture.md
**Location:** `/architecture.md` (project root)
**Size:** 25,000+ words
**Last Updated:** January 2025

The comprehensive technical architecture document covering:
- **System Architecture Overview**: High-level design, technology stack rationale
- **Multi-Tenant Architecture**: Subdomain routing, tenant isolation, schoolId scoping
- **Database Architecture**: 28 Prisma models, finance schema (40,028 lines), indexes
- **API Architecture**: Server Actions pattern, validation, error handling
- **Authentication & Authorization**: NextAuth v5, 8-role RBAC, OAuth integration
- **Frontend Architecture**: Component hierarchy, Server/Client components, data fetching
- **Security Architecture**: OWASP Top 10 mitigation, data privacy compliance
- **Infrastructure & Deployment**: Vercel serverless, CI/CD pipeline, disaster recovery
- **Performance & Scalability**: Core Web Vitals, optimization strategies, scalability plans
- **Monitoring & Observability**: Sentry, Vercel Analytics, health checks
- **Development Workflow**: Git workflow, code review, testing strategy
- **Internationalization**: Arabic/English support, RTL/LTR handling
- **Compliance**: FERPA, GDPR, COPPA, WCAG 2.1 AA
- **Future Evolution**: Microservices, event sourcing, mobile apps, AI/ML, blockchain

[View architecture.md â†’](/architecture.md)

---

## Key Architecture Highlights

### Multi-Tenant by Design

**Critical:** Every database operation MUST be scoped by `schoolId`:

```typescript
// âŒ WRONG - No tenant scoping
await prisma.student.findMany()

// âœ… CORRECT - Scoped by schoolId
const { schoolId } = await getTenantContext()
await prisma.student.findMany({
  where: { schoolId }
})
```

**Tenant Isolation Strategy:**
- **Subdomain routing**: `school.databayt.org` â†’ `/[lang]/s/school/...`
- **Database scoping**: All business models include `schoolId` field
- **Unique constraints**: `@@unique([email, schoolId])` allows same email across schools
- **Session context**: JWT includes `schoolId` from subdomain
- **Cookie domain**: `.databayt.org` for cross-subdomain authentication

---

### Technology Stack

**Framework & Language:**
- Next.js 15.4.4 (App Router) with React 19.1.0
- TypeScript 5.x (strict mode)
- Turbopack (development + production builds)

**Database & ORM:**
- PostgreSQL (Neon serverless)
- Prisma 6.14.0 with 28 model files
- Connection pooling (max 100 connections)

**Authentication:**
- NextAuth v5 (Auth.js 5.0.0-beta.29)
- JWT strategy with 24-hour sessions
- OAuth providers: Google, Facebook

**UI & Styling:**
- Tailwind CSS 4 (utility-first)
- shadcn/ui components (New York style, Radix UI primitives)
- Semantic typography system (no hardcoded text/font classes)

**Testing:**
- Vitest 2.0.6 + React Testing Library
- Playwright 1.55.0 for E2E testing
- 95%+ coverage target

**Deployment:**
- Vercel (serverless functions, edge network)
- CI/CD via GitHub Actions
- Sentry for error tracking

---

## Architecture Diagrams

### High-Level System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CLIENT LAYER                          â”‚
â”‚  Browser â†’ React 19 + Server Components        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           EDGE NETWORK LAYER                    â”‚
â”‚  Vercel Edge (300+ locations)                   â”‚
â”‚  - Middleware (subdomain routing, auth, i18n)   â”‚
â”‚  - CDN (static assets, images)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           APPLICATION LAYER                     â”‚
â”‚  Next.js 15 Serverless Functions                â”‚
â”‚  - Server Components (SSR)                      â”‚
â”‚  - Server Actions ("use server")                â”‚
â”‚  - API Routes                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           DATA ACCESS LAYER                     â”‚
â”‚  Prisma ORM 6.14.0                              â”‚
â”‚  - 28 Model Files                               â”‚
â”‚  - Multi-tenant query scoping                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           DATABASE LAYER                        â”‚
â”‚  PostgreSQL (Neon Serverless)                   â”‚
â”‚  - Multi-tenant schema (schoolId)               â”‚
â”‚  - Row-level security (RLS)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Composition Hierarchy

```
1. UI Components (shadcn/ui)
   â””â”€ Button, Input, Dialog, Select, etc.

2. Atom Components (Compose 2+ UI)
   â””â”€ FormField, DataTable, Modal, etc.

3. Feature Components (Business Logic)
   â””â”€ StudentForm, AttendanceTable, FeeCard, etc.

4. Page Components (Route Handlers)
   â””â”€ Dashboard, Students List, Fee Management, etc.
```

### Multi-Tenant URL Transformation

| Original URL | Rewritten Internal URL |
|--------------|------------------------|
| `https://hogwarts.databayt.org/ar/dashboard` | `/ar/s/hogwarts/dashboard` |
| `https://salem.databayt.org/en/students` | `/en/s/salem/students` |
| `https://tenant---preview.vercel.app/ar/fees` | `/ar/s/tenant/fees` |

---

## Database Schema Overview

**Total Models: 28 Prisma Files**

| Category | Models | Key Features |
|----------|--------|--------------|
| **Authentication** | User, Account, Session | NextAuth v5 tables |
| **School Management** | School, SchoolYear, Period, Term | Academic structure |
| **People** | Student, Teacher, Guardian | User management |
| **Academic** | Subject, Class, Assignment | Core academics |
| **Attendance** | Attendance, GeoAttendance | Tracking systems |
| **Assessments** | Exam, QuestionBank, ExamResult | Testing |
| **Finance** | 50+ models (40,028 lines) | Double-entry bookkeeping |
| **Infrastructure** | Classroom, Timetable | Physical resources |
| **Compliance** | LegalDocument, LegalConsent | FERPA/GDPR |

### Finance Schema Highlights

**Double-Entry Bookkeeping:**
- Chart of Accounts (hierarchical)
- Journal Entries (debits & credits)
- Fee Management (structures, payments, refunds)
- Accounting Reports (balance sheet, income statement)

```prisma
model JournalEntry {
  id          String   @id @default(cuid())
  schoolId    String
  entryDate   DateTime
  description String
  lines       JournalEntryLine[]  // Debits and Credits

  @@index([schoolId, entryDate])
}

model JournalEntryLine {
  id        String   @id @default(cuid())
  accountId String
  debit     Decimal?  @db.Decimal(10, 2)
  credit    Decimal?  @db.Decimal(10, 2)

  // Business rule: debit XOR credit
  @@check(sql("(debit IS NOT NULL AND credit IS NULL) OR (debit IS NULL AND credit IS NOT NULL)"))
}
```

---

## Security Architecture

### OWASP Top 10 Mitigation

**1. Injection Prevention:**
- âœ… Parameterized queries via Prisma (SQL injection prevention)
- âœ… React auto-escaping (XSS prevention)
- âœ… Zod validation at boundaries

**2. Authentication Security:**
- âœ… NextAuth v5 with httpOnly cookies
- âœ… CSRF protection built-in
- âœ… 24-hour session expiry
- âœ… Rate limiting on login

**3. Access Control:**
- âœ… 8-role RBAC system
- âœ… Tenant isolation (schoolId verification)
- âœ… Row-level security checks
- âœ… Audit logging for sensitive operations

**4. Data Privacy:**
- âœ… FERPA compliance (parental consent, audit logs)
- âœ… GDPR compliance (right to access, right to be forgotten)
- âœ… COPPA compliance (parental consent for under 13)
- âœ… WCAG 2.1 AA (accessibility)

---

## Performance & Scalability

### Performance Targets

| Metric | Target | Current (Prod) |
|--------|--------|----------------|
| **First Contentful Paint (FCP)** | < 1.5s | 1.2s âœ… |
| **Largest Contentful Paint (LCP)** | < 2.5s | 2.1s âœ… |
| **Time to Interactive (TTI)** | < 3.5s | 3.0s âœ… |
| **Cumulative Layout Shift (CLS)** | < 0.1 | 0.05 âœ… |
| **Lighthouse Score** | > 90 | 94 âœ… |

### Optimization Strategies

**1. Image Optimization:**
- Next/Image automatic optimization (WebP/AVIF)
- Responsive sizes, lazy loading

**2. Code Splitting:**
- Dynamic imports for heavy components
- Server Components reduce JS bundle

**3. Database Query Optimization:**
- Eager loading with Prisma includes
- Connection pooling (max 100 connections)
- Indexes on foreign keys and frequently queried fields

**4. Caching:**
- ISR (Incremental Static Regeneration) for semi-static pages
- SWR for client-side caching
- Edge caching via Vercel CDN

### Scalability Projections

| Metric | Current | 3 Years |
|--------|---------|---------|
| **Schools** | 50+ | 5,000 |
| **Students** | 12,000+ | 1,000,000 |
| **Teachers** | 800+ | 50,000 |
| **Concurrent Users** | ~500 | ~10,000 |
| **Requests/Day** | ~10,000 | ~1,000,000 |

**Scalability Strategies:**
- Horizontal scaling via serverless (automatic)
- Read replicas for heavy read operations (future)
- Redis caching layer (future)
- Microservices migration (Year 2-3)

---

## API Architecture

### Server Actions Pattern

**Why Server Actions over REST?**
- âœ… Type-safe (TypeScript end-to-end)
- âœ… No API route boilerplate
- âœ… Automatic form validation
- âœ… Progressive enhancement

**Example: Create Student Action**

```typescript
// actions.ts
"use server"

export async function createStudent(formData: FormData) {
  // 1. Authentication check
  const session = await auth()
  if (!session) return { error: "Unauthorized" }

  // 2. Get tenant context
  const { schoolId } = await getTenantContext()

  // 3. Validate with Zod
  const parsed = studentSchema.safeParse(Object.fromEntries(formData))
  if (!parsed.success) return { error: "Validation failed" }

  // 4. Execute with schoolId (CRITICAL)
  const student = await db.student.create({
    data: { ...parsed.data, schoolId }
  })

  // 5. Revalidate cache
  revalidatePath("/students")

  return { success: true, student }
}
```

### Error Handling

**Centralized Error Handler:**
- ApiError class for structured errors
- Zod validation errors
- Prisma errors (duplicate, not found)
- Generic fallback

**Logging:**
- Structured logging with pino
- Sentry for error tracking
- Audit logs for sensitive operations

---

## Authentication & Authorization

### NextAuth v5 Configuration

**Authentication Strategy:**
- JWT with httpOnly cookies
- 24-hour session expiry
- Cross-subdomain cookies (`.databayt.org`)

**OAuth Providers:**
- Google
- Facebook
- Credentials (email/password with bcrypt)

### Role-Based Access Control (RBAC)

**8 User Roles:**

| Role | Description | schoolId |
|------|-------------|----------|
| **DEVELOPER** | Platform admin | null (access all schools) |
| **ADMIN** | School administrator | required |
| **TEACHER** | Teaching staff | required |
| **STUDENT** | Enrolled students | required |
| **GUARDIAN** | Parents/guardians | required |
| **ACCOUNTANT** | Finance staff | required |
| **STAFF** | General school staff | required |
| **USER** | Default role | required |

**Permission Matrix:**

Feature-specific permissions enforced at:
1. Route level (middleware)
2. Component level (conditional rendering)
3. Action level (authorization checks)
4. Database level (schoolId scoping)

---

## Internationalization (i18n)

### Language Support

**Current:**
- **Arabic (ar)** - RTL, default language
- **English (en)** - LTR

**Roadmap Q3 2024:**
- French (fr)
- Spanish (es)
- Hindi (hi)
- Mandarin (zh)

### URL Structure

```
/{locale}/{route}

Examples:
/ar/dashboard        # Arabic dashboard
/en/students         # English students page
/ar/s/hogwarts/fees  # Arabic school subdomain
```

### RTL/LTR Support

**Directional Styling:**
- `dir="rtl"` or `dir="ltr"` on `<html>` tag
- Tailwind start/end utilities (`ms-4`, `pe-4`)
- Font switching (Tajawal for Arabic, Inter for English)

**Dictionary System:**
- 800+ translation keys
- Server-side dictionary loading
- Type-safe dictionary access

---

## Monitoring & Observability

### Error Tracking (Sentry)

**Features:**
- Automatic error capture
- Session replay (with sensitive data masking)
- Performance monitoring
- Release tracking

### Performance Monitoring (Vercel Analytics)

**Metrics:**
- Core Web Vitals (FCP, LCP, TTI, CLS, FID)
- Server response time (TTFB)
- Custom performance events

### Application Logging

**Structured Logging:**
- pino for JSON logs
- Log levels: info, warn, error
- Context: schoolId, userId, requestId

### Health Checks

**API Endpoint:** `/api/health`

**Checks:**
- Database connection
- Uptime
- Version (Git commit SHA)

---

## Development Workflow

### Local Development

```bash
# 1. Clone repository
git clone https://github.com/hogwarts/app.git
cd app

# 2. Install dependencies
pnpm install

# 3. Setup environment
cp .env.example .env.local

# 4. Setup database
pnpm prisma generate
pnpm prisma migrate dev
pnpm db:seed

# 5. Start dev server
pnpm dev
# Open http://localhost:3000
```

### Git Workflow

**Branch Strategy:**
```
main (production)
  â””â”€ feature/add-attendance-qr
  â””â”€ fix/fee-calculation-bug
```

**Commit Convention:**
```bash
feat(students): add QR code attendance
fix(fees): correct discount calculation
refactor(db): optimize student queries
```

### Automated Quality Checks

**Pre-Commit Hooks:**
- âœ… TypeScript type check
- âœ… ESLint rules
- âœ… Prettier formatting
- âœ… Unit tests
- âœ… Multi-tenant safety checks

**CI/CD Pipeline:**
- GitHub Actions for automated testing
- Vercel for automatic deployments
- Production deployment on merge to `main`

---

## Testing Strategy

### Testing Pyramid

```
        /\
       /  \      E2E Tests (10%)
      /    \     Playwright
     /------\
    /        \
   /          \  Integration Tests (30%)
  /            \ Server actions, API routes
 /______________\

                Unit Tests (60%)
                Components, utilities, validation
```

### Test Coverage

**Target:** 95%+ coverage

**Test Files:** 234 test files across all features

**Testing Tools:**
- Vitest 2.0.6 (unit tests)
- React Testing Library (component tests)
- Playwright 1.55.0 (E2E tests)

---

## Future Architecture Evolution

### Roadmap

**Q1 2024:**
- Mobile apps (React Native)
- Advanced analytics

**Q2 2024:**
- Digital classroom (LMS)
- Video conferencing

**Q4 2024:**
- AI teaching assistant
- Predictive analytics

**Year 2-3:**
- Microservices migration
- Event-driven architecture
- Blockchain credentials

---

## Related Documentation

### Core Documentation
- [Product Requirements Document (PRD)](/docs/prd) - Complete requirements
- [Technology Stack](/docs/stack) - Detailed tech stack
- [Multi-Tenant Architecture](/docs/architecture-multi-tenant) - Tenant isolation
- [Contributing Guide](/docs/contribute) - Development guidelines
- [Roadmap 2024-2025](/docs/roadmap) - Product roadmap

### Technical Guides
- [Server Actions](/docs/server-actions) - API pattern guide
- [Authentication](/docs/authentication) - NextAuth v5 setup
- [Database Schema](/docs/database) - Prisma models
- [Testing](/docs/testing) - Testing patterns
- [Deployment](/docs/deployment) - CI/CD and Vercel

### External References
- [Next.js 15 Docs](https://nextjs.org/docs) - Framework documentation
- [Prisma Docs](https://www.prisma.io/docs) - ORM documentation
- [NextAuth v5](https://authjs.dev) - Authentication library
- [Vercel Docs](https://vercel.com/docs) - Deployment platform

---

## Architecture Validation

**Status:** âœ… Production-Ready

**Quality Metrics:**
- âœ… 100% MVP complete
- âœ… 50+ schools in production
- âœ… 12,000+ students, 800+ teachers
- âœ… 95%+ test coverage
- âœ… Lighthouse score: 94
- âœ… Zero critical security vulnerabilities
- âœ… FERPA/GDPR/COPPA compliant

**Performance Metrics:**
- âœ… FCP: 1.2s (target < 1.5s)
- âœ… LCP: 2.1s (target < 2.5s)
- âœ… TTI: 3.0s (target < 3.5s)
- âœ… CLS: 0.05 (target < 0.1)

---

## Feedback & Questions

Have questions about the architecture or need clarification?

- **GitHub Issues**: [Open an issue](https://github.com/hogwarts/app/issues)
- **Email**: architecture@hogwarts.app
- **Discord**: [Join our community](https://discord.gg/hogwarts)

---

**Last Updated:** January 2025
**Version:** 1.0
**Status:** âœ… Production-Ready
**Total Documentation:** 25,000+ words in architecture.md
