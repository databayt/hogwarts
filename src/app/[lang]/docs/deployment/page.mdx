# Deployment Guide

Deploy Hogwarts School Management System to production with confidence. This guide covers various deployment options, from quick cloud deployment to custom infrastructure setups.

## Deployment Options

### ‚òÅÔ∏è Cloud Deployment (Recommended)

The fastest way to get started with zero infrastructure management.

| Provider | Setup Time | Best For | Pricing |
|----------|------------|----------|---------|
| **Vercel** | 5 minutes | Most users | Free tier available |
| **Netlify** | 10 minutes | Static sites | Free tier available |
| **Railway** | 15 minutes | Full-stack apps | Usage-based |
| **Render** | 15 minutes | Docker deployments | Free tier available |

### üñ•Ô∏è Self-Hosted

Full control over your infrastructure and data.

| Method | Complexity | Best For |
|--------|------------|----------|
| **VPS** | Medium | Single school |
| **Kubernetes** | High | Enterprise/Multi-school |
| **Docker** | Low | Development/Testing |
| **Bare Metal** | High | Maximum control |

## Quick Deploy to Vercel

### Prerequisites

- GitHub account
- Vercel account (free)
- Database (Neon recommended)

### Step 1: Fork Repository

```bash
# Fork the Hogwarts repository to your GitHub account
https://github.com/hogwarts/hogwarts-app
```

### Step 2: Import to Vercel

1. Go to [vercel.com/new](https://vercel.com/new)
2. Import your forked repository
3. Select "Next.js" as framework preset

### Step 3: Configure Environment Variables

Add these required environment variables:

```bash
# Database
DATABASE_URL=postgresql://user:pass@host/db

# Authentication
AUTH_SECRET=generated-secret-key
NEXTAUTH_URL=https://your-domain.vercel.app

# Application
NEXT_PUBLIC_APP_URL=https://your-domain.vercel.app

# Email
RESEND_API_KEY=re_your_key

# Optional OAuth
GOOGLE_CLIENT_ID=your-google-id
GOOGLE_CLIENT_SECRET=your-google-secret
```

### Step 4: Deploy

Click "Deploy" and wait 2-3 minutes for build completion.

### Step 5: Configure Domain

```
1. Go to Settings ‚Üí Domains
2. Add your custom domain
3. Configure DNS records
4. SSL certificate auto-generated
```

## Production Configuration

### Environment Variables

Complete list of production environment variables:

```bash
# === Required ===
NODE_ENV=production
DATABASE_URL=postgresql://user:password@host:5432/dbname
AUTH_SECRET=your-auth-secret-min-32-chars

# === Application ===
NEXT_PUBLIC_APP_URL=https://yourdomain.com
NEXT_PUBLIC_APP_NAME=Hogwarts School System
NEXT_PUBLIC_APP_DESCRIPTION=School Management Platform

# === Database ===
DATABASE_POOL_MIN=2
DATABASE_POOL_MAX=10
DATABASE_POOL_IDLE=10000

# === Authentication ===
NEXTAUTH_URL=https://yourdomain.com
NEXTAUTH_URL_INTERNAL=http://localhost:3000
JWT_EXPIRY=24h
SESSION_UPDATE_AGE=5m

# === Email Service ===
RESEND_API_KEY=re_live_xxx
EMAIL_FROM=noreply@yourdomain.com
EMAIL_REPLY_TO=support@yourdomain.com

# === OAuth Providers (Optional) ===
GOOGLE_CLIENT_ID=xxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=xxx
FACEBOOK_CLIENT_ID=xxx
FACEBOOK_CLIENT_SECRET=xxx

# === File Storage ===
STORAGE_TYPE=local|s3|vercel-blob
AWS_ACCESS_KEY_ID=xxx
AWS_SECRET_ACCESS_KEY=xxx
AWS_S3_BUCKET=hogwarts-uploads
AWS_S3_REGION=us-east-1

# === SMS Gateway (Optional) ===
TWILIO_ACCOUNT_SID=xxx
TWILIO_AUTH_TOKEN=xxx
TWILIO_PHONE_NUMBER=+1234567890

# === Payment Gateway (Optional) ===
STRIPE_PUBLIC_KEY=pk_live_xxx
STRIPE_SECRET_KEY=sk_live_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx

# === Monitoring ===
SENTRY_DSN=https://xxx@sentry.io/xxx
VERCEL_ANALYTICS_ID=xxx

# === Feature Flags ===
ENABLE_REGISTRATION=true
ENABLE_OAUTH=true
ENABLE_2FA=true
MAINTENANCE_MODE=false
```

### Database Setup

#### Using Neon (Recommended)

1. Create account at [neon.tech](https://neon.tech)
2. Create new project
3. Copy connection string
4. Run migrations:

```bash
# Set DATABASE_URL in .env
export DATABASE_URL="your-neon-connection-string"

# Run migrations
pnpm prisma migrate deploy

# Seed initial data (optional)
pnpm db:seed
```

#### Using PostgreSQL

```bash
# Create database
createdb hogwarts_production

# Set connection string
export DATABASE_URL="postgresql://user:pass@localhost:5432/hogwarts_production"

# Run migrations
pnpm prisma migrate deploy
```

### Build Optimization

#### Next.js Configuration

```javascript
// next.config.js
module.exports = {
  // Enable static exports
  output: 'standalone',

  // Image optimization
  images: {
    domains: ['yourdomain.com'],
    formats: ['image/avif', 'image/webp'],
  },

  // Bundle optimization
  experimental: {
    optimizePackageImports: [
      '@/components/ui',
      'lucide-react',
      'date-fns',
    ],
  },

  // Remove console in production
  compiler: {
    removeConsole: {
      exclude: ['error', 'warn'],
    },
  },
}
```

#### Performance Optimizations

```bash
# Build with analysis
pnpm build:analyze

# Check bundle size
pnpm analyze

# Optimize images
pnpm optimize:images
```

## Multi-Tenant Setup

### Subdomain Configuration

#### Vercel

```json
// vercel.json
{
  "rewrites": [
    {
      "source": "/:path*",
      "has": [
        {
          "type": "host",
          "value": "(?<subdomain>.*).yourdomain.com"
        }
      ],
      "destination": "/api/tenant/:subdomain/:path*"
    }
  ]
}
```

#### Nginx

```nginx
server {
    server_name ~^(?<subdomain>.+)\.yourdomain\.com$;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header X-Subdomain $subdomain;
    }
}
```

### SSL Certificates

#### Wildcard Certificate

```bash
# Using Let's Encrypt
certbot certonly --manual --preferred-challenges dns \
  -d "*.yourdomain.com" -d "yourdomain.com"
```

#### Auto SSL with Vercel

Vercel automatically provisions SSL certificates for:
- Main domain
- All subdomains
- Custom domains

## Scaling Strategies

### Horizontal Scaling

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    image: hogwarts:latest
    deploy:
      replicas: 3
    environment:
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - hogwarts

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - app
```

### Database Scaling

```sql
-- Connection pooling
ALTER SYSTEM SET max_connections = 200;
ALTER SYSTEM SET shared_buffers = '256MB';

-- Create read replica
CREATE PUBLICATION hogwarts_pub FOR ALL TABLES;
```

### Caching Strategy

```javascript
// Redis caching
const redis = new Redis({
  host: process.env.REDIS_HOST,
  port: 6379,
});

// Cache frequently accessed data
await redis.setex('schools:list', 3600, JSON.stringify(schools));
```

## Monitoring & Logging

### Application Monitoring

```javascript
// Sentry setup
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
});
```

### Log Management

```javascript
// Winston logging
import winston from 'winston';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
  ],
});
```

### Health Checks

```javascript
// pages/api/health.js
export default function handler(req, res) {
  const health = {
    uptime: process.uptime(),
    message: 'OK',
    timestamp: Date.now(),
    database: await checkDatabase(),
  };

  res.status(200).json(health);
}
```

## Backup & Recovery

### Automated Backups

```bash
#!/bin/bash
# backup.sh - Run daily via cron

DATE=$(date +%Y%m%d)
BACKUP_DIR="/backups"

# Database backup
pg_dump $DATABASE_URL > "$BACKUP_DIR/db_$DATE.sql"

# Files backup
tar -czf "$BACKUP_DIR/files_$DATE.tar.gz" /uploads

# Upload to S3
aws s3 cp "$BACKUP_DIR/db_$DATE.sql" s3://backups/
aws s3 cp "$BACKUP_DIR/files_$DATE.tar.gz" s3://backups/

# Clean old backups (keep 30 days)
find $BACKUP_DIR -type f -mtime +30 -delete
```

### Disaster Recovery

```bash
# Restore database
psql $DATABASE_URL < backup.sql

# Restore files
tar -xzf files_backup.tar.gz -C /

# Verify integrity
pnpm test:integrity
```

## Security Hardening

### Security Headers

```javascript
// middleware.js
export function middleware(request) {
  const response = NextResponse.next();

  // Security headers
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('X-XSS-Protection', '1; mode=block');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  response.headers.set('Permissions-Policy', 'camera=(), microphone=()');

  // CSP
  response.headers.set(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval';"
  );

  return response;
}
```

### Rate Limiting

```javascript
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests
  message: 'Too many requests',
});
```

## Deployment Checklist

### Pre-Deployment

- [ ] Environment variables configured
- [ ] Database migrations run
- [ ] SSL certificates configured
- [ ] Domain DNS configured
- [ ] Backup strategy defined
- [ ] Monitoring setup
- [ ] Security headers configured
- [ ] Rate limiting enabled

### Post-Deployment

- [ ] Health check passing
- [ ] All pages loading
- [ ] Authentication working
- [ ] Email sending
- [ ] File uploads working
- [ ] Payment processing (if enabled)
- [ ] Mobile responsive
- [ ] Performance acceptable

### Testing

```bash
# Run production tests
pnpm test:production

# Load testing
pnpm test:load

# Security scan
pnpm audit

# Lighthouse audit
pnpm lighthouse https://yourdomain.com
```

## Troubleshooting

### Common Issues

**Build Failures**
```bash
# Clear cache
rm -rf .next node_modules
pnpm install
pnpm build
```

**Database Connection**
```bash
# Test connection
psql $DATABASE_URL -c "SELECT 1"

# Check SSL mode
DATABASE_URL="...?sslmode=require"
```

**Memory Issues**
```bash
# Increase Node memory
NODE_OPTIONS="--max-old-space-size=4096" pnpm build
```

## Support

Need help with deployment?

- üìö [Deployment FAQ](/docs/support/faq#deployment)
- üí¨ [Community Forum](https://forum.hogwarts.app)
- üìß [Email Support](mailto:deploy@hogwarts.app)
- üé• [Video Tutorials](/docs/support/videos)

---

**Ready to deploy?** Follow our [Quick Start Guide](/docs/quick-start) or use the [One-Click Deploy](https://vercel.com/new/clone?repository-url=https://github.com/hogwarts/app) button!