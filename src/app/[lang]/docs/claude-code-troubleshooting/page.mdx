# Claude Code Troubleshooting

Diagnose and resolve common issues with Claude Code quickly using this comprehensive troubleshooting guide.

## Quick Diagnostics

Start here for any issue:

```bash
# Check Claude Code installation
claude --version

# Verify API key is set
echo $ANTHROPIC_API_KEY

# Test basic functionality
claude -p "Echo: test"

# Check configuration
cat ~/.claude/settings.json

# View recent logs
tail -n 50 ~/.claude/logs/claude.log
```

## Common Issues

### Installation Problems

#### Claude Command Not Found

```bash
claude
# bash: claude: command not found
```

**Causes**:
1. Claude Code not installed
2. Not in PATH
3. Wrong shell profile

**Solutions**:

```bash
# Verify installation
which claude

# Install/reinstall
npm install -g claude-code

# Add to PATH (if needed)
export PATH="$PATH:$(npm bin -g)"

# Add to shell profile
echo 'export PATH="$PATH:$(npm bin -g)"' >> ~/.zshrc
source ~/.zshrc
```

#### Permission Denied During Installation

```bash
npm install -g claude-code
# Error: EACCES: permission denied
```

**Solutions**:

```bash
# Option 1: Use sudo (macOS/Linux)
sudo npm install -g claude-code

# Option 2: Fix npm permissions (recommended)
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.zshrc
source ~/.zshrc
npm install -g claude-code

# Option 3: Use nvm (recommended)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install node
npm install -g claude-code
```

### Authentication Issues

#### Invalid API Key

```
Error: Invalid API key
```

**Diagnosis**:

```bash
# Check if API key is set
echo $ANTHROPIC_API_KEY

# Check format (should start with sk-ant-)
echo $ANTHROPIC_API_KEY | grep -E '^sk-ant-'
```

**Solutions**:

```bash
# Set API key
export ANTHROPIC_API_KEY="sk-ant-your-key-here"

# Add to shell profile (persistent)
echo 'export ANTHROPIC_API_KEY="sk-ant-your-key-here"' >> ~/.zshrc
source ~/.zshrc

# Or use .env file
echo 'ANTHROPIC_API_KEY=sk-ant-your-key-here' > .env
```

**Verify key is valid**:

```bash
curl https://api.anthropic.com/v1/messages \
  -H "x-api-key: $ANTHROPIC_API_KEY" \
  -H "anthropic-version: 2023-06-01" \
  -H "content-type: application/json" \
  -d '{"model":"claude-3-5-sonnet-20250514","max_tokens":1024,"messages":[{"role":"user","content":"Hello"}]}'
```

#### API Key Expired

```
Error: API key has expired
```

**Solutions**:

1. Go to [console.anthropic.com](https://console.anthropic.com)
2. Generate new API key
3. Update environment variable
4. Restart Claude Code session

### Configuration Problems

#### Configuration Not Loading

```
Claude ignores settings.json
```

**Diagnosis**:

```bash
# Check file exists
ls -la ~/.claude/settings.json

# Verify JSON syntax
cat ~/.claude/settings.json | jq .

# Check permissions
ls -l ~/.claude/settings.json
```

**Solutions**:

```bash
# Fix JSON syntax errors
# Run through JSON validator
cat ~/.claude/settings.json | jq . > ~/.claude/settings-valid.json
mv ~/.claude/settings-valid.json ~/.claude/settings.json

# Ensure readable
chmod 644 ~/.claude/settings.json

# Check precedence (local overrides project)
ls .claude/settings.local.json
```

#### Permissions Not Persisting

```
Claude asks for permission every time
```

**Causes**:
1. Settings not saved correctly
2. Wrong scope
3. Pattern mismatch

**Solutions**:

```json
// In ~/.claude/settings.json or .claude/settings.json
{
  "allowedTools": [
    "Read",
    "Glob",
    "Grep",
    "Edit",
    "Write",
    "Bash(git:*)",  // Note: Use exact pattern
    "Bash(npm:*)"
  ]
}
```

**Verify settings are loaded**:

```bash
claude /permissions
```

#### CLAUDE.md Not Being Read

```
Claude doesn't follow CLAUDE.md instructions
```

**Diagnosis**:

```bash
# Check file exists in project root
ls -la CLAUDE.md

# Check file is not empty
cat CLAUDE.md

# Verify encoding
file CLAUDE.md
# Should be: UTF-8 Unicode text
```

**Solutions**:

```bash
# File must be named exactly CLAUDE.md (case-sensitive)
mv claude.md CLAUDE.md

# Ensure UTF-8 encoding
iconv -f ISO-8859-1 -t UTF-8 CLAUDE.md > CLAUDE-utf8.md
mv CLAUDE-utf8.md CLAUDE.md

# Check for BOM (byte order mark) - can cause issues
hexdump -C CLAUDE.md | head -n 1
# If shows EF BB BF at start, remove BOM:
tail -c +4 CLAUDE.md > CLAUDE-no-bom.md
mv CLAUDE-no-bom.md CLAUDE.md
```

**Verify Claude reads it**:

```bash
claude -p "What does CLAUDE.md say about our testing strategy?"
```

### Runtime Errors

#### Tool Execution Fails

```
Error: Tool 'Bash' failed to execute
```

**Diagnosis**:

```bash
# Check if command exists
which git
which npm

# Test command manually
git status

# Check PATH
echo $PATH
```

**Solutions**:

```bash
# Ensure required tools are installed
brew install git

# Fix PATH if needed
export PATH="/usr/local/bin:$PATH"

# Check shell environment
echo $SHELL
```

#### File Access Denied

```
Error: EACCES: permission denied, open '/path/to/file'
```

**Solutions**:

```bash
# Check file permissions
ls -l /path/to/file

# Fix permissions
chmod 644 /path/to/file

# Check directory permissions
ls -ld /path/to/

# Fix directory permissions
chmod 755 /path/to/
```

#### Out of Memory

```
Error: JavaScript heap out of memory
```

**Solutions**:

```bash
# Increase Node.js memory limit
export NODE_OPTIONS="--max-old-space-size=4096"

# Or run with more memory
node --max-old-space-size=4096 $(which claude)

# Add to shell profile
echo 'export NODE_OPTIONS="--max-old-space-size=4096"' >> ~/.zshrc
```

### MCP Issues

#### MCP Server Not Connecting

```
Error: Failed to connect to MCP server 'postgres'
```

**Diagnosis**:

```bash
# Test MCP server
claude /mcp test postgres

# Check server configuration
cat ~/.claude/settings.json | jq '.mcp.servers'

# Test connection manually
npx @modelcontextprotocol/server-postgres "${DATABASE_URL}"
```

**Solutions**:

```json
// Verify configuration in settings.json
{
  "mcp": {
    "servers": {
      "postgres": {
        "transport": "stdio",
        "command": "npx",
        "args": [
          "-y",
          "@modelcontextprotocol/server-postgres",
          "${DATABASE_URL}"
        ]
      }
    }
  }
}
```

```bash
# Ensure DATABASE_URL is set
echo $DATABASE_URL

# Test database connection
psql $DATABASE_URL -c "SELECT 1"
```

#### MCP Server Timeout

```
Error: MCP server timeout
```

**Solutions**:

```json
{
  "mcp": {
    "servers": {
      "slow-api": {
        "timeout": 60000  // Increase timeout (ms)
      }
    }
  }
}
```

#### MCP Tool Not Available

```
Error: Tool 'query_database' not found
```

**Diagnosis**:

```bash
# List available MCP tools
claude /mcp info postgres

# Verify server is running
claude /mcp list
```

**Solutions**:

1. Ensure server is installed: `npm install -g @modelcontextprotocol/server-postgres`
2. Restart Claude session
3. Check server logs for errors

### GitHub Integration Issues

#### GitHub Authentication Failed

```
Error: GitHub authentication failed
```

**Diagnosis**:

```bash
# Check GitHub CLI is installed
gh --version

# Check authentication status
gh auth status

# Test GitHub token
curl -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user
```

**Solutions**:

```bash
# Login with GitHub CLI
gh auth login

# Or set token manually
export GITHUB_TOKEN="ghp_your_token_here"

# Verify token has required scopes
gh auth status
```

#### Rate Limit Exceeded

```
Error: API rate limit exceeded
```

**Solutions**:

```bash
# Check rate limit status
curl -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/rate_limit

# Wait for reset (shown in error message)
# Or use authenticated token (5000 req/hour vs 60 unauthenticated)

# Use GraphQL for complex queries (separate limit)
```

### Performance Issues

#### Slow Responses

```
Claude takes very long to respond
```

**Diagnosis**:

```bash
# Check network latency
ping api.anthropic.com

# Monitor resource usage
top -o cpu

# Check disk I/O
iostat
```

**Solutions**:

1. **Use faster model for simple tasks**:
   ```bash
   /model
   # Select Haiku
   ```

2. **Clear context**:
   ```bash
   /clear
   ```

3. **Reduce file reading**:
   ```
   You: "Review only src/components/App.tsx, not the entire codebase"
   ```

4. **Increase timeout**:
   ```json
   {
     "commandTimeout": 300000  // 5 minutes
   }
   ```

#### High Memory Usage

```
Claude using too much memory
```

**Solutions**:

```bash
# Clear conversation history
/clear

# Restart Claude
# Exit and start new session

# Increase Node.js memory limit
export NODE_OPTIONS="--max-old-space-size=8192"
```

#### Slow File Operations

```
Reading files takes too long
```

**Solutions**:

1. **Use .claudeignore**:
   ```bash
   # .claudeignore
   node_modules/
   dist/
   build/
   *.log
   ```

2. **Reduce scope**:
   ```
   You: "Search only in src/ directory"
   ```

3. **Check disk performance**:
   ```bash
   # Test read speed
   dd if=/dev/zero of=testfile bs=1M count=1024
   ```

## Debug Mode

### Enable Verbose Logging

```bash
# Run with verbose flag
claude --verbose

# Or set environment variable
export CLAUDE_DEBUG=true
claude
```

**Output includes**:
- API requests/responses
- Tool executions
- Configuration loading
- MCP communications
- Hook executions

### View Logs

```bash
# View recent logs
tail -f ~/.claude/logs/claude.log

# Search logs
grep "Error" ~/.claude/logs/claude.log

# Filter by date
grep "2025-01-15" ~/.claude/logs/claude.log
```

### Debug MCP

```bash
# Debug MCP specifically
export CLAUDE_MCP_DEBUG=true
claude

# Test individual MCP server
claude /mcp test postgres --debug
```

### Debug Hooks

```bash
# Run without hooks (to isolate issue)
claude --no-hooks

# Enable hook debugging
export CLAUDE_HOOKS_DEBUG=true
claude
```

## Performance Optimization

### Reduce Context Size

```bash
# Clear between unrelated tasks
/clear

# Limit file reading
You: "Read only the header of this file"

# Use focused prompts
You: "Review just the authentication logic, ignore the rest"
```

### Cache Frequently Used Data

```bash
# Use MCP memory server
{
  "mcp": {
    "servers": {
      "memory": {
        "transport": "stdio",
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-memory"]
      }
    }
  }
}
```

### Optimize Settings

```json
{
  "model": "claude-3-5-haiku-20241022",  // Faster for simple tasks
  "maxTokens": 2048,                     // Limit response length
  "commandTimeout": 120000               // Reasonable timeout
}
```

## Error Messages Guide

### Common Error Codes

| Error Code | Meaning | Solution |
|------------|---------|----------|
| `EACCES` | Permission denied | Check file/directory permissions |
| `ENOENT` | File not found | Verify file path |
| `ECONNREFUSED` | Connection refused | Check service is running |
| `ETIMEDOUT` | Timeout | Increase timeout or check network |
| `401` | Unauthorized | Check API key |
| `429` | Rate limit | Wait or reduce frequency |
| `500` | Server error | Retry or report bug |

### Interpreting Stack Traces

```
Error: ENOENT: no such file or directory, open 'missing-file.txt'
    at Object.openSync (fs.js:498:3)
    at Object.readFileSync (fs.js:394:35)
    at ClaudeCode.readFile (claude.js:156:21)
```

**Reading stack traces**:
1. **First line**: Error type and message
2. **Subsequent lines**: Call stack (newest first)
3. **Look for**: Your code or file paths

**Solution**: The file `missing-file.txt` doesn't exist. Create it or fix the path.

## When to Report Bugs

Report bugs when:

1. **Reproducible**: Error occurs consistently
2. **Unexpected**: Behavior differs from documentation
3. **Not user error**: You've ruled out configuration issues
4. **Latest version**: Bug exists in current version

### Bug Report Template

```markdown
## Bug Description
[Clear description of the issue]

## Steps to Reproduce
1. Run `claude`
2. Execute command "..."
3. See error

## Expected Behavior
[What should happen]

## Actual Behavior
[What actually happens]

## Environment
- OS: macOS 14.2
- Node: v20.11.0
- Claude Code: v1.2.3
- Model: claude-3-5-sonnet-20250514

## Configuration
```json
{
  "allowedTools": ["Read", "Edit"]
}
```

## Error Output
```
[Full error message and stack trace]
```

## Additional Context
[Any other relevant information]
```

### Where to Report

- **GitHub Issues**: https://github.com/anthropics/claude-code/issues
- **Discord**: Claude Code community
- **Support**: support@anthropic.com

## Getting Help

### Before Asking for Help

1. Check this troubleshooting guide
2. Search existing GitHub issues
3. Review documentation
4. Try verbose mode: `claude --verbose`
5. Gather error messages and logs

### Where to Get Help

1. **Documentation**: https://docs.claude.com/claude-code
2. **GitHub Discussions**: Community support
3. **Discord**: Real-time help
4. **Stack Overflow**: Tag: `claude-code`
5. **Official Support**: For enterprise customers

### Providing Information

When asking for help, include:

```bash
# System information
uname -a
node --version
claude --version

# Configuration (remove secrets!)
cat ~/.claude/settings.json

# Recent logs
tail -n 100 ~/.claude/logs/claude.log

# Error output
[Full error message]
```

## Advanced Troubleshooting

### Clean Reinstall

```bash
# 1. Uninstall
npm uninstall -g claude-code

# 2. Remove configuration
rm -rf ~/.claude

# 3. Clear npm cache
npm cache clean --force

# 4. Reinstall
npm install -g claude-code

# 5. Reconfigure
claude /init
```

### Reset Configuration

```bash
# Backup current config
cp -r ~/.claude ~/.claude-backup

# Reset to defaults
rm -rf ~/.claude
claude /init

# Restore if needed
cp -r ~/.claude-backup ~/.claude
```

### Database Issues (SQLite)

```bash
# Check database file
ls -lh ~/.claude/storage.db

# Verify database integrity
sqlite3 ~/.claude/storage.db "PRAGMA integrity_check;"

# Rebuild if corrupted
mv ~/.claude/storage.db ~/.claude/storage.db.backup
claude  # Will create new database
```

## Preventive Measures

### Regular Maintenance

```bash
# Weekly tasks
- Review audit logs
- Update Claude Code: `npm update -g claude-code`
- Clean old logs: `rm ~/.claude/logs/*.old`
- Verify configurations: `cat ~/.claude/settings.json | jq`

# Monthly tasks
- Rotate API keys
- Review and update permissions
- Check for new features/updates
- Backup configurations
```

### Monitoring

```bash
# Set up monitoring
cat > ~/.claude/healthcheck.sh << 'EOF'
#!/bin/bash
claude -p "Echo: healthcheck" > /dev/null 2>&1
if [ $? -eq 0 ]; then
  echo "$(date): Claude Code healthy"
else
  echo "$(date): Claude Code error" | mail -s "Claude Alert" admin@example.com
fi
EOF

chmod +x ~/.claude/healthcheck.sh

# Add to crontab (hourly check)
crontab -e
# Add: 0 * * * * ~/.claude/healthcheck.sh >> ~/.claude/healthcheck.log
```

## Next Steps

- [Configuration](/docs/claude-code-configuration) - Proper setup prevents issues
- [Best Practices](/docs/claude-code-best-practices) - Avoid common pitfalls
- [Security](/docs/claude-code-security) - Secure configuration
- [Performance](/docs/claude-code-best-practices#performance-tips) - Optimize performance

## Resources

- **FAQ**: Frequently asked questions
- **Known Issues**: Current bugs and workarounds
- **Changelog**: Recent fixes and improvements
- **Community Forum**: Ask questions, share solutions

---

*Most issues have simple solutions. Start with the basics: verify installation, check configuration, review logs. When in doubt, enable verbose mode and read the error messages carefully.*
