# API Reference

Complete API documentation for all exam system endpoints with request/response examples and error handling.

---

## Overview

Base URL: `/api/exam`

All API endpoints:
- Require authentication via NextAuth session
- Include automatic `schoolId` scoping for multi-tenancy
- Return consistent error responses
- Support pagination where applicable
- Use server actions for mutations

---

## Authentication

All requests require a valid session:

```typescript
const session = await auth();
if (!session?.user?.schoolId) {
  return { success: false, error: "Unauthorized" };
}
```

### Headers Required
```
Cookie: next-auth.session-token=xxx
Content-Type: application/json
```

---

## Exam Management APIs

### Create Exam

Creates a new exam with scheduling and configuration.

```typescript
POST /api/exam/manage/create

Request:
{
  title: string;                    // Required, 3-100 chars
  description?: string;             // Optional, max 500 chars
  classId: string;                  // Required, UUID
  subjectId: string;                // Required, UUID
  type: ExamType;                   // MIDTERM|FINAL|QUIZ|TEST|PRACTICAL
  startDate: string;                // ISO 8601 datetime
  endDate: string;                  // ISO 8601 datetime
  totalMarks: number;               // Required, 1-1000
  passingMarks: number;             // Required, 0-totalMarks
  instructions?: string;            // Optional, max 2000 chars
  roomIds?: string[];               // Optional, array of UUIDs
  invigilatorIds?: string[];        // Optional, array of UUIDs
  settings?: {
    randomizeQuestions: boolean;
    randomizeOptions: boolean;
    showResultsImmediately: boolean;
    allowLateSubmission: boolean;
    lateSubmissionPenalty?: number;  // Percentage
    browserLockdown: boolean;
  };
}

Response (Success):
{
  success: true;
  data: {
    examId: string;
    status: "DRAFT";
    createdAt: string;
  }
}

Response (Error):
{
  success: false;
  error: string;
  code: "INVALID_DATE" | "ROOM_CONFLICT" | "PERMISSION_DENIED";
  details?: {
    conflicts: ConflictDetail[];
  }
}
```

### Update Exam

Updates existing exam details.

```typescript
PUT /api/exam/manage/update/{examId}

Request:
{
  // Any fields from create exam (partial update)
  title?: string;
  startDate?: string;
  // ... etc
}

Response:
{
  success: true;
  data: {
    examId: string;
    updatedFields: string[];
  }
}
```

### Get Exam Details

Retrieves complete exam information.

```typescript
GET /api/exam/manage/{examId}

Response:
{
  success: true;
  data: {
    id: string;
    title: string;
    description: string;
    class: {
      id: string;
      name: string;
      subject: {
        id: string;
        name: string;
      }
    };
    startDate: string;
    endDate: string;
    duration: number;         // Minutes
    totalMarks: number;
    passingMarks: number;
    status: ExamStatus;
    questions: Question[];
    enrolledStudents: number;
    rooms: Room[];
    invigilators: Teacher[];
    statistics?: {
      submitted: number;
      graded: number;
      averageScore: number;
    }
  }
}
```

### List Exams

Retrieves paginated list of exams with filters.

```typescript
GET /api/exam/manage/list

Query Parameters:
  page: number;           // Default: 1
  limit: number;          // Default: 20, Max: 100
  status?: ExamStatus;    // DRAFT|SCHEDULED|PUBLISHED|IN_PROGRESS|COMPLETED
  classId?: string;
  subjectId?: string;
  startDate?: string;     // ISO date
  endDate?: string;       // ISO date
  search?: string;        // Search in title/description
  sortBy?: string;        // startDate|title|status
  sortOrder?: string;     // asc|desc

Response:
{
  success: true;
  data: {
    exams: Exam[];
    pagination: {
      page: number;
      limit: number;
      total: number;
      totalPages: number;
    }
  }
}
```

### Delete Exam

Soft deletes an exam (marks as archived).

```typescript
DELETE /api/exam/manage/{examId}

Response:
{
  success: true;
  data: {
    examId: string;
    archivedAt: string;
  }
}
```

### Publish Exam

Changes exam status from DRAFT to PUBLISHED.

```typescript
POST /api/exam/manage/{examId}/publish

Request:
{
  notifyStudents: boolean;
  notifyInvigilators: boolean;
  scheduledPublishDate?: string;  // Optional future publish
}

Response:
{
  success: true;
  data: {
    examId: string;
    status: "PUBLISHED";
    publishedAt: string;
    notifications: {
      studentsSent: number;
      invigilatorsSent: number;
    }
  }
}
```

### Check Conflicts

Validates exam schedule for conflicts.

```typescript
POST /api/exam/manage/check-conflicts

Request:
{
  startDate: string;
  endDate: string;
  roomIds: string[];
  invigilatorIds: string[];
  classId: string;
  excludeExamId?: string;  // When updating existing exam
}

Response:
{
  success: true;
  data: {
    hasConflicts: boolean;
    conflicts: [
      {
        type: "ROOM" | "TEACHER" | "STUDENT" | "TIMETABLE";
        severity: "BLOCKING" | "WARNING";
        description: string;
        conflictingExam?: {
          id: string;
          title: string;
        };
        suggestedResolution?: string;
      }
    ]
  }
}
```

---

## Question Bank APIs

### Create Question

Adds a new question to the bank.

```typescript
POST /api/exam/qbank/create

Request:
{
  type: QuestionType;
  text: string;                    // 10-5000 chars
  options?: [                      // For MCQ/Matching
    {
      text: string;
      isCorrect: boolean;
      explanation?: string;
    }
  ];
  correctAnswer: string | string[]; // Depends on type
  marks: number;                    // 0.5-100, increments of 0.5
  difficulty: "EASY" | "MEDIUM" | "HARD" | "EXPERT";
  subject: string;
  topic: string;
  subtopic?: string;
  tags: string[];                   // 1-10 tags, max 50 chars each
  bloomsLevel: BloomsLevel;
  estimatedTime: number;            // Minutes, 1-60
  explanation?: string;
  attachments?: [
    {
      type: "IMAGE" | "DIAGRAM" | "AUDIO";
      url: string;
      caption?: string;
    }
  ];
  metadata?: {
    source?: string;
    year?: number;
    examBoard?: string;
    learningOutcome?: string;
  }
}

Response:
{
  success: true;
  data: {
    questionId: string;
    duplicates?: Question[];  // Similar questions detected
  }
}
```

### Update Question

Updates existing question.

```typescript
PUT /api/exam/qbank/update/{questionId}

Request:
{
  // Any fields from create question (partial update)
}

Response:
{
  success: true;
  data: {
    questionId: string;
    version: number;  // Version tracking
    previousVersion: number;
  }
}
```

### Search Questions

Advanced search with filters.

```typescript
GET /api/exam/qbank/search

Query Parameters:
  q?: string;                    // Search query
  type?: QuestionType[];         // Filter by types
  difficulty?: Difficulty[];     // Filter by difficulty
  subject?: string;
  topic?: string[];
  tags?: string[];              // Comma-separated
  bloomsLevel?: BloomsLevel[];
  marksMin?: number;
  marksMax?: number;
  usageCountMax?: number;       // Unused or rarely used
  excludeExamId?: string;       // Exclude questions from exam
  page: number;
  limit: number;

Response:
{
  success: true;
  data: {
    questions: [
      {
        id: string;
        type: string;
        text: string;
        marks: number;
        difficulty: string;
        tags: string[];
        usageCount: number;
        averageScore?: number;
        lastUsed?: string;
      }
    ];
    pagination: {
      page: number;
      limit: number;
      total: number;
    };
    facets?: {                  // Optional aggregations
      byType: Record<string, number>;
      byDifficulty: Record<string, number>;
      byTopic: Record<string, number>;
    }
  }
}
```

### Bulk Import Questions

Imports multiple questions from file.

```typescript
POST /api/exam/qbank/import
Content-Type: multipart/form-data

Request:
{
  file: File;                    // CSV, Excel, JSON, QTI, GIFT
  format: ImportFormat;
  options: {
    skipDuplicates: boolean;
    updateExisting: boolean;
    validateOnly: boolean;      // Dry run
    mappings?: {                // Column mappings
      question: string;
      answer: string;
      marks: string;
    }
  }
}

Response:
{
  success: true;
  data: {
    total: number;
    imported: number;
    skipped: number;
    failed: number;
    errors?: [
      {
        row: number;
        field: string;
        error: string;
        value: any;
      }
    ];
    questions?: Question[];      // If validateOnly = false
  }
}
```

### Get Question Analytics

Retrieves performance metrics for question.

```typescript
GET /api/exam/qbank/{questionId}/analytics

Response:
{
  success: true;
  data: {
    questionId: string;
    usageCount: number;
    totalAttempts: number;
    correctAttempts: number;
    averageScore: number;
    averageTime: number;         // Seconds
    discriminationIndex: number; // -1 to 1
    difficultyIndex: number;     // 0 to 1
    lastUsed: string;
    performanceByClass: [
      {
        classId: string;
        className: string;
        averageScore: number;
      }
    ];
    commonWrongAnswers?: [       // For MCQ
      {
        option: string;
        count: number;
        percentage: number;
      }
    ]
  }
}
```

---

## Auto-Generation APIs

### Create Exam Template

Creates reusable exam template.

```typescript
POST /api/exam/generate/template

Request:
{
  name: string;
  description?: string;
  subject: string;
  totalMarks: number;
  duration: number;              // Minutes
  questionDistribution: [
    {
      type: QuestionType;
      count: number;
      marks: number;
      difficulty: {
        easy: number;           // Percentage
        medium: number;
        hard: number;
        expert: number;
      }
    }
  ];
  bloomsDistribution: {
    remember: number;           // Percentage
    understand: number;
    apply: number;
    analyze: number;
    evaluate: number;
    create: number;
  };
  rules?: {
    avoidRecentlyUsed: boolean;
    maxUsageCount?: number;
    mustIncludeTags?: string[];
    excludeTags?: string[];
  }
}

Response:
{
  success: true;
  data: {
    templateId: string;
    questionsAvailable: number;  // Matching questions in bank
    canGenerate: boolean;
  }
}
```

### Generate Exam from Template

Auto-generates exam using template.

```typescript
POST /api/exam/generate/from-template

Request:
{
  templateId: string;
  examTitle: string;
  classId: string;
  options?: {
    seed?: number;              // For reproducible generation
    preview: boolean;           // Don't save, just preview
    manualReview: boolean;      // Require approval
  }
}

Response:
{
  success: true;
  data: {
    examId?: string;            // If not preview
    questions: Question[];
    statistics: {
      totalMarks: number;
      questionCount: number;
      difficultyBreakdown: Record<string, number>;
      bloomsBreakdown: Record<string, number>;
      topicCoverage: Record<string, number>;
    };
    warnings?: string[];        // Insufficient questions, etc.
  }
}
```

### AI Generate Questions

Generate questions using AI.

```typescript
POST /api/exam/generate/ai-questions

Request:
{
  topic: string;
  count: number;
  type?: QuestionType;
  difficulty?: Difficulty;
  learningObjectives?: string[];
  context?: string;             // Additional context
  style?: {
    complexity: "SIMPLE" | "MODERATE" | "COMPLEX";
    language: "FORMAL" | "CONVERSATIONAL";
    examples: boolean;
  }
}

Response:
{
  success: true;
  data: {
    questions: Question[];
    generationId: string;       // For tracking
    model: string;              // AI model used
    confidence: number;         // 0-1
  }
}
```

---

## Marking APIs

### Start Marking Session

Initiates marking for an exam.

```typescript
POST /api/exam/mark/start

Request:
{
  examId: string;
  mode: "AUTO" | "MANUAL" | "HYBRID";
  options?: {
    autoMarkObjective: boolean;
    useAI: boolean;
    aiModel?: string;
    rubricId?: string;
    batchSize?: number;
  }
}

Response:
{
  success: true;
  data: {
    sessionId: string;
    totalSubmissions: number;
    autoMarkable: number;
    requiresManual: number;
    estimatedTime: number;      // Seconds
  }
}
```

### Submit Marks

Records marks for a submission.

```typescript
POST /api/exam/mark/submit

Request:
{
  submissionId: string;
  marks: [
    {
      questionId: string;
      score: number;
      feedback?: string;
      rubricScores?: Record<string, number>;
    }
  ];
  overallFeedback?: string;
  gradedBy?: "AUTO" | "AI" | "MANUAL";
}

Response:
{
  success: true;
  data: {
    submissionId: string;
    totalScore: number;
    percentage: number;
    grade?: string;
    saved: boolean;
  }
}
```

### Bulk Auto-Mark

Automatically marks multiple submissions.

```typescript
POST /api/exam/mark/bulk-auto

Request:
{
  examId: string;
  questionTypes?: QuestionType[];  // Filter specific types
  options: {
    parallel: number;              // Concurrent processing
    continueOnError: boolean;
    notifyProgress: boolean;
  }
}

Response:
{
  success: true;
  data: {
    jobId: string;
    status: "QUEUED" | "PROCESSING" | "COMPLETED";
    progress: {
      total: number;
      processed: number;
      successful: number;
      failed: number;
    };
    estimatedCompletion?: string;
  }
}
```

### Get Marking Progress

Monitors marking session progress.

```typescript
GET /api/exam/mark/progress/{sessionId}

Response:
{
  success: true;
  data: {
    sessionId: string;
    status: "IN_PROGRESS" | "PAUSED" | "COMPLETED";
    statistics: {
      total: number;
      marked: number;
      pending: number;
      autoMarked: number;
      aiGraded: number;
      manuallyGraded: number;
    };
    timeElapsed: number;         // Seconds
    estimatedRemaining: number;  // Seconds
    currentItem?: {
      submissionId: string;
      studentName: string;
      progress: number;          // Percentage
    }
  }
}
```

---

## Results APIs

### Publish Results

Makes results available to students.

```typescript
POST /api/exam/results/publish

Request:
{
  examId: string;
  settings: {
    visibility: "IMMEDIATE" | "SCHEDULED" | "MANUAL";
    scheduledDate?: string;
    showAnswers: boolean;
    showDetailedScores: boolean;
    showRanking: boolean;
    showClassAverage: boolean;
    allowAppeals: boolean;
    appealDeadline?: string;
    parentAccess: boolean;
  };
  notifications: {
    sendEmail: boolean;
    sendSMS: boolean;
    customMessage?: string;
  }
}

Response:
{
  success: true;
  data: {
    examId: string;
    publishedAt: string;
    studentsNotified: number;
    parentsNotified?: number;
    publicUrl?: string;          // Shareable results URL
  }
}
```

### Generate PDF Report

Creates PDF report for student.

```typescript
POST /api/exam/results/pdf

Request:
{
  studentId: string;
  examId: string;
  template: "classic" | "modern" | "minimal";
  options?: {
    includeAnswerKey: boolean;
    includeRanking: boolean;
    includeClassStats: boolean;
    includeRemarks: boolean;
    language: "en" | "ar";
    watermark?: string;
    signatureFields?: string[];
  }
}

Response:
{
  success: true;
  data: {
    pdfUrl: string;              // Temporary signed URL
    fileSize: number;            // Bytes
    pages: number;
    expiresAt: string;           // URL expiry
  }
}
```

### Batch Generate PDFs

Generates multiple PDFs as ZIP.

```typescript
POST /api/exam/results/pdf/batch

Request:
{
  examId: string;
  studentIds?: string[];         // All if not specified
  template: string;
  compression: boolean;
  options: {
    // Same as single PDF options
  }
}

Response:
{
  success: true;
  data: {
    jobId: string;
    status: "QUEUED" | "PROCESSING" | "COMPLETED";
    zipUrl?: string;             // When completed
    fileCount?: number;
    totalSize?: number;          // Bytes
  }
}
```

### Get Analytics

Retrieves comprehensive exam analytics.

```typescript
GET /api/exam/results/analytics/{examId}

Response:
{
  success: true;
  data: {
    examId: string;
    summary: {
      totalStudents: number;
      appeared: number;
      passed: number;
      failed: number;
      averageScore: number;
      highestScore: number;
      lowestScore: number;
      standardDeviation: number;
      passPercentage: number;
    };
    gradeDistribution: Record<string, number>;
    scoreDistribution: {
      ranges: string[];          // ["0-10", "11-20", ...]
      counts: number[];
    };
    questionAnalysis: [
      {
        questionId: string;
        questionText: string;
        correctAttempts: number;
        wrongAttempts: number;
        skipped: number;
        averageScore: number;
        difficulty: number;      // 0-1
        discrimination: number;  // -1 to 1
      }
    ];
    topPerformers: Student[];
    needsAttention: Student[];   // Low performers
    comparisonData?: {
      previousExam?: ExamComparison;
      classAverage?: number;
      schoolAverage?: number;
    }
  }
}
```

### Export Results

Exports results in various formats.

```typescript
POST /api/exam/results/export

Request:
{
  examId: string;
  format: "CSV" | "EXCEL" | "JSON" | "XML";
  includeFields: string[];       // Selective export
  filters?: {
    minScore?: number;
    maxScore?: number;
    grade?: string[];
    class?: string[];
  };
  groupBy?: "class" | "grade" | "none";
  sortBy?: "score" | "name" | "rollNumber";
  sortOrder?: "asc" | "desc";
}

Response:
{
  success: true;
  data: {
    downloadUrl: string;         // Temporary signed URL
    fileSize: number;
    recordCount: number;
    expiresAt: string;
  }
}
```

---

## Error Responses

All APIs return consistent error structure:

```typescript
{
  success: false;
  error: string;                 // Human-readable message
  code: string;                  // Machine-readable code
  details?: {                   // Optional additional info
    field?: string;              // Field that caused error
    value?: any;                 // Invalid value
    suggestion?: string;         // How to fix
    documentation?: string;      // Link to docs
  };
  timestamp: string;
  requestId: string;             // For support
}
```

### Common Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `UNAUTHORIZED` | 401 | No valid session |
| `FORBIDDEN` | 403 | Lacks permission |
| `NOT_FOUND` | 404 | Resource not found |
| `VALIDATION_ERROR` | 400 | Invalid input |
| `CONFLICT` | 409 | Resource conflict |
| `RATE_LIMIT` | 429 | Too many requests |
| `SERVER_ERROR` | 500 | Internal error |
| `TIMEOUT` | 504 | Operation timeout |

---

## Rate Limiting

API rate limits per endpoint:

| Endpoint Type | Limit | Window |
|---------------|-------|---------|
| Read (GET) | 100 | 1 minute |
| Write (POST/PUT) | 20 | 1 minute |
| Delete | 10 | 1 minute |
| Bulk Operations | 5 | 5 minutes |
| File Uploads | 10 | 10 minutes |
| AI Generation | 5 | 5 minutes |

Rate limit headers:
```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1640995200
```

---

## Webhooks

Configure webhooks for exam events:

```typescript
POST /api/webhooks/configure

Request:
{
  url: string;
  events: [
    "exam.created",
    "exam.published",
    "exam.started",
    "exam.ended",
    "results.published"
  ];
  secret: string;                // For signature verification
  active: boolean;
}
```

Webhook payload:
```typescript
{
  event: string;
  timestamp: string;
  data: {
    examId: string;
    schoolId: string;
    // Event-specific data
  };
  signature: string;             // HMAC-SHA256
}
```

---

## Related Documentation

- [Managing Exams](/docs/exam/manage-exams)
- [Question Bank](/docs/exam/question-bank)
- [Auto-Marking](/docs/exam/auto-marking)
- [Results & Analytics](/docs/exam/results-analytics)
- [Troubleshooting](/docs/exam/troubleshooting)