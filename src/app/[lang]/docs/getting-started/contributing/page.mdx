import { Alert, AlertDescription } from "@/components/ui/alert"
import { CheckCircle, GitBranch, GitPullRequest, AlertCircle, Code, TestTube, Shield } from "lucide-react"
import Link from "next/link"

# Contributing Guide

Learn how to submit your first pull request to Hogwarts. We welcome contributions of all sizes - from fixing typos to implementing major features.

## Before You Start

<Alert className="mb-6">
  <CheckCircle className="h-4 w-4" />
  <AlertDescription>
    Make sure you have completed the <Link href="/docs/getting-started/local-setup" className="font-semibold">Local Development Setup</Link> and have Hogwarts running on your machine.
  </AlertDescription>
</Alert>

## Finding Issues to Work On

### Good First Issues

Perfect for newcomers to the project:

<div className="mt-4 p-4 bg-muted rounded-lg">
  <div className="space-y-2">
    <a href="https://github.com/databayt/hogwarts/issues?q=is%3Aopen+is%3Aissue+label%3A%22good+first+issue%22" target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-primary hover:underline">
      <GitPullRequest className="h-4 w-4" />
      Browse "good first issue" label on GitHub →
    </a>
  </div>
</div>

### Issue Labels

- **`good first issue`** - Great for beginners
- **`help wanted`** - We need help with these
- **`bug`** - Something isn't working
- **`enhancement`** - New feature or request
- **`documentation`** - Documentation improvements
- **`performance`** - Performance optimizations

### Creating New Issues

If you find a bug or have a feature idea:

1. **Search existing issues** to avoid duplicates
2. **Create a new issue** with clear description
3. **Wait for approval** before starting major features

## Contribution Workflow

### Step 1: Fork & Clone

```bash
# 1. Fork the repository on GitHub (click "Fork" button)

# 2. Clone your fork
git clone https://github.com/YOUR_USERNAME/hogwarts.git
cd hogwarts

# 3. Add upstream remote
git remote add upstream https://github.com/databayt/hogwarts.git

# 4. Verify remotes
git remote -v
# You should see:
# origin    https://github.com/YOUR_USERNAME/hogwarts.git (fetch)
# origin    https://github.com/YOUR_USERNAME/hogwarts.git (push)
# upstream  https://github.com/databayt/hogwarts.git (fetch)
# upstream  https://github.com/databayt/hogwarts.git (push)
```

### Step 2: Create a Feature Branch

<Alert className="my-4">
  <GitBranch className="h-4 w-4" />
  <AlertDescription>
    **Always create a new branch for your changes.** Never commit directly to `main`.
  </AlertDescription>
</Alert>

```bash
# Update your main branch
git checkout main
git pull upstream main

# Create and checkout a new branch
git checkout -b feature/your-feature-name
# Or for bug fixes:
git checkout -b fix/issue-description
# Or for docs:
git checkout -b docs/what-you-are-documenting
```

### Branch Naming Conventions

- **`feature/`** - New features (e.g., `feature/add-exam-analytics`)
- **`fix/`** - Bug fixes (e.g., `fix/attendance-calculation`)
- **`docs/`** - Documentation (e.g., `docs/api-endpoints`)
- **`refactor/`** - Code refactoring (e.g., `refactor/student-components`)
- **`test/`** - Test additions (e.g., `test/finance-module`)
- **`chore/`** - Maintenance tasks (e.g., `chore/update-dependencies`)

### Step 3: Make Your Changes

Follow these coding standards:

<div className="grid gap-4 mt-6">
  <div className="p-4 border rounded-lg">
    <h4 className="flex items-center gap-2 mb-2">
      <Shield className="h-5 w-5 text-blue-600" />
      Multi-Tenant Safety (CRITICAL)
    </h4>
    <p className="text-sm text-muted-foreground mb-3">Every database query MUST include schoolId for tenant isolation:</p>
    <pre className="bg-muted p-3 rounded text-sm">
      <code>{`// ✅ CORRECT
await db.student.findMany({
  where: { schoolId, grade: "10" }
})

// ❌ WRONG - Missing schoolId
await db.student.findMany({
  where: { grade: "10" }
})`}</code>
    </pre>
  </div>

  <div className="p-4 border rounded-lg">
    <h4 className="flex items-center gap-2 mb-2">
      <Code className="h-5 w-5 text-green-600" />
      Typography System
    </h4>
    <p className="text-sm text-muted-foreground mb-3">Use semantic HTML, never hardcode text styles:</p>
    <pre className="bg-muted p-3 rounded text-sm">
      <code>{`// ✅ CORRECT
<h2>Page Title</h2>
<p>Body text content</p>

// ❌ WRONG
<div className="text-2xl font-bold">Page Title</div>
<div className="text-base">Body text content</div>`}</code>
    </pre>
  </div>

  <div className="p-4 border rounded-lg">
    <h4 className="flex items-center gap-2 mb-2">
      <TestTube className="h-5 w-5 text-purple-600" />
      Testing Requirements
    </h4>
    <p className="text-sm text-muted-foreground mb-3">Write tests for new features and maintain 95% coverage:</p>
    <pre className="bg-muted p-3 rounded text-sm">
      <code>{`// Run tests
pnpm test

// Run specific test file
pnpm test src/components/students/form.test.tsx

// Run tests in watch mode
pnpm test -- --watch`}</code>
    </pre>
  </div>
</div>

### Step 4: Validate Your Changes

Before committing, ensure your code passes all checks:

```bash
# 1. Check TypeScript (MUST pass with 0 errors)
pnpm tsc --noEmit

# 2. Run linting
pnpm lint

# 3. Run tests
pnpm test

# 4. Build the project (catches build-time errors)
pnpm build
```

<Alert className="mt-4">
  <AlertCircle className="h-4 w-4" />
  <AlertDescription>
    **Important:** The build will hang if there are TypeScript errors. Always run `pnpm tsc --noEmit` first.
  </AlertDescription>
</Alert>

### Step 5: Commit Your Changes

We follow [Conventional Commits](https://www.conventionalcommits.org/):

```bash
# Stage your changes
git add .

# Commit with a descriptive message
git commit -m "feat: add student attendance report"
# Or for fixes:
git commit -m "fix: correct attendance calculation for partial days"
# Or for docs:
git commit -m "docs: add API documentation for attendance endpoints"
```

#### Commit Message Format

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types:**
- `feat` - New feature
- `fix` - Bug fix
- `docs` - Documentation changes
- `style` - Code style changes (formatting)
- `refactor` - Code refactoring
- `test` - Test additions/changes
- `chore` - Maintenance tasks

**Examples:**
```bash
# Feature
git commit -m "feat(attendance): add bulk attendance marking"

# Bug fix
git commit -m "fix(auth): resolve OAuth redirect loop"

# Documentation
git commit -m "docs(api): document student endpoints"

# With description
git commit -m "feat(exams): implement auto-grading system

- Add multiple choice grading algorithm
- Support partial credit scoring
- Generate grade reports automatically"
```

### Step 6: Push to Your Fork

```bash
# Push your branch to your fork
git push origin feature/your-feature-name
```

### Step 7: Create a Pull Request

1. Go to your fork on GitHub
2. Click "Compare & pull request"
3. Fill out the PR template:

```markdown
## Description
Brief description of what this PR does.

## Type of Change
- [ ] Bug fix (non-breaking change which fixes an issue)
- [ ] New feature (non-breaking change which adds functionality)
- [ ] Breaking change (fix or feature that would cause existing functionality to not work as expected)
- [ ] Documentation update

## Testing
- [ ] I have tested my changes locally
- [ ] All tests pass (`pnpm test`)
- [ ] TypeScript checks pass (`pnpm tsc --noEmit`)
- [ ] Build succeeds (`pnpm build`)

## Checklist
- [ ] My code follows the project's style guidelines
- [ ] I have performed a self-review of my code
- [ ] I have commented my code where necessary
- [ ] I have updated the documentation if needed
- [ ] My changes generate no new warnings
- [ ] All database queries include `schoolId` for multi-tenant safety
- [ ] I have used semantic HTML (no hardcoded text styles)

## Screenshots (if applicable)
Add screenshots to help reviewers understand your changes.

## Related Issues
Closes #[issue number]
```

### Step 8: Code Review Process

After submitting your PR:

1. **Automated checks run** - CI/CD validates your code
2. **Maintainer review** - We'll review within 48 hours
3. **Address feedback** - Make requested changes
4. **Merge** - Once approved, we'll merge your PR

### Addressing Review Feedback

```bash
# Make requested changes on your branch
git add .
git commit -m "fix: address review feedback"
git push origin feature/your-feature-name

# The PR updates automatically
```

## Code Quality Standards

### Required Patterns

<div className="space-y-4 mt-6">
  <div className="p-4 bg-muted rounded-lg">
    <h4>Server Actions</h4>
    <pre className="mt-2 text-sm">
      <code>{`"use server"

import { auth } from "@/auth"
import { db } from "@/lib/db"
import { revalidatePath } from "next/cache"

export async function createItem(data: FormData) {
  // 1. Authenticate
  const session = await auth()
  const schoolId = session?.user?.schoolId
  if (!schoolId) throw new Error("Unauthorized")

  // 2. Validate
  const validated = schema.parse(Object.fromEntries(data))

  // 3. Execute with schoolId
  const item = await db.item.create({
    data: { ...validated, schoolId }
  })

  // 4. Revalidate
  revalidatePath("/items")
  return { success: true, item }
}`}</code>
    </pre>
  </div>

  <div className="p-4 bg-muted rounded-lg">
    <h4>Component Structure</h4>
    <pre className="mt-2 text-sm">
      <code>{`// Follow the mirror pattern
src/
  app/[lang]/s/[subdomain]/(platform)/students/
    page.tsx              # Route page

  components/students/
    content.tsx           # Main UI (server component)
    actions.ts            # Server actions
    validation.ts         # Zod schemas
    form.tsx             # Form component (client)
    table.tsx            # Data table (client)`}</code>
    </pre>
  </div>
</div>

## Testing Guidelines

### Writing Tests

```typescript
// src/components/students/form.test.tsx
import { render, screen } from "@testing-library/react"
import { StudentForm } from "./form"

describe("StudentForm", () => {
  it("validates required fields", async () => {
    render(<StudentForm />)

    const submitButton = screen.getByRole("button", { name: /submit/i })
    await userEvent.click(submitButton)

    expect(screen.getByText(/name is required/i)).toBeInTheDocument()
  })

  it("includes schoolId in submission", async () => {
    // Test multi-tenant safety
  })
})
```

### Coverage Requirements

- **95% minimum** for new code
- Run coverage report: `pnpm test -- --coverage`

## Common Pitfalls to Avoid

<div className="space-y-4 mt-6">
  <Alert>
    <AlertCircle className="h-4 w-4" />
    <AlertDescription>
      **Missing schoolId** - Always include in database queries
    </AlertDescription>
  </Alert>

  <Alert>
    <AlertCircle className="h-4 w-4" />
    <AlertDescription>
      **Hardcoded text styles** - Use semantic HTML elements
    </AlertDescription>
  </Alert>

  <Alert>
    <AlertCircle className="h-4 w-4" />
    <AlertDescription>
      **Skipping TypeScript checks** - Always run `pnpm tsc --noEmit`
    </AlertDescription>
  </Alert>

  <Alert>
    <AlertCircle className="h-4 w-4" />
    <AlertDescription>
      **Not testing locally** - Test all changes before pushing
    </AlertDescription>
  </Alert>

  <Alert>
    <AlertCircle className="h-4 w-4" />
    <AlertDescription>
      **Large PRs** - Keep PRs focused and small (< 400 lines)
    </AlertDescription>
  </Alert>
</div>

## Getting Help

If you need help:

1. **Check documentation** - <Link href="/docs">Browse our docs</Link>
2. **Search issues** - Someone may have had the same question
3. **Ask on GitHub** - Create a discussion or comment on an issue
4. **Discord** - Join our community (link in README)

## Recognition

We value all contributions:

- **Contributors** are listed in our README
- **Significant contributions** earn co-author credit
- **Regular contributors** may be invited as maintainers

## Ready to Contribute?

<div className="mt-8 p-6 bg-muted rounded-lg">
  <h3 className="mb-4">Quick Checklist</h3>
  <div className="space-y-2">
    <label className="flex items-center gap-2">
      <input type="checkbox" className="rounded" />
      <span>Forked and cloned the repository</span>
    </label>
    <label className="flex items-center gap-2">
      <input type="checkbox" className="rounded" />
      <span>Local development environment working</span>
    </label>
    <label className="flex items-center gap-2">
      <input type="checkbox" className="rounded" />
      <span>Found an issue to work on</span>
    </label>
    <label className="flex items-center gap-2">
      <input type="checkbox" className="rounded" />
      <span>Read the code standards</span>
    </label>
  </div>
</div>

<div className="mt-8 flex gap-4">
  <a href="https://github.com/databayt/hogwarts/issues?q=is%3Aopen+is%3Aissue+label%3A%22good+first+issue%22" target="_blank" rel="noopener noreferrer">
    <button className="px-6 py-3 bg-primary text-primary-foreground rounded-md hover:opacity-90 transition-opacity">
      Find Your First Issue →
    </button>
  </a>

  <Link href="/docs/architecture">
    <button className="px-6 py-3 border border-primary text-primary rounded-md hover:bg-primary hover:text-primary-foreground transition-colors">
      Learn Architecture
    </button>
  </Link>
</div>