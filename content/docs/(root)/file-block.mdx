# File Block

Centralized file operations for upload, download, export, import, print, and document generation.

## Overview

The **File Block** consolidates all file-related functionality into a single, cohesive module at `@/components/platform/file`. It provides:

- **Upload** - Cloud-based file uploads with progress tracking
- **Browser** - File manager with grid/list views
- **Export** - PDF, Excel, CSV generation
- **Import** - CSV/Excel parsing with validation
- **Print** - Browser printing and print-to-PDF
- **Generate** - Document templates (invoices, certificates, report cards)

## Quick Start

```tsx
import {
  FileUploader,
  ExportButton,
  FileImporter,
  PrintButton,
  FileBrowser,
  useUpload,
  useExport,
  useGenerate,
} from "@/components/platform/file"

// Upload files
<FileUploader
  folder="documents"
  category="document"
  onUpload={(urls) => console.log(urls)}
/>

// Export data
<ExportButton
  data={students}
  columns={STUDENT_EXPORT_COLUMNS}
  filename="students"
  formats={["csv", "excel", "pdf"]}
/>

// Import data
<FileImporter
  columns={STUDENT_IMPORT_COLUMNS}
  onImport={handleImport}
/>

// Print content
<PrintButton contentRef={printRef}>
  Print Report
</PrintButton>

// Browse files
<FileBrowser
  rootFolder="/school/documents"
  onSelect={handleSelect}
/>
```

## Upload Module

### FileUploader Component

The main upload component with drag-and-drop support:

```tsx
import { FileUploader } from "@/components/platform/file"

<FileUploader
  folder="avatars"
  category="image"
  accept={{ "image/*": [".jpg", ".png", ".webp"] }}
  maxSize={5 * 1024 * 1024} // 5MB
  maxFiles={1}
  onUpload={(urls) => setAvatarUrl(urls[0])}
  onError={(error) => toast.error(error)}
/>
```

### Preset Components

Ready-to-use upload configurations:

```tsx
import {
  AvatarUpload,
  LogoUpload,
  DocumentUpload,
  AssignmentUpload,
} from "@/components/platform/file"

// Profile avatar (circular, 2MB max)
<AvatarUpload
  currentUrl={user.avatarUrl}
  onUpload={(url) => updateAvatar(url)}
/>

// School logo (square, 5MB max)
<LogoUpload
  currentUrl={school.logoUrl}
  onUpload={(url) => updateLogo(url)}
/>

// General documents (10MB max, multiple files)
<DocumentUpload
  folder="contracts"
  onUpload={(urls) => addDocuments(urls)}
/>

// Student assignments (20MB max)
<AssignmentUpload
  studentId={student.id}
  assignmentId={assignment.id}
  onUpload={(urls) => submitAssignment(urls)}
/>
```

### useUpload Hook

For custom upload implementations:

```tsx
import { useUpload } from "@/components/platform/file"

function CustomUploader() {
  const {
    files,
    isUploading,
    progress,
    error,
    addFiles,
    removeFile,
    upload,
    clear,
  } = useUpload({
    folder: "documents",
    category: "document",
    maxSize: 10 * 1024 * 1024,
    maxFiles: 5,
  })

  return (
    <div>
      <input
        type="file"
        multiple
        onChange={(e) => addFiles(Array.from(e.target.files || []))}
      />
      {files.map((file) => (
        <div key={file.id}>
          {file.name} - {file.progress}%
          <button onClick={() => removeFile(file.id)}>Remove</button>
        </div>
      ))}
      <button onClick={upload} disabled={isUploading}>
        Upload All
      </button>
    </div>
  )
}
```

### Server Actions

Direct server action usage:

```tsx
import { uploadFile, uploadFiles, deleteFile, getFiles } from "@/components/platform/file"

// Upload single file
const result = await uploadFile(formData, {
  folder: "documents",
  category: "document",
})

// Upload multiple files
const results = await uploadFiles(formDataArray, {
  folder: "images",
  category: "image",
})

// Delete file
await deleteFile(fileId)

// Query files
const { files, total } = await getFiles({
  folder: "documents",
  category: "document",
  limit: 20,
  offset: 0,
})
```

## Export Module

### ExportButton Component

Multi-format export with column selection:

```tsx
import { ExportButton, type ExportColumn } from "@/components/platform/file"

const columns: ExportColumn<Student>[] = [
  { key: "name", header: "Name", headerAr: "الاسم" },
  { key: "email", header: "Email", headerAr: "البريد الإلكتروني" },
  { key: "grade", header: "Grade", headerAr: "الصف" },
  {
    key: "enrollmentDate",
    header: "Enrollment Date",
    headerAr: "تاريخ التسجيل",
    format: "date",
  },
  {
    key: "tuitionPaid",
    header: "Tuition Paid",
    headerAr: "الرسوم المدفوعة",
    format: "currency",
    currencyCode: "SAR",
  },
]

<ExportButton
  data={students}
  columns={columns}
  filename="students-export"
  formats={["csv", "excel", "pdf"]}
  title="Student Report"
  schoolId={schoolId}
  locale={lang}
/>
```

### SimpleExportButton

Single-format export without column selection:

```tsx
import { SimpleExportButton } from "@/components/platform/file"

<SimpleExportButton
  data={attendance}
  columns={ATTENDANCE_COLUMNS}
  filename="attendance-report"
  format="excel"
/>
```

### useExport Hook

For programmatic exports:

```tsx
import { useExport } from "@/components/platform/file"

function ReportPage() {
  const { exportData, isExporting, error } = useExport()

  const handleExport = async (format: "csv" | "excel" | "pdf") => {
    await exportData({
      data: reportData,
      columns: REPORT_COLUMNS,
      filename: `report-${Date.now()}`,
      format,
      title: "Monthly Report",
    })
  }

  return (
    <div>
      <button onClick={() => handleExport("pdf")} disabled={isExporting}>
        Export PDF
      </button>
      <button onClick={() => handleExport("excel")} disabled={isExporting}>
        Export Excel
      </button>
    </div>
  )
}
```

### Column Formatters

Built-in formatters for common data types:

```tsx
import { createColumnHelpers } from "@/components/platform/file"

const { dateColumn, currencyColumn, numberColumn, booleanColumn } =
  createColumnHelpers<Invoice>()

const columns = [
  { key: "invoiceNumber", header: "Invoice #", headerAr: "رقم الفاتورة" },
  dateColumn("issueDate", "Issue Date", "تاريخ الإصدار"),
  dateColumn("dueDate", "Due Date", "تاريخ الاستحقاق"),
  currencyColumn("amount", "Amount", "المبلغ", "SAR"),
  currencyColumn("paid", "Paid", "المدفوع", "SAR"),
  booleanColumn("isPaid", "Status", "الحالة", "Paid", "Pending"),
]
```

## Import Module

### FileImporter Component

Multi-step import wizard:

```tsx
import { FileImporter, type ImportColumn } from "@/components/platform/file"

const columns: ImportColumn<Student>[] = [
  {
    key: "name",
    header: "Name",
    headerAr: "الاسم",
    required: true,
    aliases: ["student_name", "full_name", "الاسم الكامل"],
  },
  {
    key: "email",
    header: "Email",
    headerAr: "البريد الإلكتروني",
    required: true,
    validate: (value) => {
      const email = String(value)
      if (!email.includes("@")) return "Invalid email format"
      return true
    },
  },
  {
    key: "dateOfBirth",
    header: "Date of Birth",
    headerAr: "تاريخ الميلاد",
    type: "date",
    transform: (value) => new Date(value),
  },
  {
    key: "grade",
    header: "Grade",
    headerAr: "الصف",
    type: "number",
    validate: (value) => {
      const grade = Number(value)
      if (grade < 1 || grade > 12) return "Grade must be between 1-12"
      return true
    },
  },
]

<FileImporter
  columns={columns}
  onImport={async (data) => {
    const result = await createStudents(data)
    return {
      success: result.created,
      failed: result.errors.length,
      errors: result.errors,
    }
  }}
  onComplete={() => {
    toast.success("Import completed!")
    router.refresh()
  }}
  dictionary={dictionary}
/>
```

### useImport Hook

For custom import flows:

```tsx
import { useImport } from "@/components/platform/file"

function CustomImporter() {
  const {
    step,
    preview,
    validRows,
    invalidRows,
    columnMapping,
    parseFile,
    setColumnMapping,
    validateData,
    importData,
    reset,
  } = useImport({ columns: STUDENT_COLUMNS })

  const handleFileSelect = async (file: File) => {
    await parseFile(file)
  }

  const handleImport = async () => {
    const result = await importData(async (data) => {
      return await createStudents(data)
    })
    console.log(`Imported ${result.success} records`)
  }

  return (
    // Custom UI implementation
  )
}
```

### Validation Helpers

Common validators for import columns:

```tsx
import { commonValidators, commonSchemas } from "@/components/platform/file"

const columns: ImportColumn<Student>[] = [
  {
    key: "email",
    header: "Email",
    validate: commonValidators.email,
  },
  {
    key: "phone",
    header: "Phone",
    validate: commonValidators.phone,
  },
  {
    key: "nationalId",
    header: "National ID",
    validate: commonValidators.pattern(/^\d{10}$/, "Must be 10 digits"),
  },
]

// Or use Zod schemas
const studentSchema = commonSchemas.object({
  email: commonSchemas.email(),
  phone: commonSchemas.phone(),
  grade: commonSchemas.number().min(1).max(12),
})
```

## Print Module

### PrintButton Component

Simple print trigger:

```tsx
import { PrintButton, PrintArea, NoPrint, PageBreak } from "@/components/platform/file"

function ReportPage() {
  const printRef = useRef<HTMLDivElement>(null)

  return (
    <div>
      <NoPrint>
        <PrintButton contentRef={printRef}>
          Print Report
        </PrintButton>
      </NoPrint>

      <PrintArea ref={printRef}>
        <h1>Student Report</h1>
        <table>...</table>

        <PageBreak />

        <h2>Attendance Summary</h2>
        <table>...</table>
      </PrintArea>
    </div>
  )
}
```

### usePrint Hook

For programmatic printing:

```tsx
import { usePrint } from "@/components/platform/file"

function InvoicePage({ invoice }) {
  const { print, printById, printHtml, isPrinting } = usePrint()

  const handlePrint = () => {
    printById("invoice-content", {
      title: `Invoice ${invoice.number}`,
      styles: `
        @page { margin: 1cm; }
        body { font-family: 'Tajawal', sans-serif; }
      `,
    })
  }

  return (
    <div>
      <button onClick={handlePrint} disabled={isPrinting}>
        Print Invoice
      </button>
      <div id="invoice-content">
        {/* Invoice content */}
      </div>
    </div>
  )
}
```

## Generate Module

### Document Templates

Generate professional PDF documents:

```tsx
import { useGenerate } from "@/components/platform/file"

function InvoicePage({ invoice }) {
  const { generateInvoice, isGenerating } = useGenerate()

  const handleDownload = async () => {
    await generateInvoice({
      invoiceNumber: invoice.number,
      issueDate: invoice.createdAt,
      dueDate: invoice.dueDate,
      status: invoice.status,
      school: {
        name: school.name,
        nameAr: school.nameAr,
        address: school.address,
        phone: school.phone,
        email: school.email,
        logoUrl: school.logoUrl,
      },
      customer: {
        name: invoice.customer.name,
        email: invoice.customer.email,
        address: invoice.customer.address,
      },
      items: invoice.items.map((item) => ({
        description: item.description,
        descriptionAr: item.descriptionAr,
        quantity: item.quantity,
        unitPrice: item.unitPrice,
        total: item.total,
      })),
      subtotal: invoice.subtotal,
      tax: invoice.tax,
      discount: invoice.discount,
      total: invoice.total,
      notes: invoice.notes,
      currency: "SAR",
      locale: lang,
    })
  }

  return (
    <button onClick={handleDownload} disabled={isGenerating}>
      Download Invoice PDF
    </button>
  )
}
```

### Available Templates

| Template | Description | Use Case |
|----------|-------------|----------|
| `generateInvoice` | Professional invoice with line items | Fee collection, billing |
| `generateReceipt` | Payment receipt confirmation | Payment acknowledgment |
| `generateCertificate` | Award/completion certificate | Achievements, graduations |
| `generateReportCard` | Student grades report | Academic reporting |
| `generateIdCard` | Student/Staff ID card | Identification |
| `generateTranscript` | Academic transcript | Official records |

### Certificate Example

```tsx
const { generateCertificate } = useGenerate()

await generateCertificate({
  title: "Certificate of Achievement",
  titleAr: "شهادة تقدير",
  recipientName: student.name,
  recipientNameAr: student.nameAr,
  description: "For outstanding academic performance in Mathematics",
  descriptionAr: "للتميز الأكاديمي في مادة الرياضيات",
  issueDate: new Date(),
  certificateNumber: `CERT-${Date.now()}`,
  school: {
    name: school.name,
    nameAr: school.nameAr,
    logoUrl: school.logoUrl,
  },
  signatures: [
    { name: "Dr. Ahmed Hassan", title: "Principal", titleAr: "مدير المدرسة" },
    { name: "Sarah Ali", title: "Department Head", titleAr: "رئيس القسم" },
  ],
  locale: lang,
})
```

### Report Card Example

```tsx
const { generateReportCard } = useGenerate()

await generateReportCard({
  student: {
    name: student.name,
    nameAr: student.nameAr,
    studentId: student.studentId,
    grade: student.grade,
    section: student.section,
    photoUrl: student.photoUrl,
  },
  academicYear: "2024-2025",
  term: "First Term",
  termAr: "الفصل الأول",
  grades: subjects.map((subject) => ({
    subject: subject.name,
    subjectAr: subject.nameAr,
    score: subject.score,
    maxScore: 100,
    grade: subject.letterGrade,
    remarks: subject.remarks,
  })),
  attendance: {
    present: 85,
    absent: 5,
    late: 3,
    excused: 2,
  },
  comments: teacherComments,
  school: {
    name: school.name,
    nameAr: school.nameAr,
    logoUrl: school.logoUrl,
  },
  signatures: [
    { name: teacher.name, title: "Class Teacher" },
    { name: principal.name, title: "Principal" },
  ],
  locale: lang,
})
```

## Browser Module

### FileBrowser Component

Full-featured file manager:

```tsx
import { FileBrowser } from "@/components/platform/file"

<FileBrowser
  rootFolder="/school/documents"
  initialFolder="/school/documents/contracts"
  config={{
    selectable: true,
    multiSelect: true,
    deletable: true,
    downloadable: true,
    navigable: true,
    pageSize: 24,
    defaultViewMode: "grid",
    defaultSort: { field: "date", direction: "desc" },
  }}
  onSelect={(files) => setSelectedFiles(files)}
  onNavigate={(path) => console.log("Navigated to:", path)}
  dictionary={dictionary}
/>
```

### useBrowser Hook

For custom file browser implementations:

```tsx
import { useBrowser } from "@/components/platform/file"

function CustomFileBrowser() {
  const {
    files,
    folders,
    breadcrumbs,
    state,
    actions,
    currentPage,
    totalPages,
    totalFiles,
    setPage,
  } = useBrowser({
    rootFolder: "/documents",
    pageSize: 20,
    defaultViewMode: "list",
  })

  return (
    <div>
      {/* Breadcrumbs */}
      <nav>
        {breadcrumbs.map((crumb) => (
          <button key={crumb.path} onClick={() => actions.navigateTo(crumb.path)}>
            {crumb.name}
          </button>
        ))}
      </nav>

      {/* View mode toggle */}
      <div>
        <button onClick={() => actions.setViewMode("grid")}>Grid</button>
        <button onClick={() => actions.setViewMode("list")}>List</button>
      </div>

      {/* Search */}
      <input
        type="search"
        value={state.searchQuery}
        onChange={(e) => actions.setSearch(e.target.value)}
        placeholder="Search files..."
      />

      {/* Folders */}
      {folders.map((folder) => (
        <div key={folder.path} onClick={() => actions.navigateTo(folder.path)}>
          {folder.name}
        </div>
      ))}

      {/* Files */}
      {files.map((file) => (
        <div
          key={file.id}
          onClick={() => actions.toggleSelection(file.id)}
          className={state.selectedIds.has(file.id) ? "selected" : ""}
        >
          {file.originalName}
        </div>
      ))}

      {/* Pagination */}
      <div>
        <button onClick={() => setPage(currentPage - 1)} disabled={currentPage === 1}>
          Previous
        </button>
        <span>
          {currentPage} / {totalPages}
        </span>
        <button onClick={() => setPage(currentPage + 1)} disabled={currentPage === totalPages}>
          Next
        </button>
      </div>

      {/* Actions */}
      {state.selectedIds.size > 0 && (
        <div>
          <button onClick={actions.downloadSelected}>Download</button>
          <button onClick={actions.deleteSelected}>Delete</button>
        </div>
      )}
    </div>
  )
}
```

## Configuration

### File Categories

```tsx
type FileCategory =
  | "image"      // Images (jpg, png, webp, gif)
  | "document"   // Documents (pdf, doc, docx, xls, xlsx)
  | "video"      // Videos (mp4, webm, mov)
  | "audio"      // Audio (mp3, wav, ogg)
  | "archive"    // Archives (zip, rar, 7z)
  | "other"      // Other file types
```

### Size Limits

Default size limits by category:

| Category | Limit |
|----------|-------|
| Image | 5 MB |
| Document | 10 MB |
| Video | 100 MB |
| Audio | 20 MB |
| Archive | 50 MB |
| Other | 10 MB |

Override limits:

```tsx
<FileUploader
  maxSize={50 * 1024 * 1024} // 50MB
  // ...
/>
```

### Storage Providers

The module supports multiple storage providers:

| Provider | Use Case |
|----------|----------|
| Vercel Blob | Default, production files |
| ImageKit | Image optimization, CDN |
| AWS S3 | Large files, archives |
| Cloudflare R2 | Cost-effective storage |

Provider selection is automatic based on file type and size.

## Multi-Tenant Safety

All file operations are scoped by `schoolId`:

```tsx
// Server action automatically includes schoolId
export async function uploadFile(formData: FormData, options: UploadOptions) {
  const session = await auth()
  const schoolId = session?.user?.schoolId

  if (!schoolId) throw new Error("Unauthorized")

  // Files are stored with schoolId scope
  const file = await db.fileRecord.create({
    data: {
      ...fileData,
      schoolId, // Required for tenant isolation
    },
  })
}

// Queries are always scoped
export async function getFiles(options: GetFilesOptions) {
  const session = await auth()
  const schoolId = session?.user?.schoolId

  return db.fileRecord.findMany({
    where: {
      schoolId, // Never returns other schools' files
      ...filters,
    },
  })
}
```

## Internationalization

All components support Arabic (RTL) and English (LTR):

```tsx
// Export with bilingual headers
const columns: ExportColumn<Student>[] = [
  { key: "name", header: "Name", headerAr: "الاسم" },
  { key: "grade", header: "Grade", headerAr: "الصف" },
]

// PDF documents render correctly in RTL
await generateInvoice({
  // ...
  locale: "ar", // Renders in Arabic with RTL layout
})

// Import supports Arabic column headers
const columns: ImportColumn<Student>[] = [
  {
    key: "name",
    header: "Name",
    aliases: ["الاسم", "الاسم الكامل", "student_name"],
  },
]
```

## Error Handling

```tsx
import { useUpload } from "@/components/platform/file"

function Uploader() {
  const { error, upload } = useUpload({
    onError: (error) => {
      // Handle specific error types
      if (error.code === "FILE_TOO_LARGE") {
        toast.error("File exceeds maximum size")
      } else if (error.code === "INVALID_TYPE") {
        toast.error("File type not allowed")
      } else if (error.code === "UPLOAD_FAILED") {
        toast.error("Upload failed. Please try again.")
      } else {
        toast.error(error.message)
      }
    },
  })

  return // ...
}
```

## TypeScript Support

Full TypeScript support with generics:

```tsx
import type {
  FileCategory,
  FileType,
  ExportColumn,
  ImportColumn,
  UploadOptions,
  ExportConfig,
  ImportConfig,
} from "@/components/platform/file"

// Typed export columns
const columns: ExportColumn<Student>[] = [
  { key: "name", header: "Name" }, // Type-safe: key must be keyof Student
]

// Typed import columns
const importColumns: ImportColumn<CreateStudentInput>[] = [
  { key: "email", header: "Email", required: true },
]
```

## Best Practices

### 1. Use Preset Components

For common use cases, prefer preset components:

```tsx
// Instead of configuring FileUploader
<AvatarUpload onUpload={setAvatar} />
<DocumentUpload folder="contracts" onUpload={addDocs} />
```

### 2. Define Column Configurations

Create reusable column configurations:

```tsx
// src/components/platform/students/columns/export.ts
export const STUDENT_EXPORT_COLUMNS: ExportColumn<Student>[] = [
  { key: "name", header: "Name", headerAr: "الاسم" },
  // ...
]

// Usage
<ExportButton data={students} columns={STUDENT_EXPORT_COLUMNS} />
```

### 3. Handle Large Files

For large file uploads, show progress:

```tsx
const { files, progress } = useUpload()

{files.map((file) => (
  <div key={file.id}>
    {file.name}
    <Progress value={file.progress} />
  </div>
))}
```

### 4. Validate Imports

Always validate imported data:

```tsx
const columns: ImportColumn<Student>[] = [
  {
    key: "email",
    required: true,
    validate: (value) => {
      if (!value) return "Email is required"
      if (!isValidEmail(value)) return "Invalid email format"
      return true
    },
  },
]
```

### 5. Use Proper Folder Structure

Organize files by type and context:

```
/school/{schoolId}/
  /avatars/          # User avatars
  /logos/            # School logos
  /documents/        # General documents
  /assignments/      # Student assignments
  /contracts/        # Legal documents
  /reports/          # Generated reports
```

## Migration Guide

Replace scattered file implementations with the unified module:

### Before

```tsx
// Scattered implementations
import { uploadAvatar } from "@/lib/upload-avatar"
import { exportToCsv } from "@/utils/csv-export"
import { generatePdf } from "@/services/pdf-generator"
```

### After

```tsx
// Unified imports
import {
  AvatarUpload,
  ExportButton,
  useGenerate,
} from "@/components/platform/file"
```

See the migration checklist in `/.claude/workflows/file-block-migration.md` for detailed steps.
