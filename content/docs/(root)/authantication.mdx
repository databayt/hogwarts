---
title: "Authentication"
description: "Multi-tenant authentication for school management with OAuth and Credentials"
---

## Overview

Our authentication system is built on Next.js App Router with Auth.js (NextAuth v5), specifically designed for multi-tenant school management. It supports OAuth providers (Google, Facebook), email/password credentials, two-factor authentication, and seamless cross-subdomain single sign-on.

## Multi-Tenant Architecture

The authentication system is designed from the ground up for multi-tenant school management:

```
┌─────────────────────────────────────────────────────────────────┐
│                    Authentication Flow                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Marketing Page (ed.databayt.org)                               │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────┐                                            │
│  │   Get Started   │ ◄── School Owner/Principal clicks          │
│  └────────┬────────┘                                            │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐     ┌─────────────────┐                    │
│  │   OAuth Login   │ or  │ Credentials     │                    │
│  │ (Google/FB)     │     │ (Email/Pass)    │                    │
│  └────────┬────────┘     └────────┬────────┘                    │
│           │                       │                             │
│           └───────────┬───────────┘                             │
│                       ▼                                         │
│              ┌─────────────────┐                                │
│              │ User Created    │                                │
│              └────────┬────────┘                                │
│                       │                                         │
│                       ▼                                         │
│              ┌─────────────────┐                                │
│              │   Onboarding    │                                │
│              │ (16 steps)      │                                │
│              └────────┬────────┘                                │
│                       │                                         │
│                       ▼                                         │
│              ┌─────────────────────────────────────┐            │
│              │   School Created & Linked          │            │
│              │   User becomes ADMIN               │            │
│              └────────┬───────────────────────────┘            │
│                       │                                         │
│                       ▼                                         │
│              ┌─────────────────────────────────────┐            │
│              │   Subdomain: school.databayt.org   │            │
│              └─────────────────────────────────────┘            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Core Features

### Authentication Methods

- **Multi-Provider Auth**: Google, Facebook, Email/Password
- **JWT-Based Sessions**: 24-hour expiry with automatic refresh
- **Cross-Subdomain SSO**: Seamless login across `*.databayt.org`
- **Email Verification**: Required for credentials, automatic for OAuth
- **Password Reset**: Secure token-based recovery
- **Two-Factor Authentication**: Optional 2FA for enhanced security

### Multi-Tenant Features

- **School Isolation**: Every user is associated with a `schoolId`
- **Compound Uniqueness**: Same email can exist across different schools
- **Subdomain Routing**: `school.databayt.org` automatically resolves to school context
- **Smart Redirects**: After login, users go directly to their school's dashboard
- **Role-Based Access**: 8 roles with clear hierarchy

### User Roles

```typescript
enum UserRole {
  DEVELOPER  // Platform admin (cross-school access)
  ADMIN      // School administrator
  TEACHER    // Teaching staff
  STUDENT    // Enrolled student
  GUARDIAN   // Parent/guardian
  ACCOUNTANT // Finance staff
  STAFF      // General staff
  USER       // Default role
}
```

## User Registration Options

Schools have **flexibility** in how they manage user accounts:

### Option 1: Self-Registration via OAuth (Recommended)

Students and teachers authenticate themselves:

```
Student → school.databayt.org/login → Google/Facebook → Profile Setup
```

**Benefits**:

- No admin work required
- Users verify their own email automatically
- Streamlined experience
- No password management overhead

### Option 2: Bulk Account Creation

School admin creates accounts in bulk:

```
Admin → Import CSV → Bulk creation with roles → Send credentials
```

**Benefits**:

- Full admin control over who joins
- Pre-assigned roles
- Works for users without email access

### Option 3: Invitation System (Coming Soon)

Admin invites specific users:

```
Admin → Generate invite link → User clicks → OAuth or Credentials → Linked to school
```

**Benefits**:

- Controlled onboarding
- Pre-assigned roles
- Combines admin control with user convenience

### Option 4: School Join Codes (Coming Soon)

Simple codes for easy joining:

```
Student → Enter code "HOGWARTS-2024" → Sign up → Auto-linked as STUDENT
```

**Benefits**:

- Easy to share (print, announce, etc.)
- No individual invitations needed
- Admin sets default role

## Architecture

### Core Files

| File                               | Purpose                                                   |
| ---------------------------------- | --------------------------------------------------------- |
| `src/auth.ts`                      | NextAuth configuration, JWT callbacks, session management |
| `src/auth.config.ts`               | OAuth provider configurations with profile logging        |
| `src/middleware.ts`                | Route protection, subdomain detection                     |
| `src/routes.ts`                    | Public/protected route definitions                        |
| `src/lib/tenant-context.ts`        | School context retrieval                                  |
| `src/lib/school-access.ts`         | School ownership and access control                       |
| `src/lib/auth-logger.ts`           | Centralized auth logging utility                          |
| `src/lib/auth-config-validator.ts` | Environment configuration validation                      |
| `src/app/api/debug-auth/route.ts`  | Debug endpoint for checking auth state                    |

### Component Structure

```
src/components/auth/
├── login/          # Login form and action
├── join/           # Registration form and action
├── reset/          # Password reset request
├── password/       # Password change
├── verification/   # Email verification, 2FA
├── setting/        # User settings
├── user.ts         # User database queries
├── social.tsx      # OAuth buttons
├── role-gate.tsx   # Role-based access control
└── validation.ts   # Zod schemas
```

## Session Management

### Extended Session

```typescript
session.user = {
  id: string;
  email: string;
  role: UserRole;
  schoolId: string | null;  // Multi-tenant key
  isPlatformAdmin: boolean;
}
```

### Tenant Context

```typescript
import { getTenantContext } from "@/lib/tenant-context"

const { schoolId, role, isPlatformAdmin } = await getTenantContext()
// Priority: impersonation cookie → subdomain → session
```

## Usage

### Server-Side Protection

```typescript
import { auth } from "@/auth";

export default async function ProtectedPage() {
  const session = await auth();

  if (!session) {
    redirect("/login");
  }

  return <Dashboard schoolId={session.user.schoolId} />;
}
```

### Client-Side Hooks

```typescript
"use client";
import { useCurrentUser } from "@/components/auth/use-current-user";
import { useCurrentRole } from "@/components/auth/use-current-role";

export function UserProfile() {
  const user = useCurrentUser();
  const role = useCurrentRole();

  return <div>Welcome, {user?.email} ({role})</div>;
}
```

### Role-Based Access

```typescript
import { RoleGate } from "@/components/auth/role-gate";
import { UserRole } from "@prisma/client";

<RoleGate allowedRole={UserRole.ADMIN}>
  <AdminPanel />
</RoleGate>
```

### Multi-Tenant Queries

```typescript
import { getTenantContext } from "@/lib/tenant-context"

export async function getStudents() {
  const { schoolId } = await getTenantContext()

  if (!schoolId) throw new Error("No school context")

  return db.student.findMany({
    where: { schoolId }, // ALWAYS include schoolId!
  })
}
```

## OAuth Configuration

### Google Setup

1. Create project in Google Cloud Console
2. Enable OAuth consent screen
3. Add credentials (OAuth 2.0 Client ID)
4. Add callback URL: `https://ed.databayt.org/api/auth/callback/google`
5. Set environment variables

### Facebook Setup

1. Create app in Facebook Developer Console
2. Add "Facebook Login" product
3. Configure Valid OAuth Redirect URIs
4. Set app to "Live" mode
5. Set environment variables

## Environment Variables

```bash
# Core
AUTH_SECRET=your_secret_here
DATABASE_URL=postgresql://...

# OAuth
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
FACEBOOK_CLIENT_ID=
FACEBOOK_CLIENT_SECRET=

# Email
RESEND_API_KEY=

# URLs
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXTAUTH_URL=https://ed.databayt.org
```

## Cookie Configuration

Production cookies use `.databayt.org` domain for cross-subdomain SSO:

```typescript
cookies: {
  sessionToken: {
    name: "authjs.session-token",
    options: {
      httpOnly: true,
      sameSite: "lax",
      path: "/",
      secure: true,
      domain: ".databayt.org"
    }
  }
}
```

## Best Practices

### OAuth vs Credentials

| Scenario                  | Recommended Method          |
| ------------------------- | --------------------------- |
| Students self-registering | OAuth (Google/Facebook)     |
| Teachers self-registering | OAuth (Google/Facebook)     |
| Admin creating accounts   | Credentials (bulk import)   |
| Users without email       | Credentials (admin-created) |
| Quick onboarding          | OAuth                       |
| Full admin control        | Credentials                 |

**Recommendation**: Offer both options and let schools choose their preferred workflow.

### Security Checklist

- [x] Passwords hashed with bcrypt
- [x] JWT with 24h expiry
- [x] Secure cookies (httpOnly, sameSite, secure)
- [x] CSRF protection via NextAuth
- [x] schoolId isolation on all models
- [x] Role-based access control

### Common Patterns

**Always include schoolId in queries**:

```typescript
// Good
db.student.findMany({ where: { schoolId, grade: "10" } })

// Bad - breaks tenant isolation!
db.student.findMany({ where: { grade: "10" } })
```

**Check role before sensitive operations**:

```typescript
const { role } = await getTenantContext()
if (role !== "ADMIN" && role !== "DEVELOPER") {
  throw new Error("Insufficient permissions")
}
```

## Debugging & Logging

### Debug Endpoint

Check authentication state and configuration at `/api/debug-auth`:

```bash
curl https://ed.databayt.org/api/debug-auth
```

Returns JSON with:

- Session info (userId, email, role, schoolId)
- Configuration validation status
- Auth-related cookies
- Provider status (Google, Facebook)
- Callback URLs
- Debugging hints

**Note**: This endpoint is at `/api/debug-auth` (not `/api/auth/debug`) to avoid conflicts with NextAuth's catch-all route.

### Centralized Logging

All auth operations are logged through `src/lib/auth-logger.ts`:

```typescript
import { authLogger } from "@/lib/auth-logger"

// Logging methods
authLogger.info("Message", { data }) // General info
authLogger.warn("Message", { data }) // Warnings
authLogger.error("Message", { data }) // Errors
authLogger.oauth("google", "step", data) // OAuth flow
authLogger.callback("signIn", { data }) // Callbacks
authLogger.session("action", { data }) // Session ops
authLogger.api("GET", "/path", { data }) // API requests
authLogger.exception("msg", error) // Exceptions with stack
authLogger.redirect(from, to, reason) // Redirects
```

### Configuration Validation

Environment variables are validated at startup via `src/lib/auth-config-validator.ts`:

```typescript
import { validateAuthConfig } from "@/lib/auth-config-validator"

const result = validateAuthConfig()
// Returns: { valid: boolean, issues: string[], warnings: string[], config: {...} }
```

Validates:

- `AUTH_SECRET` (required, min 32 chars)
- `GOOGLE_CLIENT_ID` & `GOOGLE_CLIENT_SECRET`
- `FACEBOOK_CLIENT_ID` & `FACEBOOK_CLIENT_SECRET`
- `NEXTAUTH_URL`
- `DATABASE_URL`

### Viewing Logs

**Local Development**:

```bash
pnpm dev 2>&1 | grep -E '\[AUTH|\[OAUTH'
```

**Vercel Production**:

```bash
vercel logs https://ed.databayt.org --output=short
```

### Log Format

```
[AUTH:INFO] Configuration validation PASSED
[OAUTH:GOOGLE] Profile callback received @ 2025-12-15T10:30:00.000Z
  { sub: "123...", email: "user@...", emailVerified: true }
[AUTH:CALLBACK:SIGNIN] @ 2025-12-15T10:30:05.000Z
  { provider: "google", userId: "xxx", hasProfile: true }
[AUTH:API] GET /api/auth/callback/google
  { action: "callback/google", status: 302 }
```

## Troubleshooting

### OAuth Issues

**redirect_uri_mismatch**: Callback URL in provider console doesn't match application

- Verify exact URL including protocol and port
- No trailing slashes

**access_denied**: User denied permission or app misconfigured

- Check OAuth consent screen
- Verify required scopes

**Configuration error**: Check the debug endpoint first

```bash
curl https://ed.databayt.org/api/debug-auth | jq '.config'
```

Common causes:

- Missing `AUTH_SECRET` or too short (< 32 chars)
- Missing OAuth credentials
- Invalid `NEXTAUTH_URL`

### Session Issues

**User not persisting**: Cookie not being set

- Check domain configuration
- Verify AUTH_SECRET is set

**Role not updating**: Session not refreshed

- Force session refresh after role change
- Check JWT callback

### Multi-Tenant Issues

**Wrong school context**: Query returning other school's data

- Always include schoolId in where clause
- Use getTenantContext()

## Roadmap

### Completed

1. ~~**Remove debug logging**~~ - Replaced with centralized `authLogger` utility
2. **Debug endpoint** - `/api/debug-auth` for checking auth state
3. **Configuration validation** - Environment vars validated at startup
4. **OAuth profile logging** - Google & Facebook callbacks log profile data

### Short-term (P1)

5. **Invitation system** - Schools invite users with pre-assigned roles
6. **School join codes** - Simple codes like "HOGWARTS-2024" for easy joining

### Medium-term (P2)

7. **Bulk user creation** - CSV import for students/teachers

## Testing

### Unit Test Coverage

The authentication module has **123 unit tests** covering:

| Test File              | Tests | Description                                          |
| ---------------------- | ----- | ---------------------------------------------------- |
| `validation.test.ts`   | 49    | Zod schema validation for all auth forms             |
| `user.test.ts`         | 22    | User utilities and multi-tenant safety               |
| `tokens.test.ts`       | 16    | Token generation (2FA, password reset, verification) |
| `login/action.test.ts` | 24    | Login flow with 2FA and smart redirect               |
| `join/action.test.ts`  | 12    | Registration and multi-tenant isolation              |

### Running Auth Tests

```bash
# Run all auth tests
pnpm test src/components/auth/__tests__

# Run specific test file
pnpm test src/components/auth/__tests__/validation.test.ts

# Run with watch mode
pnpm test src/components/auth/__tests__ --watch
```

### Known Issues (Documented in Tests)

The test suite explicitly documents multi-tenant safety issues:

1. **`getUserByEmail` not tenant-scoped** - Returns any user with email regardless of school
2. **OAuth users created without schoolId** - New OAuth users exist in limbo until onboarding
3. **Registration lacks school context** - Users created without multi-tenant isolation

See [ISSUE.md](/src/components/auth/ISSUE.md) for current test status and required fixes.

## Related Documentation

- [Onboarding](/docs/onboarding) - School creation flow
- [Architecture](/docs/architecture) - System design
- [Multi-Tenant Safety](/docs/multi-tenant) - Data isolation

---

This authentication system provides enterprise-grade security with flexibility for different school management workflows.
