---
title: "Authentication"
description: "Multi-tenant authentication for school management with OAuth and Credentials"
---

## Overview

Our authentication system is built on Next.js App Router with Auth.js (NextAuth v5), specifically designed for multi-tenant school management. It supports OAuth providers (Google, Facebook), email/password credentials, two-factor authentication, and seamless cross-subdomain single sign-on.

## Login & Logout Flow

This section documents the **four entry points** for authentication and their corresponding flows.

### Entry Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           FOUR ENTRY POINTS                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1ï¸âƒ£  MARKETING HEADER (Login Button)                                        â”‚
â”‚      â””â”€â”€ ed.databayt.org â†’ Header "Login" icon â†’ /login                     â”‚
â”‚      â””â”€â”€ After login: DEVELOPER â†’ /dashboard, Others â†’ / (homepage)         â”‚
â”‚                                                                              â”‚
â”‚  2ï¸âƒ£  GET STARTED (Onboarding)                                               â”‚
â”‚      â””â”€â”€ ed.databayt.org â†’ "Get Started" button â†’ /onboarding               â”‚
â”‚      â””â”€â”€ Requires auth â†’ redirects to /login?callbackUrl=/onboarding        â”‚
â”‚      â””â”€â”€ After login: Continues to onboarding wizard                        â”‚
â”‚                                                                              â”‚
â”‚  3ï¸âƒ£  SCHOOL SUBDOMAIN LOGIN                                                 â”‚
â”‚      â””â”€â”€ {school}.databayt.org/login â†’ School-specific login                â”‚
â”‚      â””â”€â”€ After login: DEVELOPER â†’ /dashboard, Others â†’ / (homepage)         â”‚
â”‚                                                                              â”‚
â”‚  4ï¸âƒ£  PROTECTED ROUTE ACCESS                                                 â”‚
â”‚      â””â”€â”€ Direct URL to protected page (e.g., /dashboard, /profile)          â”‚
â”‚      â””â”€â”€ Middleware redirects to /login?callbackUrl={original_url}          â”‚
â”‚      â””â”€â”€ After login: Returns to original destination                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Login Flow by Entry Point

#### Entry Point 1: Marketing Header Login

```
User clicks Login icon in header
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   /en/login or      â”‚
â”‚   /ar/login         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         AUTHENTICATION OPTIONS          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Google OAuth]  [Facebook]  [Email]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         REDIRECT DECISION               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Role = DEVELOPER?                      â”‚
â”‚    YES â†’ /{locale}/dashboard (operator) â”‚
â”‚  Has schoolId?                          â”‚
â”‚    YES â†’ {school}.databayt.org/dashboardâ”‚
â”‚    NO  â†’ /{locale}/onboarding           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Entry Point 2: Get Started (Onboarding)

```
User clicks "Get Started"
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   /onboarding       â”‚ â—„â”€â”€ Protected route
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ (No session)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redirect to:                           â”‚
â”‚  /login?callbackUrl=/onboarding         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Authenticate      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   /onboarding       â”‚ â—„â”€â”€ 16-step wizard
â”‚   (School creation) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Entry Point 3: School Subdomain

```
User visits: school.databayt.org/login
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Login page with school context        â”‚
â”‚   Same OAuth + Credentials options      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         REDIRECT DECISION               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Role = DEVELOPER?                      â”‚
â”‚    YES â†’ /{locale}/dashboard (operator) â”‚
â”‚  Has schoolId?                          â”‚
â”‚    YES â†’ {school}.databayt.org/dashboardâ”‚
â”‚    NO  â†’ /{locale}/onboarding           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Entry Point 4: Protected Route

```
User visits: /dashboard (protected)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Middleware checks session             â”‚
â”‚   No session? â†’ Store callbackUrl       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   /login?callbackUrl=/dashboard         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Authenticate      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   /dashboard        â”‚ â—„â”€â”€ Original destination
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Logout Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LOGOUT POINTS                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1ï¸âƒ£  USER MENU DROPDOWN (Context-Aware)                                     â”‚
â”‚      â””â”€â”€ Marketing/Operator â†’ /{locale} (homepage)                          â”‚
â”‚      â””â”€â”€ School Platform â†’ /{locale}/s/{subdomain}/ (school homepage)       â”‚
â”‚                                                                              â”‚
â”‚  2ï¸âƒ£  SESSION EXPIRY                                                         â”‚
â”‚      â””â”€â”€ JWT expires (24 hours) â†’ Next request â†’ /login?callbackUrl={url}   â”‚
â”‚                                                                              â”‚
â”‚  3ï¸âƒ£  PROGRAMMATIC SIGNOUT                                                   â”‚
â”‚      â””â”€â”€ signOut({ redirect: false }) â†’ Client redirect to context-aware URLâ”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Logout Implementation Details

The logout flow uses **client-side redirect** to avoid middleware interference:

```
User clicks "Logout" in dropdown
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LogoutButton determines return URL:    â”‚
â”‚  - Marketing/Operator: /{locale}        â”‚
â”‚  - School Platform: /{locale}/s/{sub}/  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  logout(returnUrl) server action:       â”‚
â”‚  - Calls signOut({ redirect: false })   â”‚
â”‚  - Session cookie cleared server-side   â”‚
â”‚  - Returns returnUrl to client          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client-side redirect:                  â”‚
â”‚  window.location.href = returnUrl       â”‚
â”‚  (Hard navigation ensures fresh state)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Why client-side redirect?**

When using `signOut({ redirect: true })`, NextAuth's server-side redirect would:

1. Clear the session cookie
2. Send redirect response to homepage
3. **Problem**: Middleware sees unauthenticated request to current protected route
4. Middleware redirects to `/login?callbackUrl={current_route}` before homepage loads

By using `redirect: false` + client-side `window.location.href`:

1. Session cleared server-side
2. Client navigates directly to homepage
3. No middleware interference (homepage is public)

**Files:**

- `src/components/auth/logout-button.tsx` - Context-aware URL + client redirect
- `src/components/auth/logout-action.ts` - Server action with `redirect: false`

### Test Results (Production)

Tested on: **https://ed.databayt.org/en** (2025-12-17) - Full E2E Test Suite

| Test Case       | Entry Point | Action                         | Expected                              | Result  |
| --------------- | ----------- | ------------------------------ | ------------------------------------- | ------- |
| Homepage Load   | Marketing   | Visit ed.databayt.org/en       | Homepage renders                      | âœ… Pass |
| Login Button    | Header      | Click Login icon               | Navigate to /en/login                 | âœ… Pass |
| Login Page      | /en/login   | Page loads                     | Shows Google, Facebook, Email options | âœ… Pass |
| Invalid Email   | Credentials | Submit non-existent email      | "Email does not exist!" error         | âœ… Pass |
| Forgot Password | Login page  | Click "Forgot Password?"       | Navigate to /en/reset                 | âœ… Pass |
| Reset Page      | /en/reset   | Page loads                     | Shows email input + Reset button      | âœ… Pass |
| Invalid Reset   | Reset page  | Submit non-existent email      | "Email not found!" error              | âœ… Pass |
| Back to Login   | Reset page  | Click "Back"                   | Navigate to /login                    | âœ… Pass |
| Join Link       | Login page  | Click "Don't have an account?" | Navigate to /join                     | âœ… Pass |

#### Redirect Behavior Tests

| Role      | Login From        | Expected Redirect                          | Status         |
| --------- | ----------------- | ------------------------------------------ | -------------- |
| DEVELOPER | ed.databayt.org   | `/{locale}/dashboard` (operator)           | âœ… Implemented |
| ADMIN     | ed.databayt.org   | `{school}.databayt.org/{locale}/dashboard` | âœ… Implemented |
| TEACHER   | ed.databayt.org   | `{school}.databayt.org/{locale}/dashboard` | âœ… Implemented |
| STUDENT   | ed.databayt.org   | `{school}.databayt.org/{locale}/dashboard` | âœ… Implemented |
| GUARDIAN  | ed.databayt.org   | `{school}.databayt.org/{locale}/dashboard` | âœ… Implemented |
| USER      | ed.databayt.org   | `/{locale}/onboarding`                     | âœ… Implemented |
| ADMIN     | demo.databayt.org | `demo.databayt.org/{locale}/dashboard`     | âœ… Implemented |
| TEACHER   | demo.databayt.org | `demo.databayt.org/{locale}/dashboard`     | âœ… Implemented |
| STUDENT   | demo.databayt.org | `demo.databayt.org/{locale}/dashboard`     | âœ… Implemented |

#### UI Component Tests

| Component     | Location               | Expected                                   | Result  |
| ------------- | ---------------------- | ------------------------------------------ | ------- |
| Login Icon    | Header (not logged in) | size-4 LogIn icon in size-8 ghost button   | âœ… Pass |
| Avatar        | Header (logged in)     | size-4 avatar in size-8 ghost button       | âœ… Pass |
| OAuth Buttons | /login                 | Google + Facebook buttons visible          | âœ… Pass |
| Error Toast   | /login                 | Red error with icon on invalid credentials | âœ… Pass |

#### OAuth Login Tests (Production)

Tested on: **https://ed.databayt.org/en** (2025-12-17) - Google + Facebook OAuth

##### Google OAuth

| Test Case          | Provider | Action              | Expected                                   | Result  |
| ------------------ | -------- | ------------------- | ------------------------------------------ | ------- |
| OAuth Initiation   | Google   | Click Google button | Redirect to Google consent                 | âœ… Pass |
| PKCE Challenge     | Google   | OAuth URL params    | `code_challenge` + S256 method             | âœ… Pass |
| Authorization Code | Google   | OAuth response_type | `response_type=code`                       | âœ… Pass |
| Callback URL       | Google   | OAuth redirect_uri  | `ed.databayt.org/api/auth/callback/google` | âœ… Pass |
| OIDC Scopes        | Google   | OAuth scope         | `openid profile email`                     | âœ… Pass |
| Consent Prompt     | Google   | OAuth prompt        | Forces consent screen                      | âœ… Pass |

**Google OAuth URL Parameters:**

```
client_id: 861303536195-188jq8irdl78cvv5vqo0o9m2il1pqq6n.apps.googleusercontent.com
code_challenge_method: S256
response_type: code
redirect_uri: https://ed.databayt.org/api/auth/callback/google
scope: openid profile email
prompt: consent
access_type: offline
```

##### Facebook OAuth

| Test Case          | Provider | Action                | Expected                                     | Result  |
| ------------------ | -------- | --------------------- | -------------------------------------------- | ------- |
| OAuth Initiation   | Facebook | Click Facebook button | Redirect to Facebook login                   | âœ… Pass |
| PKCE Challenge     | Facebook | OAuth URL params      | `code_challenge` + S256 method               | âœ… Pass |
| Authorization Code | Facebook | OAuth response_type   | `response_type=code`                         | âœ… Pass |
| Callback URL       | Facebook | OAuth redirect_uri    | `ed.databayt.org/api/auth/callback/facebook` | âœ… Pass |
| Scope              | Facebook | OAuth scope           | `email`                                      | âœ… Pass |

**Facebook OAuth URL Parameters:**

```
client_id: 1205807928138393
code_challenge_method: S256
response_type: code
redirect_uri: https://ed.databayt.org/api/auth/callback/facebook
scope: email
```

#### Credentials Login Tests (Production)

| Test Case       | Action                  | Expected                      | Result  |
| --------------- | ----------------------- | ----------------------------- | ------- |
| Valid Login     | dev@databayt.org + 1234 | Redirect to `/en/dashboard`   | âœ… Pass |
| DEVELOPER Role  | After login             | Access operator dashboard     | âœ… Pass |
| Session Cookie  | After login             | User menu shows "D" initial   | âœ… Pass |
| Invalid Email   | nonexistent@email.com   | "Email does not exist!" error | âœ… Pass |
| Forgot Password | Click link              | Navigate to `/en/reset`       | âœ… Pass |

#### CTA Flow Tests (Production)

| Test Case      | CTA Button     | Action       | Expected                                           | Result  |
| -------------- | -------------- | ------------ | -------------------------------------------------- | ------- |
| Get Started    | Hero section   | Click button | Redirect to `/en/login?callbackUrl=/en/onboarding` | âœ… Pass |
| Live Demo      | Hero section   | Click button | Opens `demo.databayt.org/en` in new tab            | âœ… Pass |
| Demo Site Load | demo subdomain | Page renders | Full school site with houses, faculty, etc.        | âœ… Pass |

#### Logout Tests (Production)

| Test Case          | Entry Point   | Action                            | Expected                          | Result  |
| ------------------ | ------------- | --------------------------------- | --------------------------------- | ------- |
| Credentials Logout | /dashboard    | Click Logout from avatar dropdown | Redirect to `/{locale}` homepage  | âœ… Pass |
| No callbackUrl     | /dashboard    | After logout                      | URL is `/en` (no `?callbackUrl=`) | âœ… Pass |
| Session Cleared    | Marketing     | After logout                      | Login link visible in header      | âœ… Pass |
| Locale Preserved   | /ar/dashboard | Logout                            | Redirects to `/ar`                | âœ… Pass |

#### Multi-Tenant Authorization Tests (Production)

Tested on: **https://demo.databayt.org** (2025-12-17) - School Subdomain Authorization

| Test Case           | User               | Target School | User's School | Expected          | Result  |
| ------------------- | ------------------ | ------------- | ------------- | ----------------- | ------- |
| Same-School Access  | admin@databayt.org | demo          | demo          | âœ… Dashboard      | âœ… Pass |
| DEVELOPER Bypass    | dev@databayt.org   | demo          | null          | âœ… Dashboard      | âœ… Pass |
| Unauthenticated     | -                  | demo          | -             | âŒ Login redirect | âœ… Pass |
| Non-Existent School | (any)              | fake          | -             | âŒ 404 Not Found  | âœ… Pass |

**Authorization Flow Verified:**

```
User Request â†’ Edge Middleware (proxy.ts)
         â†“
    JWT Decode â†’ Extract schoolId, role
         â†“
    Route Protection (roleRoutes matrix)
         â†“
    Platform Layout â†’ getTenantContext() â†’ Resolve subdomain
         â†“
    requireSchoolAccess() â†’ user.schoolId === school.id OR isPlatformAdmin?
         â†“
    PASS â†’ Dashboard  |  FAIL â†’ /unauthorized or 404
```

**Key Findings:**

1. **Cross-Subdomain SSO** - Cookie domain `.databayt.org` enables seamless authentication across all subdomains
2. **DEVELOPER Bypass** - Platform admins (DEVELOPER role) can access any school's dashboard regardless of schoolId
3. **Unauthenticated Protection** - Protected routes redirect to `/login?callbackUrl={route}`
4. **Graceful 404** - Non-existent school subdomains return 404 (no data leakage)

### Demo Credentials

For testing and development, the following seed accounts are available:

| Role       | Email                     | Password | Access Level                 |
| ---------- | ------------------------- | -------- | ---------------------------- |
| DEVELOPER  | `dev@databayt.org`        | `1234`   | Platform admin (all schools) |
| ADMIN      | `admin@databayt.org`      | `1234`   | School administrator         |
| ACCOUNTANT | `accountant@databayt.org` | `1234`   | School finance access        |
| STAFF      | `staff@databayt.org`      | `1234`   | Limited school access        |

**Notes:**

- DEVELOPER has no schoolId (platform-wide access)
- All other roles are scoped to the demo school
- Run `pnpm db:seed` to create these accounts
- Seed data defined in `prisma/seeds/constants.ts`

### Implementation Details

**Files Modified:**

- `src/routes.ts` - `DEFAULT_LOGIN_REDIRECT = "/"`
- `src/components/auth/login/action.ts` - Role-based redirect logic
- `src/components/auth/user-button.tsx` - Avatar sizing to match header icons

**Redirect Logic (login/action.ts):**

```typescript
// Extract locale from callbackUrl or default to 'ar'
const locale = callbackUrl?.match(/^\/(ar|en)\//)
  ? callbackUrl.match(/^\/(ar|en)\//)?.[1]
  : "ar"

if (existingUser.role === "DEVELOPER") {
  // DEVELOPER â†’ Platform operator dashboard (main domain)
  finalRedirectUrl = `/${locale}/dashboard`
} else if (existingUser.schoolId) {
  // User has a school â†’ look up school subdomain and redirect there
  const school = await db.school.findUnique({
    where: { id: existingUser.schoolId },
    select: { domain: true },
  })

  if (school?.domain) {
    // Redirect to school subdomain dashboard
    // The /dashboard is role-aware - UI adapts based on user role
    const baseUrl =
      process.env.NODE_ENV === "production"
        ? `https://${school.domain}.databayt.org`
        : `http://${school.domain}.localhost:3000`
    finalRedirectUrl = `${baseUrl}/${locale}/dashboard`
  } else {
    // Fallback: if school domain not found, go to locale homepage
    finalRedirectUrl = `/${locale}`
  }
} else {
  // No school â†’ onboarding (user needs to create/join a school)
  finalRedirectUrl = `/${locale}/onboarding`
}
```

---

## Complete Authentication Flow

This section maps **every possible way** a user can enter, authenticate, and exit the platform across all user types and entry points.

### User Types & Their Journeys

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         WHO ARE YOU? â†’ WHERE DO YOU GO?                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  ğŸ‘¨â€ğŸ’» DEVELOPER (Platform Admin)                                                  â”‚
â”‚  â””â”€â”€ Any login â†’ Platform Admin Dashboard (all schools access)                  â”‚
â”‚                                                                                  â”‚
â”‚  ğŸ« SCHOOL OWNER/PRINCIPAL (New)                                                 â”‚
â”‚  â””â”€â”€ "Get Started" â†’ Login/Join â†’ Onboarding (16 steps) â†’ School Created        â”‚
â”‚                                                                                  â”‚
â”‚  ğŸ‘¨â€ğŸ“ POTENTIAL CLIENT (Student/Parent applying)                                   â”‚
â”‚  â””â”€â”€ School Page â†’ "Apply" â†’ Login/Join â†’ Application Form â†’ Submitted          â”‚
â”‚                                                                                  â”‚
â”‚  ğŸ‘©â€ğŸ« EXISTING MEMBER (Student/Teacher/Staff/Admin)                                â”‚
â”‚  â””â”€â”€ School Login â†’ Dashboard (role-specific view)                              â”‚
â”‚                                                                                  â”‚
â”‚  ğŸ‘¤ VISITOR (Just browsing)                                                      â”‚
â”‚  â””â”€â”€ Marketing pages (no auth required)                                         â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Master Authentication Flowchart

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚     USER ARRIVES    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                          â”‚                          â”‚
                    â–¼                          â–¼                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  MARKETING SITE   â”‚      â”‚   SCHOOL SITE     â”‚      â”‚  DIRECT PLATFORM  â”‚
        â”‚ ed.databayt.org   â”‚      â”‚ {school}.databayt â”‚      â”‚  ACCESS ATTEMPT   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                          â”‚                          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                          â”‚
    â”‚             â”‚             â”‚            â”‚                          â”‚
    â–¼             â–¼             â–¼            â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Browse â”‚   â”‚  Login  â”‚   â”‚   Get   â”‚   â”‚ School  â”‚              â”‚  Protected  â”‚
â”‚ Only  â”‚   â”‚ Button  â”‚   â”‚ Started â”‚   â”‚  Page   â”‚              â”‚    Route    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚            â”‚             â”‚             â”‚                          â”‚
    â”‚            â”‚             â”‚             â”‚                          â”‚
    â–¼            â”‚             â”‚             â”‚                          â”‚
  [EXIT]         â”‚             â”‚             â”‚                          â”‚
  No auth        â”‚             â”‚             â”‚                          â”‚
  needed         â–¼             â–¼             â–¼                          â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                      LOGIN / JOIN PAGE                          â”‚
           â”‚                                                                 â”‚
           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
           â”‚   â”‚   Google    â”‚    â”‚  Facebook   â”‚    â”‚ Credentials â”‚        â”‚
           â”‚   â”‚   OAuth     â”‚    â”‚   OAuth     â”‚    â”‚ Email/Pass  â”‚        â”‚
           â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
           â”‚          â”‚                  â”‚                  â”‚               â”‚
           â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
           â”‚                             â”‚                                  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  AUTHENTICATION     â”‚
                              â”‚  (OAuth or Creds)   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    â”‚                    â”‚
                    â–¼                    â–¼                    â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   NEW     â”‚        â”‚ EXISTING  â”‚        â”‚   AUTH    â”‚
              â”‚   USER    â”‚        â”‚   USER    â”‚        â”‚  FAILED   â”‚
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                    â”‚                    â”‚                    â”‚
                    â–¼                    â–¼                    â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ User Created    â”‚   â”‚ Session Created â”‚   â”‚ Error Page  â”‚
           â”‚ schoolId: null  â”‚   â”‚ Fetch user data â”‚   â”‚ Try again   â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                     â”‚
                    â”‚                     â”‚
                    â–¼                     â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                    REDIRECT DECISION                        â”‚
           â”‚                                                             â”‚
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚  â”‚ Q1: Is user DEVELOPER?                              â”‚   â”‚
           â”‚  â”‚     YES â†’ Platform Admin Dashboard                  â”‚   â”‚
           â”‚  â”‚     NO  â†’ Continue                                  â”‚   â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                             â”‚                               â”‚
           â”‚                             â–¼                               â”‚
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚  â”‚ Q2: Does user have schoolId?                        â”‚   â”‚
           â”‚  â”‚     NO  â†’ Onboarding (create/join school)           â”‚   â”‚
           â”‚  â”‚     YES â†’ Continue                                  â”‚   â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                             â”‚                               â”‚
           â”‚                             â–¼                               â”‚
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚  â”‚ Q3: Was there a callback URL stored?                â”‚   â”‚
           â”‚  â”‚     YES â†’ Return to original destination            â”‚   â”‚
           â”‚  â”‚     NO  â†’ School dashboard                          â”‚   â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                                                             â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                 â”‚                                 â”‚
       â–¼                                 â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PLATFORM ADMIN â”‚           â”‚     ONBOARDING      â”‚           â”‚ SCHOOL DASHBOARD â”‚
â”‚   DASHBOARD     â”‚           â”‚                     â”‚           â”‚                  â”‚
â”‚                 â”‚           â”‚  16-step wizard:    â”‚           â”‚  Role-specific:  â”‚
â”‚  â€¢ All schools  â”‚           â”‚  â€¢ School info      â”‚           â”‚  â€¢ ADMIN: Full   â”‚
â”‚  â€¢ Impersonate  â”‚           â”‚  â€¢ Branding         â”‚           â”‚  â€¢ TEACHER: Classâ”‚
â”‚  â€¢ Analytics    â”‚           â”‚  â€¢ Calendar         â”‚           â”‚  â€¢ STUDENT: My   â”‚
â”‚  â€¢ Settings     â”‚           â”‚  â€¢ Import data      â”‚           â”‚  â€¢ GUARDIAN: Kidsâ”‚
â”‚                 â”‚           â”‚                     â”‚           â”‚  â€¢ STAFF: Limitedâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                               â”‚                               â”‚
         â”‚                               â–¼                               â”‚
         â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
         â”‚                    â”‚  School Created     â”‚                    â”‚
         â”‚                    â”‚  User â†’ ADMIN role  â”‚                    â”‚
         â”‚                    â”‚  Redirect to school â”‚                    â”‚
         â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
         â”‚                               â”‚                               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   ACTIVE SESSION    â”‚
                              â”‚   User is working   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                     â”‚
                              â–¼                     â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   LOGOUT VIA    â”‚   â”‚  SESSION EXPIRESâ”‚
                    â”‚   User Action   â”‚   â”‚  (24 hours)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚                     â”‚
                             â–¼                     â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           LOGGED OUT                â”‚
                    â”‚                                     â”‚
                    â”‚  User action â†’ /{locale} (homepage) â”‚
                    â”‚  Session expiry â†’ /login?callback   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Platform Link Flow (School Site â†’ School Dashboard)

This flow covers all scenarios when clicking the "Platform" link from a school marketing site header (e.g., `demo.localhost:3000/en`):

```
       All Possible Scenarios After Clicking "Platform" Link

  Click "Platform" from demo.localhost:3000/en header
                      â”‚
                      â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Is user logged in? â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                     â–¼
      [NO - Guest]          [YES - Authenticated]
           â”‚                     â”‚
           â–¼                     â–¼
     Redirect to            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     /en/login              â”‚ Correct school?â”‚
           â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                     â”‚
           â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
           â”‚              â–¼             â–¼
           â”‚         [NO - Wrong]  [YES - Demo]
           â”‚              â”‚             â”‚
           â”‚              â–¼             â–¼
           â”‚         Access Denied  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚         or Redirect    â”‚  User Role? â”‚
           â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                             â”‚
           â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
           â”‚              â–¼      â–¼       â–¼       â–¼      â–¼
           â”‚           ADMIN  TEACHER STUDENT STAFF  OTHER
           â”‚              â”‚      â”‚       â”‚       â”‚      â”‚
           â”‚              â–¼      â–¼       â–¼       â–¼      â–¼
           â”‚           Full   Teacher Student Staff  Limited
           â”‚           Dashboard View   View   View   View
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Login Form  â”‚
     â”‚ displayed   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
     Fill credentials
     (admin@databayt.org)
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Valid login?    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
      â–¼         â–¼
    [NO]      [YES]
      â”‚         â”‚
      â–¼         â–¼
    Error    Redirect to
    message  /en/dashboard
```

#### Key Scenarios

| Scenario                  | User State           | School Match | Result                       |
| ------------------------- | -------------------- | ------------ | ---------------------------- |
| Guest clicks Platform     | Not logged in        | N/A          | Redirect to `/login`         |
| Admin clicks Platform     | Logged in as ADMIN   | Matches      | Full dashboard access        |
| Teacher clicks Platform   | Logged in as TEACHER | Matches      | Teacher-scoped dashboard     |
| Student clicks Platform   | Logged in as STUDENT | Matches      | Student-scoped dashboard     |
| Wrong school user         | Logged in            | Mismatch     | Access denied or redirect    |
| DEVELOPER clicks Platform | Logged in            | Any          | Full access (platform admin) |

### Entry Points Inventory

| #   | Entry Point   | Location            | Trigger      | Requires Auth? | Destination                             |
| --- | ------------- | ------------------- | ------------ | -------------- | --------------------------------------- |
| 1   | "Get Started" | Marketing hero      | Button click | YES            | Onboarding â†’ School creation            |
| 2   | "Login"       | Marketing header    | Button click | YES            | Dashboard (if has school) or Onboarding |
| 3   | "Apply Now"   | School public page  | Button click | YES            | Application form                        |
| 4   | "Sign In"     | School login page   | Button click | YES            | School dashboard                        |
| 5   | Direct URL    | Any protected route | URL access   | YES            | Original page (after auth)              |
| 6   | Avatar menu   | Platform header     | Click        | Already authed | Profile/Settings/Logout                 |
| 7   | "Platform"    | School site header  | Button click | YES            | School dashboard (role-based)           |

### Logout Points Inventory

| #   | Logout Point    | Location         | Component      | Redirect After                      |
| --- | --------------- | ---------------- | -------------- | ----------------------------------- |
| 1   | Avatar dropdown | Marketing header | `LogoutButton` | `/{locale}` (homepage)              |
| 2   | Avatar dropdown | Operator header  | `LogoutButton` | `/{locale}` (homepage)              |
| 3   | Avatar dropdown | School platform  | `LogoutButton` | `/{locale}/s/{subdomain}/` (school) |
| 4   | Session expiry  | Automatic        | JWT timeout    | `/login?callbackUrl={current}`      |
| 5   | Sign out action | Programmatic     | `logout(url)`  | Custom URL (client-side redirect)   |

### Detailed User Journeys

#### Journey 1: School Owner Creating a School

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JOURNEY: Principal/Owner â†’ Get Started â†’ Create School                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Visit: ed.databayt.org                                                   â”‚
â”‚     â””â”€â”€ Sees marketing page with pricing, features                           â”‚
â”‚                                                                              â”‚
â”‚  2. Click: "Get Started" (hero button)                                       â”‚
â”‚     â””â”€â”€ Route: /onboarding (PROTECTED)                                       â”‚
â”‚     â””â”€â”€ Middleware: No session â†’ redirect to /login                          â”‚
â”‚                                                                              â”‚
â”‚  3. Redirected: /login?callbackUrl=/onboarding                               â”‚
â”‚     â””â”€â”€ Callback URL preserved in cookie                                     â”‚
â”‚                                                                              â”‚
â”‚  4. Choose: Google OAuth                                                     â”‚
â”‚     â””â”€â”€ Redirect to Google consent                                           â”‚
â”‚     â””â”€â”€ "Continue as {name}"                                                 â”‚
â”‚                                                                              â”‚
â”‚  5. Callback: /api/auth/callback/google                                      â”‚
â”‚     â””â”€â”€ Adapter: Creates User with schoolId: null                            â”‚
â”‚     â””â”€â”€ Creates Account linked to User                                       â”‚
â”‚                                                                              â”‚
â”‚  6. Redirect Decision:                                                       â”‚
â”‚     â””â”€â”€ User has no schoolId â†’ /onboarding                                   â”‚
â”‚     â””â”€â”€ Callback URL matches â†’ proceed to onboarding                         â”‚
â”‚                                                                              â”‚
â”‚  7. Onboarding: 16-step wizard                                               â”‚
â”‚     â””â”€â”€ School name, subdomain                                               â”‚
â”‚     â””â”€â”€ Branding (logo, colors)                                              â”‚
â”‚     â””â”€â”€ Academic year setup                                                  â”‚
â”‚     â””â”€â”€ Import existing data (optional)                                      â”‚
â”‚                                                                              â”‚
â”‚  8. Complete: School created                                                 â”‚
â”‚     â””â”€â”€ User.schoolId = new school ID                                        â”‚
â”‚     â””â”€â”€ User.role = ADMIN                                                    â”‚
â”‚     â””â”€â”€ Redirect: {subdomain}.databayt.org/dashboard                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Journey 2: Parent Applying to a School

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JOURNEY: Parent â†’ School Public Page â†’ Apply for Child                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Visit: hogwarts.databayt.org (school's public page)                      â”‚
â”‚     â””â”€â”€ Sees school info, programs, application info                         â”‚
â”‚                                                                              â”‚
â”‚  2. Click: "Apply Now" or "Start Application"                                â”‚
â”‚     â””â”€â”€ Route: /apply (or /admission)                                        â”‚
â”‚     â””â”€â”€ May be protected or have partial form                                â”‚
â”‚                                                                              â”‚
â”‚  3. Application Form (Step 1):                                               â”‚
â”‚     â””â”€â”€ Basic info collected (no auth yet)                                   â”‚
â”‚     â””â”€â”€ "To save your application, please sign in"                           â”‚
â”‚                                                                              â”‚
â”‚  4. Click: "Sign in to continue"                                             â”‚
â”‚     â””â”€â”€ Redirect: /login?callbackUrl=/apply&step=2                           â”‚
â”‚                                                                              â”‚
â”‚  5. Choose: Facebook OAuth                                                   â”‚
â”‚     â””â”€â”€ Redirect to Facebook                                                 â”‚
â”‚     â””â”€â”€ "Continue as {name}"                                                 â”‚
â”‚                                                                              â”‚
â”‚  6. Callback: /api/auth/callback/facebook                                    â”‚
â”‚     â””â”€â”€ Adapter: Creates or finds User                                       â”‚
â”‚     â””â”€â”€ User may not have schoolId yet (applicant status)                    â”‚
â”‚                                                                              â”‚
â”‚  7. Return to: /apply?step=2                                                 â”‚
â”‚     â””â”€â”€ Application synced to user account                                   â”‚
â”‚     â””â”€â”€ Can save progress, return later                                      â”‚
â”‚                                                                              â”‚
â”‚  8. Complete Application:                                                    â”‚
â”‚     â””â”€â”€ Application submitted                                                â”‚
â”‚     â””â”€â”€ User gets APPLICANT status for this school                           â”‚
â”‚     â””â”€â”€ Redirect: /apply/confirmation                                        â”‚
â”‚                                                                              â”‚
â”‚  9. Later (if accepted):                                                     â”‚
â”‚     â””â”€â”€ Admin enrolls student                                                â”‚
â”‚     â””â”€â”€ User.schoolId = school ID                                            â”‚
â”‚     â””â”€â”€ User.role = GUARDIAN (or STUDENT)                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Journey 3: Existing Teacher Returning

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JOURNEY: Teacher â†’ Login â†’ Dashboard                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Visit: hogwarts.databayt.org/login                                       â”‚
â”‚     â””â”€â”€ Or direct to /dashboard (redirected to /login)                       â”‚
â”‚                                                                              â”‚
â”‚  2. Choose: Google OAuth (same as before)                                    â”‚
â”‚     â””â”€â”€ "Continue as {name}"                                                 â”‚
â”‚                                                                              â”‚
â”‚  3. Callback: /api/auth/callback/google                                      â”‚
â”‚     â””â”€â”€ Adapter: getUserByAccount() finds existing Account                   â”‚
â”‚     â””â”€â”€ Returns linked User with schoolId                                    â”‚
â”‚                                                                              â”‚
â”‚  4. Redirect Decision:                                                       â”‚
â”‚     â””â”€â”€ User has schoolId = hogwarts                                         â”‚
â”‚     â””â”€â”€ Current subdomain = hogwarts (matches)                               â”‚
â”‚     â””â”€â”€ Redirect: /dashboard                                                 â”‚
â”‚                                                                              â”‚
â”‚  5. Dashboard:                                                               â”‚
â”‚     â””â”€â”€ Role = TEACHER                                                       â”‚
â”‚     â””â”€â”€ Sees: Classes, Lessons, Attendance, Grades                           â”‚
â”‚     â””â”€â”€ Does NOT see: Admin settings, Finance, Staff management              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Journey 4: Developer Accessing Platform

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JOURNEY: Developer â†’ Any Login â†’ Platform Admin                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Visit: Any login page (ed.databayt.org or any school)                    â”‚
â”‚                                                                              â”‚
â”‚  2. Login: Credentials or OAuth                                              â”‚
â”‚     â””â”€â”€ User has role = DEVELOPER                                            â”‚
â”‚                                                                              â”‚
â”‚  3. Redirect Decision:                                                       â”‚
â”‚     â””â”€â”€ Check role first (before schoolId check)                             â”‚
â”‚     â””â”€â”€ DEVELOPER â†’ Platform admin dashboard                                 â”‚
â”‚                                                                              â”‚
â”‚  4. Platform Admin Dashboard:                                                â”‚
â”‚     â””â”€â”€ List of ALL schools                                                  â”‚
â”‚     â””â”€â”€ Can impersonate any school (set cookie)                              â”‚
â”‚     â””â”€â”€ Platform analytics                                                   â”‚
â”‚     â””â”€â”€ Global settings                                                      â”‚
â”‚                                                                              â”‚
â”‚  5. Impersonation:                                                           â”‚
â”‚     â””â”€â”€ Click "View as" on any school                                        â”‚
â”‚     â””â”€â”€ Cookie set: impersonate-school={schoolId}                            â”‚
â”‚     â””â”€â”€ Redirect: {school}.databayt.org/dashboard                            â”‚
â”‚     â””â”€â”€ Sees school as ADMIN would see it                                    â”‚
â”‚                                                                              â”‚
â”‚  6. Exit Impersonation:                                                      â”‚
â”‚     â””â”€â”€ Click "Exit impersonation" banner                                    â”‚
â”‚     â””â”€â”€ Cookie cleared                                                       â”‚
â”‚     â””â”€â”€ Return to platform admin                                             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Journey 5: Student Accessing from Wrong School

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JOURNEY: Student â†’ Wrong School Domain â†’ Access Denied                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. User is student at: hogwarts                                             â”‚
â”‚     â””â”€â”€ User.schoolId = hogwarts-id                                          â”‚
â”‚                                                                              â”‚
â”‚  2. Accidentally visits: beauxbatons.databayt.org/dashboard                  â”‚
â”‚                                                                              â”‚
â”‚  3. Middleware:                                                              â”‚
â”‚     â””â”€â”€ Subdomain = beauxbatons                                              â”‚
â”‚     â””â”€â”€ User.schoolId = hogwarts (mismatch!)                                 â”‚
â”‚                                                                              â”‚
â”‚  4. Access Check:                                                            â”‚
â”‚     â””â”€â”€ User does NOT belong to beauxbatons                                  â”‚
â”‚     â””â”€â”€ Result: FORBIDDEN                                                    â”‚
â”‚                                                                              â”‚
â”‚  5. Options:                                                                 â”‚
â”‚     A) Show error page: "You don't have access to this school"              â”‚
â”‚     B) Offer: "Go to your school" â†’ redirect to hogwarts                     â”‚
â”‚     C) Offer: "Request access" â†’ send request to beauxbatons admin           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Current Implementation Status

| Feature                   | Status         | Notes                                   |
| ------------------------- | -------------- | --------------------------------------- |
| OAuth Login (Google)      | âœ… Working     | Profile callback, multi-tenant adapter  |
| OAuth Login (Facebook)    | âœ… Working     | Fixed with custom adapter               |
| Credentials Login         | âœ… Working     | Email verification required             |
| Get Started â†’ Onboarding  | âœ… Working     | Protected route, callback URL preserved |
| School Dashboard Redirect | âœ… Working     | Based on schoolId lookup                |
| Developer Platform Access | âš ï¸ Partial     | Needs dedicated dashboard               |
| Application Flow          | ğŸ”² Not Started | Admission module in progress            |
| School Join Codes         | ğŸ”² Not Started | Planned feature                         |
| Invitation System         | ğŸ”² Not Started | Planned feature                         |
| Impersonation Mode        | âš ï¸ Partial     | Cookie-based, needs UI                  |

### Recommended Improvements

1. **Unified Entry Point**: Single login page that detects context and routes appropriately
2. **Better Error Pages**: Clear messaging when access is denied with actionable options
3. **School Switcher**: For users who belong to multiple schools
4. **Remember School**: Cookie to remember last accessed school
5. **Guest Application**: Allow starting applications without auth, require auth to submit

## Multi-Tenant Architecture

The authentication system is designed from the ground up for multi-tenant school management:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Authentication Flow                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Marketing Page (ed.databayt.org)                               â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚   Get Started   â”‚ â—„â”€â”€ School Owner/Principal clicks          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚           â”‚                                                     â”‚
â”‚           â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚   OAuth Login   â”‚ or  â”‚ Credentials     â”‚                    â”‚
â”‚  â”‚ (Google/FB)     â”‚     â”‚ (Email/Pass)    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚           â”‚                       â”‚                             â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                       â–¼                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚              â”‚ User Created    â”‚                                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                       â”‚                                         â”‚
â”‚                       â–¼                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚              â”‚   Onboarding    â”‚                                â”‚
â”‚              â”‚ (16 steps)      â”‚                                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                       â”‚                                         â”‚
â”‚                       â–¼                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚              â”‚   School Created & Linked          â”‚            â”‚
â”‚              â”‚   User becomes ADMIN               â”‚            â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                       â”‚                                         â”‚
â”‚                       â–¼                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚              â”‚   Subdomain: school.databayt.org   â”‚            â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Core Features

### Authentication Methods

- **Multi-Provider Auth**: Google, Facebook, Email/Password
- **JWT-Based Sessions**: 24-hour expiry with automatic refresh
- **Cross-Subdomain SSO**: Seamless login across `*.databayt.org`
- **Email Verification**: Required for credentials, automatic for OAuth
- **Password Reset**: Secure token-based recovery
- **Two-Factor Authentication**: Optional 2FA for enhanced security

### Multi-Tenant Features

- **School Isolation**: Every user is associated with a `schoolId`
- **Compound Uniqueness**: Same email can exist across different schools
- **Subdomain Routing**: `school.databayt.org` automatically resolves to school context
- **Smart Redirects**: After login, users go directly to their school's dashboard
- **Role-Based Access**: 8 roles with clear hierarchy

### User Roles

```typescript
enum UserRole {
  DEVELOPER  // Platform admin (cross-school access)
  ADMIN      // School administrator
  TEACHER    // Teaching staff
  STUDENT    // Enrolled student
  GUARDIAN   // Parent/guardian
  ACCOUNTANT // Finance staff
  STAFF      // General staff
  USER       // Default role
}
```

## User Registration Options

Schools have **flexibility** in how they manage user accounts:

### Option 1: Self-Registration via OAuth (Recommended)

Students and teachers authenticate themselves:

```
Student â†’ school.databayt.org/login â†’ Google/Facebook â†’ Profile Setup
```

**Benefits**:

- No admin work required
- Users verify their own email automatically
- Streamlined experience
- No password management overhead

### Option 2: Bulk Account Creation

School admin creates accounts in bulk:

```
Admin â†’ Import CSV â†’ Bulk creation with roles â†’ Send credentials
```

**Benefits**:

- Full admin control over who joins
- Pre-assigned roles
- Works for users without email access

### Option 3: Invitation System (Coming Soon)

Admin invites specific users:

```
Admin â†’ Generate invite link â†’ User clicks â†’ OAuth or Credentials â†’ Linked to school
```

**Benefits**:

- Controlled onboarding
- Pre-assigned roles
- Combines admin control with user convenience

### Option 4: School Join Codes (Coming Soon)

Simple codes for easy joining:

```
Student â†’ Enter code "HOGWARTS-2024" â†’ Sign up â†’ Auto-linked as STUDENT
```

**Benefits**:

- Easy to share (print, announce, etc.)
- No individual invitations needed
- Admin sets default role

## Architecture

### Core Files

| File                                     | Purpose                                                   |
| ---------------------------------------- | --------------------------------------------------------- |
| `src/auth.ts`                            | NextAuth configuration, JWT callbacks, session management |
| `src/auth.config.ts`                     | OAuth provider configurations with profile logging        |
| `src/lib/multi-tenant-prisma-adapter.ts` | Custom Prisma adapter for multi-tenant OAuth              |
| `src/middleware.ts`                      | Route protection, subdomain detection                     |
| `src/routes.ts`                          | Public/protected route definitions                        |
| `src/lib/tenant-context.ts`              | School context retrieval                                  |
| `src/lib/school-access.ts`               | School ownership and access control                       |
| `src/lib/auth-logger.ts`                 | Centralized auth logging utility                          |
| `src/lib/auth-config-validator.ts`       | Environment configuration validation                      |
| `src/app/api/debug-auth/route.ts`        | Debug endpoint for checking auth state                    |

### Component Structure

```
src/components/auth/
â”œâ”€â”€ login/          # Login form and action
â”œâ”€â”€ join/           # Registration form and action
â”œâ”€â”€ reset/          # Password reset request
â”œâ”€â”€ password/       # Password change
â”œâ”€â”€ verification/   # Email verification, 2FA
â”œâ”€â”€ setting/        # User settings
â”œâ”€â”€ user.ts         # User database queries
â”œâ”€â”€ social.tsx      # OAuth buttons
â”œâ”€â”€ role-gate.tsx   # Role-based access control
â””â”€â”€ validation.ts   # Zod schemas
```

## Session Management

### Extended Session

```typescript
session.user = {
  id: string;
  email: string;
  role: UserRole;
  schoolId: string | null;  // Multi-tenant key
  isPlatformAdmin: boolean;
}
```

### Tenant Context

```typescript
import { getTenantContext } from "@/lib/tenant-context"

const { schoolId, role, isPlatformAdmin } = await getTenantContext()
// Priority: impersonation cookie â†’ subdomain â†’ session
```

## Multi-Tenant Prisma Adapter

The standard Prisma adapter from `@auth/prisma-adapter` doesn't support multi-tenant schemas with composite unique constraints. Our User model uses:

```prisma
@@unique([email, schoolId])  // Same email allowed across different schools
```

This causes the standard adapter to fail because it queries `findUnique({ where: { email } })` which requires a simple `@unique email` constraint.

### Custom Adapter Solution

We use a custom `MultiTenantPrismaAdapter` that overrides key methods:

```typescript
import { MultiTenantPrismaAdapter } from "@/lib/multi-tenant-prisma-adapter"

export const { auth, signIn, signOut } = NextAuth({
  adapter: MultiTenantPrismaAdapter(db),
  // ...
})
```

### How It Works

| Method             | Standard Adapter                    | Multi-Tenant Adapter                              |
| ------------------ | ----------------------------------- | ------------------------------------------------- |
| `getUserByEmail`   | `findUnique({ where: { email } })`  | `findFirst({ where: { email, schoolId: null } })` |
| `createUser`       | Creates user without school context | Creates with `schoolId: null` explicitly          |
| `getUserByAccount` | Standard lookup                     | Handles composite constraints                     |
| `linkAccount`      | Standard linking                    | Logs for debugging                                |

### OAuth User Lifecycle

1. **OAuth Callback**: User authenticates with Google/Facebook
2. **Adapter Check**: `getUserByEmail` looks for existing user with `schoolId: null`
3. **Create/Link**: New users created with `schoolId: null`, existing users linked
4. **Onboarding**: User goes through onboarding to join/create a school
5. **School Assignment**: `schoolId` updated when user joins a school

This allows the same email to exist in multiple schools while OAuth users start in a "limbo" state until onboarded.

## Login Scenarios & Redirects

Understanding where users end up after login is critical for the multi-tenant experience. Here are all the possible scenarios:

### Scenario Matrix

| User State     | Entry Point                 | Has School?     | Redirect Destination              |
| -------------- | --------------------------- | --------------- | --------------------------------- |
| New OAuth user | `ed.databayt.org/login`     | No              | `/onboarding` (create school)     |
| New OAuth user | `school.databayt.org/login` | No              | `/onboarding` or join flow        |
| Existing user  | `ed.databayt.org/login`     | Yes             | `{school}.databayt.org/dashboard` |
| Existing user  | `school.databayt.org/login` | Yes (same)      | `/dashboard`                      |
| Existing user  | `other.databayt.org/login`  | Yes (different) | Error or join flow                |
| DEVELOPER role | Any login                   | N/A             | Platform admin dashboard          |

### Detailed Flow Diagrams

#### Scenario 1: New User on Marketing Site

```
User visits: ed.databayt.org
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Login Page    â”‚ â—„â”€â”€ "Get Started" or "Login"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OAuth (Google/ â”‚ or  â”‚   Credentials   â”‚
â”‚    Facebook)    â”‚     â”‚  (Email/Pass)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ User created with   â”‚
         â”‚ schoolId: null      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    Onboarding       â”‚ â—„â”€â”€ 16-step wizard
         â”‚ (Create new school) â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ School created, user is     â”‚
         â”‚ ADMIN, redirect to:         â”‚
         â”‚ {school}.databayt.org       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Scenario 2: Existing User with School

```
User visits: ed.databayt.org/login
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Login Page    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Authenticate   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JWT callback checks:                     â”‚
â”‚ - User has schoolId? YES                 â”‚
â”‚ - Look up school domain from DB          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redirect callback:                       â”‚
â”‚ â†’ {school-subdomain}.databayt.org/dash   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Scenario 3: User Logging into Specific School

```
User visits: hogwarts.databayt.org/login
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Middleware extracts subdomain: hogwarts â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Authenticate   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check: Does user belong to this school? â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ YES â†’ /dashboard                        â”‚
â”‚ NO  â†’ Error or "Request Access" page    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Scenario 4: OAuth User Returning

```
Returning OAuth user visits any login
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OAuth Provider  â”‚ â—„â”€â”€ "Continue as {name}"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Adapter: getUserByAccount()             â”‚
â”‚ â†’ Finds existing Account record         â”‚
â”‚ â†’ Returns linked User                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User has schoolId?                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ YES â†’ Redirect to school dashboard      â”‚
â”‚ NO  â†’ Redirect to onboarding            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Redirect Logic Implementation

The redirect logic is handled in `src/auth.ts` in the `redirect` callback:

```typescript
callbacks: {
  async redirect({ url, baseUrl }) {
    // 1. Check for stored callback URL (from OAuth flow)
    const callbackUrl = cookies.get("auth-callback-url")
    if (callbackUrl) {
      // Clear cookie and use stored URL
      return callbackUrl
    }

    // 2. If user has schoolId, redirect to their school
    const session = await auth()
    if (session?.user?.schoolId) {
      const schoolDomain = await getSchoolDomain(session.user.schoolId)
      if (schoolDomain) {
        return constructSchoolUrl(schoolDomain, "/dashboard")
      }
    }

    // 3. No school - send to onboarding
    return `${baseUrl}/onboarding`
  }
}
```

### Cookie-Based Callback URL Preservation

OAuth flows redirect through external providers, losing the original URL. We preserve it using an httpOnly cookie:

```typescript
// Before OAuth redirect (in social.tsx)
document.cookie = `auth-callback-url=${window.location.href}; path=/; secure; samesite=lax`

// After OAuth callback (in redirect callback)
const callbackUrl = cookies.get("auth-callback-url")
if (callbackUrl) {
  cookies.delete("auth-callback-url")
  return callbackUrl
}
```

### Edge Cases & Error States

| Scenario                       | Behavior                                         |
| ------------------------------ | ------------------------------------------------ |
| OAuth provider denies access   | Redirect to `/error?error=access_denied`         |
| OAuth returns no email         | Redirect to `/error?error=OAuthAccountNotLinked` |
| User's school was deleted      | Redirect to `/error` with "School not found"     |
| Session expired mid-navigation | Redirect to `/login?callbackUrl={current}`       |
| DEVELOPER accessing any school | Allowed via impersonation cookie                 |
| User banned from school        | `Forbidden` error on school routes               |

### Role-Based Dashboard Routing

After successful login, users see different dashboards based on role:

| Role       | Dashboard View                       |
| ---------- | ------------------------------------ |
| DEVELOPER  | Platform admin with school selector  |
| ADMIN      | School management + all modules      |
| TEACHER    | Classes, lessons, grades, attendance |
| STUDENT    | My classes, assignments, grades      |
| GUARDIAN   | Children's progress, communication   |
| ACCOUNTANT | Finance modules only                 |
| STAFF      | Limited operational views            |
| USER       | Profile only (needs role assignment) |

## Usage

### Server-Side Protection

```typescript
import { auth } from "@/auth";

export default async function ProtectedPage() {
  const session = await auth();

  if (!session) {
    redirect("/login");
  }

  return <Dashboard schoolId={session.user.schoolId} />;
}
```

### Client-Side Hooks

```typescript
"use client";
import { useCurrentUser } from "@/components/auth/use-current-user";
import { useCurrentRole } from "@/components/auth/use-current-role";

export function UserProfile() {
  const user = useCurrentUser();
  const role = useCurrentRole();

  return <div>Welcome, {user?.email} ({role})</div>;
}
```

### Role-Based Access

```typescript
import { RoleGate } from "@/components/auth/role-gate";
import { UserRole } from "@prisma/client";

<RoleGate allowedRole={UserRole.ADMIN}>
  <AdminPanel />
</RoleGate>
```

### Multi-Tenant Queries

```typescript
import { getTenantContext } from "@/lib/tenant-context"

export async function getStudents() {
  const { schoolId } = await getTenantContext()

  if (!schoolId) throw new Error("No school context")

  return db.student.findMany({
    where: { schoolId }, // ALWAYS include schoolId!
  })
}
```

## OAuth Configuration

### Google Setup

1. Create project in Google Cloud Console
2. Enable OAuth consent screen
3. Add credentials (OAuth 2.0 Client ID)
4. Add callback URL: `https://ed.databayt.org/api/auth/callback/google`
5. Set environment variables

### Facebook Setup

1. Create app in Facebook Developer Console
2. Add "Facebook Login" product
3. Configure Valid OAuth Redirect URIs
4. Set app to "Live" mode
5. Set environment variables

## Environment Variables

```bash
# Core
AUTH_SECRET=your_secret_here
DATABASE_URL=postgresql://...

# OAuth
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
FACEBOOK_CLIENT_ID=
FACEBOOK_CLIENT_SECRET=

# Email
RESEND_API_KEY=

# URLs
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXTAUTH_URL=https://ed.databayt.org
```

## Cookie Configuration

Production cookies use `.databayt.org` domain for cross-subdomain SSO:

```typescript
cookies: {
  sessionToken: {
    name: "authjs.session-token",
    options: {
      httpOnly: true,
      sameSite: "lax",
      path: "/",
      secure: true,
      domain: ".databayt.org"
    }
  }
}
```

## Best Practices

### OAuth vs Credentials

| Scenario                  | Recommended Method          |
| ------------------------- | --------------------------- |
| Students self-registering | OAuth (Google/Facebook)     |
| Teachers self-registering | OAuth (Google/Facebook)     |
| Admin creating accounts   | Credentials (bulk import)   |
| Users without email       | Credentials (admin-created) |
| Quick onboarding          | OAuth                       |
| Full admin control        | Credentials                 |

**Recommendation**: Offer both options and let schools choose their preferred workflow.

### Security Checklist

- [x] Passwords hashed with bcrypt
- [x] JWT with 24h expiry
- [x] Secure cookies (httpOnly, sameSite, secure)
- [x] CSRF protection via NextAuth
- [x] schoolId isolation on all models
- [x] Role-based access control

### Best Practices Compliance (Verified 2025-12-17)

#### Security Standards

| Standard                | Status | Implementation                                                           |
| ----------------------- | ------ | ------------------------------------------------------------------------ |
| CSRF Protection         | âœ…     | State parameter + sameSite cookies (`authjs.csrf-token`, `authjs.state`) |
| PKCE                    | âœ…     | `pkceCodeVerifier` cookie with S256 code challenge method                |
| Origin Validation       | âœ…     | Callback URLs validated against baseUrl origin (auth.ts:761-814)         |
| XSS Prevention          | âœ…     | httpOnly cookies for all tokens (session, csrf, state, nonce)            |
| Session Security        | âœ…     | 24-hour JWT expiry, secure flag in production                            |
| Authorization Code Flow | âœ…     | `response_type=code` (not implicit)                                      |

#### Cookie Security Configuration

| Cookie                      | httpOnly | sameSite | secure | domain (prod)   |
| --------------------------- | -------- | -------- | ------ | --------------- |
| `authjs.session-token`      | âœ…       | lax      | âœ…     | `.databayt.org` |
| `authjs.csrf-token`         | âœ…       | lax      | âœ…     | `.databayt.org` |
| `authjs.pkce.code_verifier` | âœ…       | lax      | âœ…     | `.databayt.org` |
| `authjs.state`              | âœ…       | lax      | âœ…     | `.databayt.org` |
| `authjs.nonce`              | âœ…       | lax      | âœ…     | `.databayt.org` |
| `authjs.callback-url`       | âŒ       | lax      | âœ…     | `.databayt.org` |

#### Multi-Tenant Patterns

| Pattern                   | Status | Implementation                                                       |
| ------------------------- | ------ | -------------------------------------------------------------------- |
| Cross-subdomain SSO       | âœ…     | Cookie domain: `.databayt.org` (production only)                     |
| Tenant Isolation          | âœ…     | `schoolId` in JWT, validated in middleware and server actions        |
| Platform Admin Separation | âœ…     | DEVELOPER role â†’ main domain (`ed.databayt.org/dashboard`)           |
| Callback URL Preservation | âœ…     | 5-method fallback (query params â†’ httpOnly cookie â†’ session storage) |
| Context-aware Logout      | âœ…     | `LogoutButton` detects location, routes to appropriate public page   |

#### OAuth Provider Configuration

| Provider | Client ID          | Callback URL                                         | Status    |
| -------- | ------------------ | ---------------------------------------------------- | --------- |
| Google   | `861303536195-...` | `https://ed.databayt.org/api/auth/callback/google`   | âœ… Active |
| Facebook | Configured         | `https://ed.databayt.org/api/auth/callback/facebook` | âœ… Active |

#### References

- [OWASP OAuth 2.0 Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/OAuth2_Cheat_Sheet.html)
- [Auth.js v5 Documentation](https://authjs.dev/)
- [RFC 7636 - PKCE](https://datatracker.ietf.org/doc/html/rfc7636)

### Common Patterns

**Always include schoolId in queries**:

```typescript
// Good
db.student.findMany({ where: { schoolId, grade: "10" } })

// Bad - breaks tenant isolation!
db.student.findMany({ where: { grade: "10" } })
```

**Check role before sensitive operations**:

```typescript
const { role } = await getTenantContext()
if (role !== "ADMIN" && role !== "DEVELOPER") {
  throw new Error("Insufficient permissions")
}
```

## Debugging & Logging

### Debug Endpoint

Check authentication state and configuration at `/api/debug-auth`:

```bash
curl https://ed.databayt.org/api/debug-auth
```

Returns JSON with:

- Session info (userId, email, role, schoolId)
- Configuration validation status
- Auth-related cookies
- Provider status (Google, Facebook)
- Callback URLs
- Debugging hints

**Note**: This endpoint is at `/api/debug-auth` (not `/api/auth/debug`) to avoid conflicts with NextAuth's catch-all route.

### Centralized Logging

All auth operations are logged through `src/lib/auth-logger.ts`:

```typescript
import { authLogger } from "@/lib/auth-logger"

// Logging methods
authLogger.info("Message", { data }) // General info
authLogger.warn("Message", { data }) // Warnings
authLogger.error("Message", { data }) // Errors
authLogger.oauth("google", "step", data) // OAuth flow
authLogger.callback("signIn", { data }) // Callbacks
authLogger.session("action", { data }) // Session ops
authLogger.api("GET", "/path", { data }) // API requests
authLogger.exception("msg", error) // Exceptions with stack
authLogger.redirect(from, to, reason) // Redirects
```

### Configuration Validation

Environment variables are validated at startup via `src/lib/auth-config-validator.ts`:

```typescript
import { validateAuthConfig } from "@/lib/auth-config-validator"

const result = validateAuthConfig()
// Returns: { valid: boolean, issues: string[], warnings: string[], config: {...} }
```

Validates:

- `AUTH_SECRET` (required, min 32 chars)
- `GOOGLE_CLIENT_ID` & `GOOGLE_CLIENT_SECRET`
- `FACEBOOK_CLIENT_ID` & `FACEBOOK_CLIENT_SECRET`
- `NEXTAUTH_URL`
- `DATABASE_URL`

### Viewing Logs

**Local Development**:

```bash
pnpm dev 2>&1 | grep -E '\[AUTH|\[OAUTH'
```

**Vercel Production**:

```bash
vercel logs https://ed.databayt.org --output=short
```

### Log Format

```
[AUTH:INFO] Configuration validation PASSED
[OAUTH:GOOGLE] Profile callback received @ 2025-12-15T10:30:00.000Z
  { sub: "123...", email: "user@...", emailVerified: true }
[AUTH:CALLBACK:SIGNIN] @ 2025-12-15T10:30:05.000Z
  { provider: "google", userId: "xxx", hasProfile: true }
[AUTH:API] GET /api/auth/callback/google
  { action: "callback/google", status: 302 }
```

## Troubleshooting

### OAuth Issues

**redirect_uri_mismatch**: Callback URL in provider console doesn't match application

- Verify exact URL including protocol and port
- No trailing slashes

**access_denied**: User denied permission or app misconfigured

- Check OAuth consent screen
- Verify required scopes

**Configuration error**: Check the debug endpoint first

```bash
curl https://ed.databayt.org/api/debug-auth | jq '.config'
```

Common causes:

- Missing `AUTH_SECRET` or too short (< 32 chars)
- Missing OAuth credentials
- Invalid `NEXTAUTH_URL`

### Session Issues

**User not persisting**: Cookie not being set

- Check domain configuration
- Verify AUTH_SECRET is set

**Role not updating**: Session not refreshed

- Force session refresh after role change
- Check JWT callback

### Multi-Tenant Issues

**Wrong school context**: Query returning other school's data

- Always include schoolId in where clause
- Use getTenantContext()

## Roadmap

### Completed

1. ~~**Remove debug logging**~~ - Replaced with centralized `authLogger` utility
2. **Debug endpoint** - `/api/debug-auth` for checking auth state
3. **Configuration validation** - Environment vars validated at startup
4. **OAuth profile logging** - Google & Facebook callbacks log profile data
5. **Multi-tenant Prisma adapter** - Custom adapter handles `@@unique([email, schoolId])` constraint for OAuth

### Short-term (P1)

5. **Invitation system** - Schools invite users with pre-assigned roles
6. **School join codes** - Simple codes like "HOGWARTS-2024" for easy joining

### Medium-term (P2)

7. **Bulk user creation** - CSV import for students/teachers

## Testing

### E2E Test Coverage (Playwright)

Comprehensive end-to-end tests for all authentication flows. Located in `tests/auth/`.

#### Test Files

| Test File                  | Tests | Description                              |
| -------------------------- | ----- | ---------------------------------------- |
| `helpers.ts`               | -     | Shared utilities and test credentials    |
| `marketing-login.spec.ts`  | 14    | Login from ed.databayt.org               |
| `school-login.spec.ts`     | 15    | Login from school subdomains             |
| `logout.spec.ts`           | 9     | Context-aware logout behavior            |
| `oauth.spec.ts`            | 10    | OAuth flow initiation and error handling |
| `protected-routes.spec.ts` | 13    | Route protection and role-based access   |

#### Running E2E Tests

```bash
# Local development (default)
pnpm test:e2e

# Specific test file
pnpm test:e2e tests/auth/marketing-login.spec.ts

# Production testing
TEST_ENV=production pnpm test:e2e --project=production-chromium

# UI mode for debugging
pnpm test:e2e:ui
```

#### Test Credentials

Test credentials from `prisma/seeds/constants.ts`:

| Role       | Email                     | Password | School |
| ---------- | ------------------------- | -------- | ------ |
| DEVELOPER  | `dev@databayt.org`        | `1234`   | -      |
| ADMIN      | `admin@databayt.org`      | `1234`   | demo   |
| ACCOUNTANT | `accountant@databayt.org` | `1234`   | demo   |
| STAFF      | `staff@databayt.org`      | `1234`   | demo   |
| TEACHER    | `teacher@databayt.org`    | `1234`   | demo   |
| STUDENT    | `student@databayt.org`    | `1234`   | demo   |
| PARENT     | `parent@databayt.org`     | `1234`   | demo   |

#### Multi-Environment Testing

The Playwright config supports both local and production:

- **Local projects**: `chromium`, `firefox`, `webkit`, `mobile-chrome`, `mobile-safari`
- **Production projects**: `production-chromium`, `production-firefox`, etc.

```typescript
// playwright.config.ts
const isProduction = process.env.TEST_ENV === "production"
const baseURL = isProduction
  ? "https://ed.databayt.org"
  : "https://localhost:3000"
```

### Unit Test Coverage

The authentication module has **123 unit tests** covering:

| Test File              | Tests | Description                                          |
| ---------------------- | ----- | ---------------------------------------------------- |
| `validation.test.ts`   | 49    | Zod schema validation for all auth forms             |
| `user.test.ts`         | 22    | User utilities and multi-tenant safety               |
| `tokens.test.ts`       | 16    | Token generation (2FA, password reset, verification) |
| `login/action.test.ts` | 24    | Login flow with 2FA and smart redirect               |
| `join/action.test.ts`  | 12    | Registration and multi-tenant isolation              |

### Running Auth Tests

```bash
# Run all auth tests
pnpm test src/components/auth/__tests__

# Run specific test file
pnpm test src/components/auth/__tests__/validation.test.ts

# Run with watch mode
pnpm test src/components/auth/__tests__ --watch
```

### Known Issues (Documented in Tests)

The test suite documents multi-tenant considerations:

1. ~~**`getUserByEmail` not tenant-scoped**~~ - **FIXED**: Custom `MultiTenantPrismaAdapter` queries with `{ email, schoolId: null }` for OAuth users
2. **OAuth users created without schoolId** - By design: New OAuth users exist in limbo until onboarding completes
3. **Registration lacks school context** - By design: Users join schools through onboarding or invitation flow

See [ISSUE.md](/src/components/auth/ISSUE.md) for current test status.

## Related Documentation

- [Onboarding](/docs/onboarding) - School creation flow
- [Architecture](/docs/architecture) - System design
- [Multi-Tenant Safety](/docs/multi-tenant) - Data isolation

---

This authentication system provides enterprise-grade security with flexibility for different school management workflows.
