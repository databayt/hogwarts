---
title: "Database"
description: "Multi-tenant PostgreSQL database architecture with Prisma ORM, row-level security, and domain-based tenant isolation"
---

The database is engineered as a **multi-tenant school management system** that supports multiple schools in a single database with complete data isolation. Built on PostgreSQL with Prisma ORM, it provides a robust foundation for educational institutions while maintaining strict security boundaries between tenants.

## Core Principles

Our database design is guided by fundamental principles that ensure scalability, security, and maintainability:

- **Row-Level Security** – Every model includes a `schoolId` field ensuring complete data isolation between schools
- **Shared Schema Architecture** – All schools use the same database schema, optimizing resource utilization
- **Domain-Based Tenant Identification** – Schools are uniquely identified by subdomain (e.g., `demo.databayt.org`), with optional custom domains via CNAME
- **Type-Safe Database Operations** – Prisma ORM provides end-to-end type safety from database to frontend
- **Multi-File Schema Organization** – Schema is organized into logical domains for better maintainability
- **Single-Language Storage** – Content stored in one language with a `lang` field; translation happens on-demand via Google Translate API with database caching

## Database Design

The database follows a comprehensive relational design that captures all aspects of school management from core infrastructure to daily operations.

<img src="/database.png" alt="Database Schema Diagram" />

The entity relationship diagram above illustrates the interconnected nature of our school management system, showing how entities relate through foreign key relationships while maintaining multi-tenant isolation through the `schoolId` field present in every table.

## Multi-Tenant Isolation Strategy

The tenant isolation strategy ensures that each school's data remains completely separate while sharing the same database infrastructure.

### Tenant Entity (School Model)

```typescript
model School {
  id                String  @id @default(cuid())
  name              String
  domain            String  @unique // e.g., "demo"
  preferredLanguage String  @default("ar") // Admin's chosen content language
  logoUrl           String?
  address           String?
  phoneNumber       String?
  email             String?
  timezone          String  @default("UTC")

  // Subscription/billing
  planType    String  @default("basic")
  maxStudents Int     @default(100)
  maxTeachers Int     @default(10)
  isActive    Boolean @default(true)
}
```

### Data Isolation Example

```typescript
// Correct - Always include schoolId
const students = await prisma.student.findMany({
  where: { schoolId: "school_123" },
})

// Wrong - Missing schoolId (security risk)
const students = await prisma.student.findMany()
```

## Directory Structure

The Prisma directory follows a well-organized structure that supports both development and production scenarios with clear separation of concerns.

<PrismaStructure />

## Schema Tables

Each model contains realistic sample data that demonstrates the relationships and data structure of our multi-tenant school management system. The demo school uses Arabic as its primary content language with on-demand translation.

### School (Tenant Entity)

The demo school representing a Sudanese K-12 academy.

| ID        | School Name | Domain | Preferred Language | Plan    | Active |
| --------- | ----------- | ------ | ------------------ | ------- | ------ |
| `sch_001` | Demo School | demo   | ar                 | premium | Yes    |

### Teacher

Teaching staff with Arabic names and department assignments. 100 teachers across 6 departments.

| ID        | School ID | Given Name | Surname | Email                 | Gender |
| --------- | --------- | ---------- | ------- | --------------------- | ------ |
| `tch_001` | `sch_001` | Ahmed      | Hassan  | teacher@databayt.org  | M      |
| `tch_002` | `sch_001` | Fatima     | Ali     | teacher1@databayt.org | F      |
| `tch_003` | `sch_001` | Mohamed    | Ibrahim | teacher2@databayt.org | M      |

### Student

970 students across KG1-Grade 12 with guardian relationships.

| ID        | School ID | Given Name | Surname | GR Number | Gender |
| --------- | --------- | ---------- | ------- | --------- | ------ |
| `std_001` | `sch_001` | Omar       | Hassan  | GR-0001   | M      |
| `std_002` | `sch_001` | Amira      | Ali     | GR-0002   | F      |
| `std_003` | `sch_001` | Khalid     | Mohamed | GR-0003   | M      |

### Department

6 academic departments with single-language storage (Arabic primary + `lang` field).

| ID        | School ID | Department Name | Lang |
| --------- | --------- | --------------- | ---- |
| `dep_001` | `sch_001` | Languages       | ar   |
| `dep_002` | `sch_001` | Sciences        | ar   |
| `dep_003` | `sch_001` | Humanities      | ar   |

### Subject

19 academic subjects within departments, stored in Arabic with on-demand translation.

| ID        | School ID | Department ID | Subject Name | Lang |
| --------- | --------- | ------------- | ------------ | ---- |
| `sub_001` | `sch_001` | `dep_001`     | Arabic       | ar   |
| `sub_002` | `sch_001` | `dep_002`     | Mathematics  | ar   |
| `sub_003` | `sch_001` | `dep_002`     | Physics      | ar   |

### Classroom

28 physical classroom locations across 5 buildings.

| ID        | School ID | Room Name     | Capacity | Type      |
| --------- | --------- | ------------- | -------- | --------- |
| `cls_001` | `sch_001` | Assembly Hall | 300      | Hall      |
| `cls_002` | `sch_001` | Science Lab 1 | 30       | Lab       |
| `cls_003` | `sch_001` | Room 101      | 35       | Classroom |

### User (Authentication)

Multi-tenant user accounts with role-based access control and school isolation.

| ID        | Email                | Role      | School ID          | Verified |
| --------- | -------------------- | --------- | ------------------ | -------- |
| `usr_001` | dev@databayt.org     | DEVELOPER | null (all schools) | Yes      |
| `usr_002` | admin@databayt.org   | ADMIN     | `sch_001`          | Yes      |
| `usr_003` | teacher@databayt.org | TEACHER   | `sch_001`          | Yes      |

## Subscription & Pricing

The subscription system supports tiered pricing plans with flexible discounting capabilities.

### Subscription & Pricing Models

```typescript
model SubscriptionTier {
  id                String   @id @default(cuid())
  name              String   // basic, premium, enterprise
  description       String
  monthlyPrice      Int     // Price in cents
  annualPrice       Int     // Price in cents
  maxStudents       Int
  maxTeachers       Int
  maxClasses        Int
  features          String[] // Array of feature identifiers
  isActive          Boolean  @default(true)

  // Relationships
  subscriptions     Subscription[]
  discounts         Discount[]
}

model Discount {
  id                String   @id @default(cuid())
  schoolId          String
  tierId            String
  code              String   @unique
  type              String   // percentage, fixed
  value             Int      // Percentage or fixed amount
  description       String
  validFrom         DateTime
  validUntil        DateTime
  maxUses           Int?
  currentUses       Int      @default(0)
  isActive          Boolean  @default(true)

  // Relationships
  school            School           @relation(fields: [schoolId], references: [id])
  subscriptionTier  SubscriptionTier @relation(fields: [tierId], references: [id])
  appliedDiscounts  AppliedDiscount[]
}

model AppliedDiscount {
  id          String   @id @default(cuid())
  schoolId    String
  discountId  String
  invoiceId   String
  amount      Int      // Amount saved in cents
  appliedAt   DateTime @default(now())

  // Relationships
  school      School   @relation(fields: [schoolId], references: [id])
  discount    Discount @relation(fields: [discountId], references: [id])
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
}
```

**Key Features:**

- Tiered subscription plans with different limits and features
- Flexible discount system supporting both percentage and fixed amounts
- Usage tracking for limited-use discount codes
- Complete audit trail of applied discounts
- Multi-tenant safety with schoolId scoping

### Example Usage

```typescript
// Create a new subscription tier
const tier = await prisma.subscriptionTier.create({
  data: {
    name: "premium",
    description: "Premium school plan",
    monthlyPrice: 19900, // $199.00
    annualPrice: 199900, // $1,999.00
    maxStudents: 500,
    maxTeachers: 50,
    maxClasses: 100,
    features: ["analytics", "api_access", "priority_support"],
  },
})

// Create a discount code
const discount = await prisma.discount.create({
  data: {
    schoolId: "school_123",
    tierId: tier.id,
    code: "WELCOME2024",
    type: "percentage",
    value: 20, // 20% off
    description: "New year promotion",
    validFrom: new Date(),
    validUntil: new Date("2024-12-31"),
    maxUses: 100,
  },
})
```

## Legal & Compliance

The legal system provides comprehensive consent tracking and compliance logging.

### Legal & Compliance Models

```typescript
model LegalConsent {
  id                String   @id @default(cuid())
  schoolId          String
  userId            String
  documentType      String   // terms, privacy, data-processing
  documentVersion   String   // Version consented to
  consentType       String   // explicit, implicit, parental
  ipAddress         String?
  userAgent         String?
  consentedAt       DateTime @default(now())
  revokedAt         DateTime?
  metadata          Json?

  // Relationships
  school            School   @relation(fields: [schoolId], references: [id])
  user              User     @relation(fields: [userId], references: [id])

  @@unique([schoolId, userId, documentType, documentVersion])
}

model LegalDocument {
  id                String   @id @default(cuid())
  schoolId          String
  type              String   // terms, privacy, data-processing
  version           String   // Semantic version
  content           String   @db.Text
  effectiveFrom     DateTime
  effectiveUntil    DateTime?
  isActive          Boolean  @default(true)
  requiresExplicit  Boolean  @default(true)
  metadata          Json?

  // Relationships
  school            School   @relation(fields: [schoolId], references: [id])
}

model ComplianceLog {
  id                String   @id @default(cuid())
  schoolId          String
  eventType         String   // consent events, document updates
  eventData         Json
  userId            String?
  timestamp         DateTime @default(now())
  metadata          Json?

  // Relationships
  school            School   @relation(fields: [schoolId], references: [id])
  user              User?    @relation(fields: [userId], references: [id])
}
```

**Key Features:**

- Comprehensive consent tracking with version control
- Support for multiple document types and consent types
- Audit trail with detailed event logging
- GDPR-compliant consent evidence collection
- Multi-tenant safety with schoolId scoping

### Example Usage

```typescript
// Record user consent
const consent = await prisma.legalConsent.create({
  data: {
    schoolId: "school_123",
    userId: "user_456",
    documentType: "terms",
    documentVersion: "1.0.0",
    consentType: "explicit",
    ipAddress: "192.168.1.1",
    userAgent: "Mozilla/5.0...",
    metadata: {
      source: "onboarding",
      platform: "web",
    },
  },
})

// Log compliance event
await prisma.complianceLog.create({
  data: {
    schoolId: "school_123",
    eventType: "consent-given",
    eventData: {
      documentType: "terms",
      version: "1.0.0",
      consentId: consent.id,
    },
    userId: "user_456",
  },
})
```

## Authentication & User Roles

The system supports **8 distinct user roles** with varying levels of access and school-specific constraints.

| Role       | Description               | School Access | Typical Use Case                            |
| ---------- | ------------------------- | ------------- | ------------------------------------------- |
| DEVELOPER  | Platform administrator    | All schools   | System maintenance, cross-tenant operations |
| ADMIN      | School administrator      | Single school | School management, user oversight           |
| TEACHER    | Teaching staff            | Single school | Class management, grading, attendance       |
| STUDENT    | Enrolled students         | Single school | Learning management, assignment submission  |
| GUARDIAN   | Student parents/guardians | Single school | Monitor child's progress, communication     |
| ACCOUNTANT | Finance staff             | Single school | Billing, financial reporting                |
| STAFF      | General school staff      | Single school | Administrative support                      |
| USER       | Default role              | Single school | Base level access                           |

## Security & Data Protection

### Automatic Tenant Filtering

Every database query must include the `schoolId` to ensure proper data isolation:

```typescript
// Server action with tenant context
export async function getStudents() {
  const schoolId = getSchoolId() // From middleware context

  return await prisma.student.findMany({
    where: { schoolId },
  })
}
```

### Unique Constraints with School Scope

All unique constraints include `schoolId` to allow data duplication across schools:

```typescript
// Teachers can have same email across different schools
@@unique([schoolId, emailAddress])

// Departments can have same names across schools
@@unique([schoolId, departmentName])
```

## Performance Optimization

### Recommended Database Indexes

```sql
-- Critical indexes for multi-tenant queries
CREATE INDEX idx_students_school_id ON students(school_id);
CREATE INDEX idx_teachers_school_id ON teachers(school_id);
CREATE INDEX idx_classes_school_id ON classes(school_id);
CREATE INDEX idx_attendance_school_id ON attendance(school_id);
```

### Query Performance Guidelines

- Always filter by `schoolId` first in WHERE clauses
- Use composite indexes for frequently queried field combinations
- Implement connection pooling for high-traffic scenarios
- Consider read replicas for reporting and analytics

## Deployment Configuration

### Environment Variables

```bash
# Database Connection
DATABASE_URL="postgresql://username:password@host:port/database"

# Multi-tenancy Configuration
DEFAULT_SCHOOL_DOMAIN="demo"
ALLOW_SCHOOL_SIGNUP="true"

# Subscription Limits
BASIC_MAX_STUDENTS=100
PREMIUM_MAX_STUDENTS=500
ENTERPRISE_MAX_STUDENTS=2000
```

### Migration Commands

```bash
# Generate Prisma Client
pnpm prisma generate

# Create and apply migrations
pnpm prisma migrate dev --name init

# Deploy to production
pnpm prisma migrate deploy

# Seed sample data
pnpm prisma db seed
```

## Single-Language Storage with On-Demand Translation

Content is stored in **one language** with a `lang` field. When a user views content in a different locale, translation happens on-demand via Google Translate API with database caching.

### Storage Pattern

```prisma
model Announcement {
  title String?
  body  String? @db.Text
  lang  String  @default("ar") // "ar" or "en"
}
```

### Translation Cache

```prisma
model TranslationCache {
  id             String   @id @default(cuid())
  schoolId       String
  sourceText     String   @db.Text
  sourceLanguage String   // "ar" or "en"
  targetLanguage String   // "ar" or "en"
  translatedText String   @db.Text
  provider       String   @default("google")
  hitCount       Int      @default(0)
  lastAccessedAt DateTime @default(now())

  @@unique([schoolId, sourceText, sourceLanguage, targetLanguage])
  @@index([schoolId, sourceLanguage, targetLanguage])
  @@index([lastAccessedAt])
}
```

### Translation Flow

```typescript
import { getDisplayText } from "@/lib/content-display"

// Content stored in Arabic, user viewing in English
const title = await getDisplayText("مرحبا", "ar", "en", schoolId)
// Returns "Hello" (translated and cached)

// Same language - no API call
const title = await getDisplayText("مرحبا", "ar", "ar", schoolId)
// Returns "مرحبا" directly
```

### Models Using `lang` Field

| Model                 | Content Fields                       | Default Lang |
| --------------------- | ------------------------------------ | ------------ |
| Announcement          | title, body                          | ar           |
| AnnouncementTemplate  | title, body                          | ar           |
| NotificationTemplate  | title, body, emailSubject, emailBody | ar           |
| Subject               | subjectName                          | ar           |
| Class                 | name                                 | ar           |
| YearLevel             | levelName                            | ar           |
| Department            | departmentName                       | ar           |
| AttendanceBadge       | name, description                    | ar           |
| AttendanceCompetition | name                                 | ar           |
| StreamCourse          | title                                | en           |
| StreamCategory        | name                                 | en           |

## Demo School & Test Data

The seeding system creates a **single demo school** (`demo.databayt.org`) with a complete K-12 Sudanese school simulation:

| Entity      | Count  | Notes                               |
| ----------- | ------ | ----------------------------------- |
| Users       | 3,104  | All roles with @databayt.org emails |
| Teachers    | 100    | Arabic names, 6 departments         |
| Students    | 970    | KG1-Grade 12 distribution           |
| Guardians   | ~1,940 | 2 per student                       |
| Departments | 6      | Arabic primary + lang field         |
| Subjects    | 19     | Arabic primary + lang field         |
| Year Levels | 14     | KG1-12                              |
| Classrooms  | 28     | Labs, rooms, special facilities     |
| Classes     | 187    | Subject-level combinations          |

This comprehensive database architecture provides the foundation for building scalable, secure, and feature-rich educational management systems.
