---
title: "Database"
description: "Multi-tenant PostgreSQL database architecture with Prisma ORM — 264 models, 132 enums, 57 schema files"
---

The database is engineered as a **multi-tenant school management system** supporting multiple schools in a single PostgreSQL database with complete data isolation. Built with Prisma ORM across **264 models**, **132 enums**, and **57 schema files**, it provides a comprehensive foundation for K-12 educational institutions while maintaining strict security boundaries between tenants.

## Core Principles

- **Row-Level Security** -- Every model includes a `schoolId` field ensuring complete data isolation between schools
- **Shared Schema Architecture** -- All schools use the same database schema, optimizing resource utilization
- **Domain-Based Tenant Identification** -- Schools are uniquely identified by subdomain (e.g., `demo.databayt.org`), with optional custom domains via CNAME
- **Type-Safe Database Operations** -- Prisma ORM provides end-to-end type safety from database to frontend
- **Multi-File Schema Organization** -- Schema is organized into 57 logical domain files for maintainability
- **Single-Language Storage** -- Content stored in one language with a `lang` field; translation happens on-demand via Google Translate API with database caching

## Database Design

The database follows a comprehensive relational design that captures all aspects of school management from core infrastructure to daily operations.

<img src="/database.png" alt="Database Schema Diagram" />

The entity relationship diagram above illustrates the interconnected nature of the school management system, showing how entities relate through foreign key relationships while maintaining multi-tenant isolation through the `schoolId` field present in every table.

## Multi-Tenant Isolation Strategy

The tenant isolation strategy ensures that each school's data remains completely separate while sharing the same database infrastructure.

### Tenant Entity (School Model)

```prisma
model School {
  id          String   @id @default(cuid())
  name        String
  domain      String   @unique // e.g., "demo"
  preferredLanguage String @default("ar")
  logoUrl     String?
  address     String?
  phoneNumber String?
  email       String?
  timezone    String   @default("Africa/Khartoum")

  // School classification
  schoolType  String? // private, public, international, technical, special
  schoolLevel String? // primary, secondary, both
  system      String? // clickview, national, british, ib

  // Subscription/billing
  planType    String  @default("basic")
  maxStudents Int     @default(100)
  maxTeachers Int     @default(10)
  isActive    Boolean @default(true)
}
```

### Data Isolation Example

```typescript
// Correct - Always include schoolId
const students = await prisma.student.findMany({
  where: { schoolId: "school_123" },
})

// Wrong - Missing schoolId (security risk)
const students = await prisma.student.findMany()
```

## Schema Overview

The 264 models are organized across 57 `.prisma` files in `prisma/models/`, grouped by domain.

| Category             | Models | Enums | Prisma Files                                                                     | Key Tables                                                         |
| -------------------- | ------ | ----- | -------------------------------------------------------------------------------- | ------------------------------------------------------------------ |
| Core                 | 7      | 0     | school.prisma                                                                    | School, Subscription, Invoice, SchoolYear, Period, Term, YearLevel |
| Auth and Users       | 6      | 1     | auth.prisma                                                                      | User, Account, VerificationToken, TwoFactorConfirmation            |
| People               | 32     | 4     | students.prisma, staff.prisma, staff-member.prisma, profile.prisma               | Student, Guardian, Teacher, Department, StaffMember                |
| Academic Structure   | 13     | 3     | academic-structure.prisma, subjects.prisma, classrooms.prisma, enrollment.prisma | Subject, Class, Classroom, AcademicLevel, AcademicGrade            |
| Catalog (Global)     | 9      | 5     | catalog.prisma, catalog-bridge.prisma + 3 more                                   | CatalogSubject, CatalogChapter, CatalogLesson, CatalogExam         |
| Attendance           | 29     | 18    | attendance.prisma, attendance-enhanced.prisma, geo-attendance.prisma             | Attendance, AttendanceBadge, GeoFence, BiometricTemplate           |
| Exams and Assessment | 44     | 29    | exam.prisma, qbank.prisma, assessments.prisma + 6 more                           | Exam, ExamResult, QuestionBank, QuizGame, GradingScheme            |
| Finance              | 40     | 24    | finance-core.prisma + 6 more                                                     | ChartOfAccount, Payment, PayrollRun, Budget, FeeStructure          |
| Messaging            | 10     | 3     | messages.prisma                                                                  | Conversation, Message, MessageReaction, PinnedMessage              |
| Admission            | 9      | 8     | admission.prisma                                                                 | AdmissionCampaign, Application, TourBooking, AdmissionOTP          |
| Stream/LMS           | 8      | 3     | stream.prisma                                                                    | StreamCourse, StreamCategory, StreamEnrollment                     |
| Timetable            | 10     | 0     | timetable.prisma, schedule.prisma                                                | Timetable, TeacherConstraint, SubstitutionRecord                   |
| Other                | 47     | 34    | notifications.prisma, events.prisma, library.prisma + 15 more                    | Announcement, Notification, Book, FileMetadata, AuditLog           |

Catalog models are intentionally **without schoolId** -- they represent platform-wide educational content (ClickView-sourced) shared across all schools via the bridge pattern. See [Catalog](/docs/catalog) and [Integration Flow](/docs/integration-flow) for details.

### Dual LMS Architecture

The platform operates two parallel content systems:

| System      | Scope                         | Models                                                       | Content Source            |
| ----------- | ----------------------------- | ------------------------------------------------------------ | ------------------------- |
| **Stream**  | School-scoped (`schoolId`)    | StreamCourse, StreamCategory, StreamEnrollment, StreamLesson | School-created courses    |
| **Catalog** | Platform-wide (no `schoolId`) | CatalogSubject, CatalogChapter, CatalogLesson, CatalogExam   | ClickView/curated content |

The `SchoolSubjectSelection` bridge model connects catalog content to school-specific academic structure, allowing each school to select which platform-wide subjects they use. `SchoolContentOverride` lets schools customize catalog content without modifying the shared originals.

## Subscription and Pricing

The subscription system supports tiered pricing plans with flexible discounting capabilities.

```prisma
model SubscriptionTier {
  id                String   @id @default(cuid())
  name              String   // basic, premium, enterprise
  description       String
  monthlyPrice      Int      // Price in cents
  annualPrice       Int      // Price in cents
  maxStudents       Int
  maxTeachers       Int
  maxClasses        Int
  features          String[] // Array of feature identifiers
  isActive          Boolean  @default(true)

  subscriptions     Subscription[]
  discounts         Discount[]
}

model Discount {
  id                String   @id @default(cuid())
  schoolId          String
  tierId            String
  code              String   @unique
  type              String   // percentage, fixed
  value             Int
  description       String
  validFrom         DateTime
  validUntil        DateTime
  maxUses           Int?
  currentUses       Int      @default(0)
  isActive          Boolean  @default(true)

  school            School           @relation(fields: [schoolId], references: [id])
  subscriptionTier  SubscriptionTier @relation(fields: [tierId], references: [id])
  appliedDiscounts  AppliedDiscount[]
}
```

The subscription module also includes `BillingPaymentMethod`, `BillingHistory`, `UsageMetrics`, `CreditNote`, and `BillingPreferences` models for complete billing lifecycle management.

## Legal and Compliance

The legal system provides comprehensive consent tracking and compliance logging.

```prisma
model LegalConsent {
  id                String   @id @default(cuid())
  schoolId          String
  userId            String
  documentType      String   // terms, privacy, data-processing
  documentVersion   String
  consentType       String   // explicit, implicit, parental
  ipAddress         String?
  userAgent         String?
  consentedAt       DateTime @default(now())
  revokedAt         DateTime?
  metadata          Json?

  school            School   @relation(fields: [schoolId], references: [id])
  user              User     @relation(fields: [userId], references: [id])

  @@unique([schoolId, userId, documentType, documentVersion])
}

model LegalDocument {
  id                String   @id @default(cuid())
  schoolId          String
  type              String   // terms, privacy, data-processing
  version           String
  content           String   @db.Text
  effectiveFrom     DateTime
  effectiveUntil    DateTime?
  isActive          Boolean  @default(true)
  requiresExplicit  Boolean  @default(true)

  school            School   @relation(fields: [schoolId], references: [id])
}

model ComplianceLog {
  id                String   @id @default(cuid())
  schoolId          String
  eventType         String
  eventData         Json
  userId            String?
  timestamp         DateTime @default(now())

  school            School   @relation(fields: [schoolId], references: [id])
  user              User?    @relation(fields: [userId], references: [id])
}
```

## Authentication and User Roles

The system supports **8 distinct user roles** with varying levels of access and school-specific constraints.

| Role       | Description               | School Access | Typical Use Case                            |
| ---------- | ------------------------- | ------------- | ------------------------------------------- |
| DEVELOPER  | Platform administrator    | All schools   | System maintenance, cross-tenant operations |
| ADMIN      | School administrator      | Single school | School management, user oversight           |
| TEACHER    | Teaching staff            | Single school | Class management, grading, attendance       |
| STUDENT    | Enrolled students         | Single school | Learning management, assignment submission  |
| GUARDIAN   | Student parents/guardians | Single school | Monitor child's progress, communication     |
| ACCOUNTANT | Finance staff             | Single school | Billing, financial reporting                |
| STAFF      | General school staff      | Single school | Administrative support                      |
| USER       | Default role              | None          | Base level access, onboarding               |

## Security and Data Protection

### Automatic Tenant Filtering

Every database query must include the `schoolId` to ensure proper data isolation:

```typescript
// Server action with tenant context
export async function getStudents() {
  const schoolId = getSchoolId() // From middleware context

  return await prisma.student.findMany({
    where: { schoolId },
  })
}
```

### Unique Constraints with School Scope

All unique constraints include `schoolId` to allow data duplication across schools:

```prisma
// Teachers can have same email across different schools
@@unique([schoolId, emailAddress])

// Departments can have same names across schools
@@unique([schoolId, departmentName])
```

## Performance Optimization

### Recommended Database Indexes

```sql
-- Critical indexes for multi-tenant queries
CREATE INDEX idx_students_school_id ON students(school_id);
CREATE INDEX idx_teachers_school_id ON teachers(school_id);
CREATE INDEX idx_classes_school_id ON classes(school_id);
CREATE INDEX idx_attendance_school_id ON attendance(school_id);
```

### Query Performance Guidelines

- Always filter by `schoolId` first in WHERE clauses
- Use composite indexes for frequently queried field combinations
- Implement connection pooling for high-traffic scenarios
- Consider read replicas for reporting and analytics

## Deployment Configuration

### Environment Variables

```bash
# Database Connection
DATABASE_URL="postgresql://username:password@host:port/database"

# Multi-tenancy Configuration
DEFAULT_SCHOOL_DOMAIN="demo"
ALLOW_SCHOOL_SIGNUP="true"

# Subscription Limits
BASIC_MAX_STUDENTS=100
PREMIUM_MAX_STUDENTS=500
ENTERPRISE_MAX_STUDENTS=2000
```

### Migration Commands

```bash
# Generate Prisma Client
pnpm prisma generate

# Create and apply migrations
pnpm prisma migrate dev --name init

# Deploy to production
pnpm prisma migrate deploy

# Seed specific module (ALWAYS use this)
pnpm db:seed:single <name>
```

## Single-Language Storage with On-Demand Translation

Content is stored in **one language** with a `lang` field. When a user views content in a different locale, translation happens on-demand via Google Translate API with database caching.

### Storage Pattern

```prisma
model Announcement {
  title String?
  body  String? @db.Text
  lang  String  @default("ar") // "ar" or "en"
}
```

### Translation Cache

```prisma
model TranslationCache {
  id             String   @id @default(cuid())
  schoolId       String
  sourceText     String   @db.Text
  sourceLanguage String   // "ar" or "en"
  targetLanguage String   // "ar" or "en"
  translatedText String   @db.Text
  provider       String   @default("google")
  hitCount       Int      @default(0)
  lastAccessedAt DateTime @default(now())

  @@unique([schoolId, sourceText, sourceLanguage, targetLanguage])
  @@index([schoolId, sourceLanguage, targetLanguage])
  @@index([lastAccessedAt])
}
```

### Translation Flow

```typescript
import { getDisplayText } from "@/lib/content-display"

// Content stored in Arabic, user viewing in English
const title = await getDisplayText("مرحبا", "ar", "en", schoolId)
// Returns "Hello" (translated and cached)

// Same language - no API call
const title = await getDisplayText("مرحبا", "ar", "ar", schoolId)
// Returns "مرحبا" directly
```

### Models Using `lang` Field

| Model                 | Content Fields     | Default Lang |
| --------------------- | ------------------ | ------------ |
| Announcement          | title, body        | ar           |
| AnnouncementTemplate  | title, body        | ar           |
| NotificationTemplate  | title, body        | ar           |
| Subject               | subjectName        | ar           |
| Class                 | name               | ar           |
| YearLevel             | levelName          | ar           |
| Department            | departmentName     | ar           |
| AcademicLevel         | name               | ar           |
| AcademicGrade         | name               | ar           |
| AcademicStream        | name               | ar           |
| AttendanceBadge       | name, description  | ar           |
| AttendanceCompetition | name               | ar           |
| CatalogSubject        | name               | ar           |
| CatalogChapter        | name               | ar           |
| CatalogLesson         | name               | ar           |
| CatalogExam           | title, description | ar           |
| CatalogMaterial       | title, description | ar           |
| CatalogAssignment     | title, description | ar           |
| CurriculumStandard    | name, description  | ar           |
| GradingScheme         | name               | ar           |
| QuickAssessment       | title              | ar           |
| LessonVideo           | title, description | ar           |
| StreamCourse          | title              | en           |
| StreamCategory        | name               | en           |

## Demo School and Test Data

The seeding system creates a **single demo school** (`demo.databayt.org`) with a complete K-12 Sudanese school simulation. See [Seeds](/docs/safe-seeds) for full seed details.

| Entity      | Count  | Notes                               |
| ----------- | ------ | ----------------------------------- |
| Users       | 3,105  | All roles with @databayt.org emails |
| Teachers    | 100    | Arabic names, 6 departments         |
| Students    | 970    | KG1-Grade 12 distribution           |
| Guardians   | ~1,940 | 2 per student                       |
| Departments | 6      | Arabic primary + lang field         |
| Subjects    | 19     | Arabic primary + lang field         |
| Year Levels | 14     | KG1-12                              |
| Classrooms  | 28     | Labs, rooms, special facilities     |
| Classes     | 187    | Subject-level combinations          |
