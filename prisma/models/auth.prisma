// Auth Models
enum UserRole {
  DEVELOPER // Platform admin (across all schools)
  ADMIN // School admin
  TEACHER
  STUDENT
  GUARDIAN
  ACCOUNTANT // School accountant/finance
  STAFF // General school staff
  USER // General user
}

model User {
  id            String    @id @default(cuid())
  username      String?
  email         String?
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole  @default(USER)

  // Multi-tenant fields
  schoolId String? // null for DEVELOPER
  school   School? @relation(fields: [schoolId], references: [id])

  accounts              Account[]
  isTwoFactorEnabled    Boolean                @default(false)
  twoFactorConfirmation TwoFactorConfirmation?

  // School relationships
  student  Student?
  teacher  Teacher?
  guardian Guardian?

  // Stripe subscription fields (user-scoped for compatibility with pricing UI)
  stripeSubscriptionId   String?
  stripeCustomerId       String?
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // User-scoped invoicing (standalone invoice block)
  userInvoices        UserInvoice[]
  userInvoiceSettings UserInvoiceSettings?

  // Legal relations
  legalConsents  LegalConsent[]
  complianceLogs ComplianceLog[]

  // Stream (LMS) relations
  streamCourses        StreamCourse[]         @relation("UserCourses")
  streamEnrollments    StreamEnrollment[]
  streamLessonProgress StreamLessonProgress[]
  streamCertificates   StreamCertificate[]

  // Library relations
  borrowRecords BorrowRecord[]

  // Banking relations
  bankAccounts    BankAccount[]    @relation("UserBankAccounts")
  plaidItems      PlaidItem[]      @relation("UserPlaidItems")
  dwollaCustomers DwollaCustomer[] @relation("UserDwollaCustomers")

  // Billing relations
  billingPaymentMethods BillingPaymentMethod[]
  billingHistory        BillingHistory[]
  creditNotes           CreditNote[]

  // Receipt tracking relations
  expenseReceipts ExpenseReceipt[]

  // Theme customization
  themes UserTheme[]

  // Quiz relations
  quizGames         QuizGame[]
  quizCategoryStats QuizCategoryStats[]
  quizAchievements  QuizAchievement[]
  quizLeaderboards  QuizLeaderboard[]

  // Finance permissions
  financePermissions FinancePermission[]

  // QBank automation relations
  questionReviews QuestionReview[]

  // Announcement relations
  createdAnnouncements      Announcement[]             @relation("AnnouncementCreator")
  announcementReads         AnnouncementRead[]         @relation("AnnouncementReads")
  announcementNotifications AnnouncementNotification[] @relation("AnnouncementNotifications")
  announcementTemplates     AnnouncementTemplate[]     @relation("TemplateCreator")

  // Notification relations
  notifications             Notification[]             @relation("UserNotifications")
  notificationActors        Notification[]             @relation("NotificationActors")
  notificationPreferences   NotificationPreference[]   @relation("UserNotificationPreferences")
  notificationBatches       NotificationBatch[]        @relation("NotificationBatchCreator")
  notificationSubscriptions NotificationSubscription[] @relation("UserNotificationSubscriptions")
  notificationSummaries     NotificationSummary[]      @relation("UserNotificationSummaries")

  // Messaging relations
  conversationParticipants    ConversationParticipant[] @relation("ConversationParticipants")
  messagesSent                Message[]                 @relation("MessagesSent")
  messageReactions            MessageReaction[]         @relation("MessageReactions")
  messageReadReceipts         MessageReadReceipt[]      @relation("MessageReadReceipts")
  typingIndicators            TypingIndicator[]         @relation("TypingIndicators")
  messageDrafts               MessageDraft[]            @relation("MessageDrafts")
  pinnedMessages              PinnedMessage[]           @relation("PinnedMessages")
  conversationInvitesSent     ConversationInvite[]      @relation("ConversationInvitesSent")
  conversationInvitesReceived ConversationInvite[]      @relation("ConversationInvitesReceived")

  // File upload relations
  uploadedFiles      FileMetadata[]   @relation("UploadedFiles")
  fileVersions       FileVersion[]    @relation("FileVersions")
  filePermissions    FilePermission[] @relation("FilePermissions")
  grantedPermissions FilePermission[] @relation("GrantedPermissions")
  fileAuditLogs      FileAuditLog[]   @relation("FileAuditLogs")
  fileRecords        FileRecord[]

  // Timetable optimization relations
  timetableTemplates   TimetableTemplate[]
  templateApplications TemplateApplication[]

  // Sales Module relations
  assignedLeads         Lead[]         @relation("LeadAssignment")
  leadActivitiesCreated LeadActivity[] @relation("LeadActivityCreator")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, schoolId]) // Allow same email across different schools
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model TwoFactorToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model TwoFactorConfirmation {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}
