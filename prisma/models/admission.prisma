// Admission Campaign - Defines admission periods
model AdmissionCampaign {
  id                  String          @id @default(cuid())
  schoolId            String
  name                String
  academicYear        String
  startDate           DateTime
  endDate             DateTime
  status              AdmissionStatus @default(DRAFT)
  description         String?
  eligibilityCriteria Json?
  requiredDocuments   Json?
  applicationFee      Decimal?        @db.Decimal(10, 2)
  totalSeats          Int
  reservedSeats       Json? // Category-wise reservation
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  school              School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  applications        Application[]
  timeSlots           AdmissionTimeSlot[]
  applicationSessions ApplicationSession[]

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([status])
  @@index([startDate, endDate])
}

// Student Application
model Application {
  id                String @id @default(cuid())
  schoolId          String
  campaignId        String
  applicationNumber String @unique

  // Applicant Details
  firstName   String
  middleName  String?
  lastName    String
  dateOfBirth DateTime
  gender      Gender
  nationality String
  religion    String?
  category    String? // General/OBC/SC/ST etc

  // Contact Information
  email          String
  phone          String
  alternatePhone String?
  address        String
  city           String
  state          String
  postalCode     String
  country        String  @default("India")

  // Parent/Guardian Details
  fatherName       String
  fatherOccupation String?
  fatherPhone      String?
  fatherEmail      String?
  motherName       String
  motherOccupation String?
  motherPhone      String?
  motherEmail      String?
  guardianName     String?
  guardianRelation String?
  guardianPhone    String?
  guardianEmail    String?

  // Academic Details
  previousSchool     String?
  previousClass      String?
  previousMarks      Decimal? @db.Decimal(5, 2)
  previousPercentage Decimal? @db.Decimal(5, 2)
  achievements       String?  @db.Text

  // Application Details
  applyingForClass String
  preferredStream  String?
  secondLanguage   String?
  thirdLanguage    String?

  // Documents
  documents    Json? // Array of document URLs/IDs
  photoUrl     String?
  signatureUrl String?

  // Status Tracking
  status      AdmissionApplicationStatus @default(DRAFT)
  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?                    @db.Text

  // Merit & Selection
  entranceScore  Decimal? @db.Decimal(5, 2)
  interviewScore Decimal? @db.Decimal(5, 2)
  meritScore     Decimal? @db.Decimal(5, 2)
  meritRank      Int?
  waitlistNumber Int?

  // Admission Details
  admissionOffered   Boolean   @default(false)
  offerDate          DateTime?
  offerExpiryDate    DateTime?
  admissionConfirmed Boolean   @default(false)
  confirmationDate   DateTime?
  enrollmentNumber   String?

  // Payment
  applicationFeePaid Boolean   @default(false)
  paymentId          String?
  paymentDate        DateTime?

  // Public Status Tracker Access
  accessToken       String?   @unique // For status tracker without login
  accessTokenExpiry DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school         School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  campaign       AdmissionCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  communications Communication[]
  tourBookings   TourBooking[]

  @@unique([schoolId, applicationNumber])
  @@index([schoolId])
  @@index([campaignId])
  @@index([status])
  @@index([email])
  @@index([meritRank])
}

// Communication with applicants
model Communication {
  id            String              @id @default(cuid())
  schoolId      String
  applicationId String
  type          CommunicationType
  subject       String
  message       String              @db.Text
  sentAt        DateTime            @default(now())
  sentBy        String
  status        CommunicationStatus @default(SENT)

  school      School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([applicationId])
}

// Enums
enum AdmissionStatus {
  DRAFT
  OPEN
  CLOSED
  PROCESSING
  COMPLETED
}

enum AdmissionApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  SHORTLISTED
  ENTRANCE_SCHEDULED
  INTERVIEW_SCHEDULED
  SELECTED
  WAITLISTED
  REJECTED
  ADMITTED
  WITHDRAWN
}

enum CommunicationType {
  EMAIL
  SMS
  LETTER
  NOTIFICATION
}

enum CommunicationStatus {
  SENT
  DELIVERED
  FAILED
  READ
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// ============================================
// PUBLIC ADMISSION PORTAL MODELS
// ============================================

// Lead capture - Inquiry form for interested families
model AdmissionInquiry {
  id       String @id @default(cuid())
  schoolId String

  // Contact Information
  parentName String
  email      String
  phone      String?

  // Inquiry Details
  studentName     String?
  studentDOB      DateTime?
  interestedGrade String?
  source          String? // website, social, referral, advertisement
  message         String?   @db.Text

  // Status Tracking
  status       InquiryStatus @default(NEW)
  followUpDate DateTime?
  assignedTo   String? // Staff member ID
  notes        String?       @db.Text

  // Newsletter
  subscribeNewsletter Boolean @default(false)

  // Conversion tracking
  convertedToApplicationId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([status])
  @@index([email, schoolId])
}

// Tour/Interview Time Slots Configuration
model AdmissionTimeSlot {
  id         String  @id @default(cuid())
  schoolId   String
  campaignId String? // Optional: can be campaign-specific or school-wide

  // Slot Details
  slotType  SlotType // TOUR, INTERVIEW, ORIENTATION, OPEN_HOUSE
  date      DateTime @db.Date
  startTime DateTime @db.Time
  endTime   DateTime @db.Time

  // Capacity
  maxCapacity     Int @default(10)
  currentBookings Int @default(0)

  // Configuration
  isActive    Boolean @default(true)
  location    String? // Room, building, or virtual link
  conductedBy String? // Staff member ID
  notes       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school   School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  campaign AdmissionCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  bookings TourBooking[]

  @@unique([schoolId, date, startTime, slotType])
  @@index([schoolId])
  @@index([campaignId])
  @@index([date, slotType])
}

// Tour/Interview Bookings
model TourBooking {
  id            String  @id @default(cuid())
  schoolId      String
  slotId        String
  applicationId String? // Optional: can book before applying

  // Booking Reference
  bookingNumber String @unique

  // Contact Information (for guests without application)
  parentName      String
  email           String
  phone           String?
  studentName     String?
  interestedGrade String?

  // Booking Status
  status       BookingStatus @default(CONFIRMED)
  attendedAt   DateTime?
  noShowReason String?

  // Additional info
  specialRequests   String? @db.Text
  numberOfAttendees Int     @default(1)

  // Reminders
  reminderSent   Boolean   @default(false)
  reminderSentAt DateTime?

  // Cancellation
  cancelledAt  DateTime?
  cancelReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school      School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  slot        AdmissionTimeSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  application Application?      @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@index([schoolId])
  @@index([slotId])
  @@index([applicationId])
  @@index([email, schoolId])
  @@index([bookingNumber])
}

// Application Sessions (for save/resume functionality without login)
model ApplicationSession {
  id         String  @id @default(cuid())
  schoolId   String
  campaignId String?

  // Session Token (secure random for resume)
  sessionToken String @unique

  // Partial application data
  formData    Json
  currentStep Int  @default(1)

  // Contact for resume link
  email String

  // Expiry (7 days default)
  expiresAt DateTime

  // Conversion tracking
  convertedToApplicationId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school   School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  campaign AdmissionCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([schoolId])
  @@index([sessionToken])
  @@index([email, schoolId])
  @@index([campaignId])
}

// School-level Admission Settings
model AdmissionSettings {
  id       String @id @default(cuid())
  schoolId String @unique

  // General Settings
  allowMultipleApplications Boolean  @default(false)
  requireDocuments          Boolean  @default(true)
  defaultApplicationFee     Decimal? @db.Decimal(10, 2)
  offerExpiryDays           Int      @default(14)

  // Public Portal Settings
  enablePublicPortal  Boolean @default(true)
  enableInquiryForm   Boolean @default(true)
  enableTourBooking   Boolean @default(true)
  enableStatusTracker Boolean @default(true)

  // Notification Settings
  autoEmailNotifications Boolean @default(true)
  smsNotifications       Boolean @default(false)

  // Payment Settings
  enableOnlinePayment Boolean @default(false)
  stripeAccountId     String?
  paymentMethods      Json? // Array of enabled payment methods

  // Merit Criteria Weights
  academicWeight  Int @default(40)
  entranceWeight  Int @default(35)
  interviewWeight Int @default(25)

  // Tour/Interview Settings
  tourDuration      Int   @default(60) // minutes
  interviewDuration Int   @default(30) // minutes
  maxToursPerDay    Int   @default(5)
  tourDaysOfWeek    Json? // Array of days [0-6] when tours are available
  tourTimeSlots     Json? // Default time slots

  // Document Requirements
  documentRequirements Json? // Array of required documents with descriptions

  // Grade Level Configuration
  gradeMapping Json? // Map DOB ranges to grades

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

// OTP Verification for Status Tracker
model AdmissionOTP {
  id                String @id @default(cuid())
  schoolId          String
  email             String
  applicationNumber String

  // OTP Details
  otp       String
  expiresAt DateTime
  verified  Boolean  @default(false)
  attempts  Int      @default(0)

  createdAt DateTime @default(now())

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([email, applicationNumber])
  @@index([otp, expiresAt])
}

// New Enums for Public Portal
enum InquiryStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  UNQUALIFIED
  CLOSED
}

enum SlotType {
  TOUR
  INTERVIEW
  ORIENTATION
  OPEN_HOUSE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  RESCHEDULED
  COMPLETED
  NO_SHOW
}
