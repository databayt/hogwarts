// Attendance Models

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
  SICK
  HOLIDAY
}

enum AttendanceMethod {
  MANUAL
  GEOFENCE
  QR_CODE
  BARCODE
  RFID
  FINGERPRINT
  FACE_RECOGNITION
  NFC
  BLUETOOTH
  BULK_UPLOAD
  KIOSK // Self-service kiosk check-in/out
}

// Hall pass destination types
enum HallPassDestination {
  BATHROOM
  NURSE
  OFFICE
  COUNSELOR
  LIBRARY
  LOCKER
  WATER_FOUNTAIN
  OTHER
}

// Hall pass status
enum HallPassStatus {
  ACTIVE     // Student is currently out
  RETURNED   // Student returned on time
  EXPIRED    // Time limit exceeded
  CANCELLED  // Pass was cancelled
}

enum IdentifierType {
  BARCODE
  QR_CODE
  RFID_CARD
  NFC_TAG
  FINGERPRINT
  FACE_ID
  BLUETOOTH_MAC
  STUDENT_ID // Traditional student ID number
  MOBILE_DEVICE // Device ID for app-based tracking
}

model Attendance {
  id           String           @id @default(cuid())
  schoolId     String
  studentId    String
  classId      String
  date         DateTime         @db.Date
  status       AttendanceStatus
  notes        String?
  markedBy     String? // Teacher ID who marked attendance
  markedAt     DateTime         @default(now())
  method       AttendanceMethod @default(MANUAL) // How attendance was marked
  deviceId     String? // Device used for marking (optional)
  checkInTime  DateTime? // Exact check-in time
  checkOutTime DateTime? // Exact check-out time
  location     Json? // Location data if applicable
  confidence   Float? // Accuracy/confidence score for biometric methods
  deletedAt    DateTime? // Soft delete timestamp (null = not deleted)

  // Period-by-period tracking (for secondary schools)
  periodId    String? // Links to Period model for period-specific attendance
  timetableId String? // Links to specific timetable slot
  periodName  String? // Cached period name for quick display (e.g., "Period 1", "الحصة الأولى")

  school  School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class   Class             @relation(fields: [classId], references: [id], onDelete: Cascade)
  excuse  AttendanceExcuse? // Optional excuse submission

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Updated unique constraint to include optional periodId
  // When periodId is null, allows one record per student/class/date (daily tracking)
  // When periodId is set, allows multiple records per day (period-by-period tracking)
  @@unique([schoolId, studentId, classId, date, periodId])
  @@index([date])
  @@index([status])
  @@index([studentId])
  @@index([classId])
  @@index([method])
  @@index([periodId])
  @@index([schoolId, date, periodId])
  @@index([deletedAt])
  @@map("attendances")
}

// Student identification methods (cards, biometrics, etc.)
model StudentIdentifier {
  id         String         @id @default(cuid())
  schoolId   String
  studentId  String
  type       IdentifierType
  value      String // Card number, fingerprint hash, face encoding, etc.
  metadata   Json? // Additional data specific to the identifier type
  isActive   Boolean        @default(true)
  isPrimary  Boolean        @default(false)
  issuedAt   DateTime       @default(now())
  issuedBy   String? // User ID who issued this identifier
  expiresAt  DateTime?
  lastUsedAt DateTime?
  usageCount Int            @default(0)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([schoolId, type, value])
  @@index([studentId])
  @@index([type])
  @@index([isActive])
  @@index([expiresAt])
  @@map("student_identifiers")
}

// QR Code tracking for attendance sessions
model QRCodeSession {
  id            String    @id @default(cuid())
  schoolId      String
  classId       String
  code          String    @unique
  payload       Json // Encrypted payload data
  generatedBy   String // User ID who generated
  generatedAt   DateTime  @default(now())
  expiresAt     DateTime
  isActive      Boolean   @default(true)
  scanCount     Int       @default(0)
  maxScans      Int? // Maximum allowed scans
  scannedBy     Json      @default("[]") // Array of student IDs who scanned
  configuration Json? // QR code specific settings
  invalidatedAt DateTime?
  invalidatedBy String?

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class  Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([expiresAt])
  @@index([isActive])
  @@map("qr_code_sessions")
}

// Excuse submission status
enum ExcuseStatus {
  PENDING
  APPROVED
  REJECTED
}

// Intervention types for chronic absenteeism management
enum InterventionType {
  PARENT_PHONE_CALL // Initial phone call to parent
  PARENT_EMAIL // Email communication
  PARENT_MEETING // In-person or virtual meeting
  HOME_VISIT // Home visit by school staff
  COUNSELOR_REFERRAL // Referral to school counselor
  SOCIAL_WORKER_REFERRAL // Referral to social worker
  ADMINISTRATOR_MEETING // Meeting with principal/VP
  ATTENDANCE_CONTRACT // Written agreement with family
  TRUANCY_REFERRAL // Referral to truancy officer
  COMMUNITY_RESOURCE // Connection to community services
  ACADEMIC_SUPPORT // Academic intervention/tutoring
  MENTORSHIP_ASSIGNMENT // Assign mentor/buddy
  INCENTIVE_PROGRAM // Positive incentive enrollment
  OTHER // Other intervention type
}

// Intervention outcome status
enum InterventionStatus {
  SCHEDULED // Intervention is scheduled
  IN_PROGRESS // Currently ongoing
  COMPLETED // Successfully completed
  CANCELLED // Intervention was cancelled
  ESCALATED // Escalated to higher level
}

// Excuse reason categories
enum ExcuseReason {
  MEDICAL
  FAMILY_EMERGENCY
  RELIGIOUS
  SCHOOL_ACTIVITY
  TRANSPORTATION
  WEATHER
  OTHER
}

// Parent/Guardian excuse submission for absences
model AttendanceExcuse {
  id           String       @id @default(cuid())
  schoolId     String
  attendanceId String       @unique // One excuse per attendance record
  reason       ExcuseReason
  description  String?      @db.Text
  attachments  String[] // File URLs (medical notes, etc.)
  status       ExcuseStatus @default(PENDING)
  submittedBy  String // Guardian's user ID
  submittedAt  DateTime     @default(now())
  reviewedBy   String? // Teacher/Admin who reviewed
  reviewedAt   DateTime?
  reviewNotes  String? // Reason for approval/rejection

  school     School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  attendance Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([status])
  @@index([submittedBy])
  @@map("attendance_excuses")
}

// Pre-absence intention submission (student/parent notification)
// Allows students/parents to notify school about planned absences in advance
model AbsenceIntention {
  id          String        @id @default(cuid())
  schoolId    String
  studentId   String
  dateFrom    DateTime      @db.Date // Start of intended absence
  dateTo      DateTime      @db.Date // End of intended absence (can be same as dateFrom)
  reason      ExcuseReason  // Reuse existing ExcuseReason enum
  description String?       @db.Text // Additional details
  status      String        @default("PENDING") // PENDING, APPROVED, REJECTED
  submittedBy String        // User ID who submitted (student or guardian)
  reviewedBy  String?       // Teacher/Admin who reviewed
  reviewedAt  DateTime?
  reviewNotes String?       // Notes from reviewer
  attachments String[]      // Supporting documents (doctor's note, etc.)

  // Metadata
  notifyTeachers  Boolean   @default(true) // Auto-notify homeroom teacher
  notifyGuardians Boolean   @default(true) // Notify other guardians
  daysCount       Int       // Calculated number of school days affected

  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([studentId])
  @@index([status])
  @@index([dateFrom])
  @@index([dateTo])
  @@index([schoolId, status])
  @@map("absence_intentions")
}

// Intervention tracking for chronic absenteeism
model AttendanceIntervention {
  id             String             @id @default(cuid())
  schoolId       String
  studentId      String
  type           InterventionType
  title          String // Brief title/summary
  description    String             @db.Text // Detailed description of the intervention
  outcome        String?            @db.Text // Results/notes after completion
  status         InterventionStatus @default(SCHEDULED)
  priority       Int                @default(1) // 1=low, 2=medium, 3=high, 4=critical
  scheduledDate  DateTime? // When intervention is scheduled
  completedDate  DateTime? // When intervention was completed
  followUpDate   DateTime? // When to follow up
  initiatedBy    String // User ID who created/initiated
  assignedTo     String? // User ID assigned to handle (counselor, etc.)
  parentNotified Boolean            @default(false)
  escalatedFrom  String? // ID of previous intervention if escalated

  // Metadata
  contactMethod String? // How parent was contacted (phone, email, etc.)
  contactResult String? // Result of contact attempt
  documentsUrls String[] // Supporting documents
  tags          String[] // Custom tags for filtering

  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([studentId])
  @@index([status])
  @@index([type])
  @@index([scheduledDate])
  @@index([assignedTo])
  @@index([schoolId, studentId])
  @@map("attendance_interventions")
}

// ============================================================================
// KIOSK & HALL PASS MODELS (Phase 2)
// ============================================================================

// Hall pass for tracking students out of class during class time
// Inspired by Infinite Campus digital hall pass feature
model HallPass {
  id               String              @id @default(cuid())
  schoolId         String
  studentId        String
  classId          String              // Class the student left from
  destination      HallPassDestination
  destinationNote  String?             // Additional details for "OTHER" destination
  issuedBy         String              // Teacher ID who issued the pass
  issuedAt         DateTime            @default(now())
  expectedDuration Int                 // Expected duration in minutes
  expectedReturn   DateTime            // Calculated expected return time
  returnedAt       DateTime?           // Actual return time
  status           HallPassStatus      @default(ACTIVE)

  // Conflict detection
  conflictWith     String?             // Another student's pass ID if conflict detected

  // Metadata
  notes            String?             @db.Text
  photoUrl         String?             // Optional photo capture on departure

  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([studentId])
  @@index([classId])
  @@index([status])
  @@index([issuedAt])
  @@index([schoolId, status])
  @@index([schoolId, studentId, status])
  @@map("hall_passes")
}

// Kiosk session for self-service check-in/out stations
// Tracks kiosk activity and offline queue
model KioskSession {
  id           String   @id @default(cuid())
  schoolId     String
  kioskId      String   // Unique identifier for the physical kiosk
  kioskName    String   // Human-readable name (e.g., "Main Entrance", "Gym Exit")
  location     String?  // Physical location description
  isActive     Boolean  @default(true)
  lastPingAt   DateTime @default(now()) // Last heartbeat from kiosk

  // Configuration
  config       Json?    // Kiosk-specific settings (camera enabled, receipt printing, etc.)

  // Stats
  checkInsToday  Int    @default(0)
  checkOutsToday Int    @default(0)
  lastResetAt    DateTime @default(now())

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, kioskId])
  @@index([schoolId])
  @@index([isActive])
  @@map("kiosk_sessions")
}

// Kiosk check-in/out log for detailed tracking
model KioskLog {
  id           String   @id @default(cuid())
  schoolId     String
  kioskId      String   // References KioskSession.kioskId
  studentId    String
  action       String   // "CHECK_IN" or "CHECK_OUT"
  timestamp    DateTime @default(now())
  method       String   // "BARCODE", "QR_CODE", "MANUAL", "FACE"
  identifierValue String? // The scanned value

  // Optional data
  photoUrl     String?  // Photo captured at kiosk
  reasonCode   String?  // Late arrival or early departure reason
  reasonNote   String?  // Additional reason details

  // Sync status for offline support
  syncedToAttendance Boolean @default(false)
  attendanceId       String? // Link to created/updated Attendance record
  syncError          String? // Error message if sync failed

  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([schoolId])
  @@index([kioskId])
  @@index([studentId])
  @@index([timestamp])
  @@index([syncedToAttendance])
  @@index([schoolId, kioskId, timestamp])
  @@map("kiosk_logs")
}

// ============================================================================
// GAMIFICATION MODELS (Phase 4)
// ============================================================================

// Reason for awarding points
enum AttendanceRewardReason {
  DAILY_PRESENT        // Present for the day
  DAILY_ON_TIME        // Arrived on time (not late)
  WEEKLY_STREAK        // 5-day attendance streak
  BIWEEKLY_STREAK      // 10-day attendance streak
  MONTHLY_PERFECT      // Perfect attendance for the month
  BADGE_EARNED         // Points from earning a badge
  COMPETITION_WIN      // Class competition win
  IMPROVEMENT          // Attendance improvement bonus
  CUSTOM               // Admin-awarded points
}

// Attendance points record
model AttendanceReward {
  id          String                 @id @default(cuid())
  schoolId    String
  studentId   String
  points      Int                    // Points awarded (can be negative for penalties)
  reason      AttendanceRewardReason
  description String?                // Optional description
  awardedAt   DateTime               @default(now())
  awardedBy   String?                // User ID who awarded (null for automatic)

  // Reference to related records
  attendanceId String?               // Link to attendance record if applicable
  badgeId      String?               // Link to badge if awarded for earning badge

  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([schoolId])
  @@index([studentId])
  @@index([awardedAt])
  @@index([reason])
  @@index([schoolId, studentId])
  @@map("attendance_rewards")
}

// Badge definition (school-specific badge templates)
model AttendanceBadge {
  id          String   @id @default(cuid())
  schoolId    String
  code        String   // Unique code: PERFECT_WEEK, EARLY_BIRD, COMEBACK_KID, etc.
  name        String   // Display name
  nameAr      String?  // Arabic name
  description String   // Badge description
  descriptionAr String? // Arabic description
  icon        String   // Icon name or URL
  color       String   @default("#10B981") // Badge color (hex)
  pointValue  Int      @default(0) // Points awarded when badge is earned

  // Badge criteria
  criteria    Json?    // JSON with specific criteria for auto-award
  isActive    Boolean  @default(true)
  isAutomatic Boolean  @default(true) // Auto-award when criteria met

  school       School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentBadges StudentBadge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, code])
  @@index([schoolId])
  @@index([isActive])
  @@map("attendance_badges")
}

// Student badge awards
model StudentBadge {
  id        String   @id @default(cuid())
  schoolId  String
  studentId String
  badgeId   String
  awardedAt DateTime @default(now())
  awardedBy String?  // User ID who awarded (null for automatic)

  // Context for the award
  periodStart DateTime? // Start of period badge was earned for (e.g., week start)
  periodEnd   DateTime? // End of period
  metadata    Json?     // Additional data about the award

  school  School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  badge   AttendanceBadge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([schoolId, studentId, badgeId, periodStart]) // One badge per period
  @@index([schoolId])
  @@index([studentId])
  @@index([badgeId])
  @@index([awardedAt])
  @@map("student_badges")
}

// Attendance streak tracking (optimized for quick lookups)
model AttendanceStreak {
  id              String   @id @default(cuid())
  schoolId        String
  studentId       String   @unique // One streak record per student
  currentStreak   Int      @default(0) // Current consecutive days
  longestStreak   Int      @default(0) // Personal best
  streakStartDate DateTime? // When current streak started
  lastPresentDate DateTime? // Last day student was present

  // Monthly stats (reset monthly)
  monthlyPresent  Int      @default(0)
  monthlyLate     Int      @default(0)
  monthlyAbsent   Int      @default(0)
  monthStart      DateTime? // First day of tracked month

  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, studentId])
  @@index([schoolId])
  @@index([currentStreak])
  @@index([longestStreak])
  @@map("attendance_streaks")
}

// Class competition for attendance
model AttendanceCompetition {
  id          String   @id @default(cuid())
  schoolId    String
  name        String   // Competition name
  nameAr      String?  // Arabic name
  description String?
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)

  // Prizes/rewards
  winnerReward   String? // Description of prize for winning class
  participantPoints Int @default(0) // Points for participating students
  winnerPoints   Int    @default(100) // Bonus points for winning class students

  // Results
  winnerId       String? // Winning class ID
  winnerRate     Float?  // Winning attendance rate

  school  School                     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  entries ClassCompetitionEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
  @@map("attendance_competitions")
}

// Class entry in a competition
model ClassCompetitionEntry {
  id            String @id @default(cuid())
  schoolId      String
  competitionId String
  classId       String

  // Tracked metrics
  totalStudents   Int    @default(0)
  presentDays     Int    @default(0)
  lateDays        Int    @default(0)
  absentDays      Int    @default(0)
  attendanceRate  Float  @default(0) // Calculated percentage

  // Ranking
  rank            Int?   // Calculated rank in competition

  school      School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  competition AttendanceCompetition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  class       Class                 @relation(fields: [classId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([competitionId, classId])
  @@index([schoolId])
  @@index([competitionId])
  @@index([classId])
  @@index([attendanceRate])
  @@map("class_competition_entries")
}
