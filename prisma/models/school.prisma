// School and School Structure Models

model School {
  id          String   @id @default(cuid())
  name        String
  domain      String   @unique // e.g., "hogwarts" for hogwarts.schoolapp.com
  logoUrl     String?
  address     String?
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  phoneNumber String?
  email       String?
  website     String?
  timezone    String   @default("Africa/Khartoum")
  preferredLanguage String @default("ar") // Admin's chosen content language ("ar" or "en")

  // School classification
  schoolType  String? // private, public, international, technical, special
  schoolLevel String? // primary, secondary, both
  system      String? // clickview, national, british, ib
  description String? @db.Text

  // Location breakdown (address stays as street address)
  city    String?
  state   String?
  country String?

  // Subscription/billing info (high-level; detailed state in Subscription)
  planType    String  @default("basic") // basic, premium, enterprise
  maxStudents Int     @default(100)
  maxTeachers Int     @default(10)
  isActive    Boolean @default(true)

  // Pricing
  tuitionFee      Decimal? @db.Decimal(10, 2)
  registrationFee Decimal? @db.Decimal(10, 2)
  applicationFee  Decimal? @db.Decimal(10, 2)
  currency        String   @default("USD")
  paymentSchedule String   @default("annual") // monthly, quarterly, semester, annual

  // Capacity
  maxClasses Int @default(20)

  // Video storage quota (Stream LMS)
  videoStorageUsedBytes  BigInt? @default(0)
  videoStorageQuotaBytes BigInt? // null = unlimited

  // Join code for users to self-enroll (6-char alphanumeric, regeneratable)
  joinCode String? @unique

  // Owner tracking - immutable, set during school creation
  // Ensures one user can only create one school (prevents duplicates from race conditions)
  createdByUserId String? @unique

  // Onboarding lifecycle
  onboardingStep        String?
  onboardingCompletedAt DateTime?
  isPublished           Boolean @default(false)

  // School relationships
  users                    User[]
  schoolYears              SchoolYear[]
  periods                  Period[]
  terms                    Term[]
  departments              Department[]
  yearLevels               YearLevel[]
  students                 Student[]
  teachers                 Teacher[]
  teacherQualifications    TeacherQualification[]
  teacherExperiences       TeacherExperience[]
  teacherSubjectExpertise  TeacherSubjectExpertise[]
  workloadConfigs          WorkloadConfig[]
  guardians                Guardian[]
  // Staff (non-teaching employees) relations
  staffMembers             StaffMember[]
  staffPhoneNumbers        StaffPhoneNumber[]
  staffQualifications      StaffQualification[]
  staffExperiences         StaffExperience[]
  staffSalaryStructures    StaffSalaryStructure[]
  staffSalarySlips         StaffSalarySlip[]
  staffTimesheetEntries    StaffTimesheetEntry[]
  staffAccessCards         StaffAccessCard[]
  classrooms               Classroom[]
  classroomTypes           ClassroomType[]
  teacherDepartments       TeacherDepartment[]
  teacherPhoneNumbers      TeacherPhoneNumber[]
  guardianTypes            GuardianType[]
  studentGuardians         StudentGuardian[]
  guardianPhoneNumbers     GuardianPhoneNumber[]
  studentYearLevels        StudentYearLevel[]
  subjects                 Subject[]
  classes                  Class[]
  studentClasses           StudentClass[]
  classTeachers            ClassTeacher[]
  scoreRanges              ScoreRange[]
  assignments              Assignment[]
  assignmentSubmissions    AssignmentSubmission[]
  attendances              Attendance[]
  announcements              Announcement[]
  announcementTemplates      AnnouncementTemplate[]
  announcementConfig         AnnouncementConfig?
  announcementReads          AnnouncementRead[]
  announcementNotifications  AnnouncementNotification[]
  domainRequests           DomainRequest[]
  subscriptions            Subscription[]
  invoices                 Invoice[]
  // Standalone invoice block relations
  userInvoices             UserInvoice[]
  userInvoiceItems         UserInvoiceItem[]
  userInvoiceAddresses     UserInvoiceAddress[]
  userInvoiceSettings      UserInvoiceSettings[]
  userInvoiceSignatures    UserInvoiceSignature[]
  timetables               Timetable[]
  schoolWeekConfigs        SchoolWeekConfig[]
  // Timetable optimization relations
  teacherConstraints       TeacherConstraint[]
  teacherUnavailableBlocks TeacherUnavailableBlock[]
  roomConstraints          RoomConstraint[]
  timetableTemplates       TimetableTemplate[]
  templateApplications     TemplateApplication[]
  scheduleExceptions       ScheduleException[]
  // Legal relations
  legalConsents            LegalConsent[]
  legalDocuments           LegalDocument[]
  complianceLogs           ComplianceLog[]
  // Subscription relations
  discounts                Discount[]
  appliedDiscounts         AppliedDiscount[]
  // Branding and visibility
  branding                 SchoolBranding?
  // Events relations
  events                   Event[]

  // Examination relations
  exams            Exam[]
  examResults      ExamResult[]
  gradeBoundaries  GradeBoundary[]
  // Gradebook relations
  results          Result[]
  reportCards      ReportCard[]
  reportCardGrades ReportCardGrade[]

  // Stream (LMS) relations
  streamCourses      StreamCourse[]
  streamCategories   StreamCategory[]
  streamEnrollments  StreamEnrollment[]
  streamCertificates StreamCertificate[]

  // Library relations
  books         Book[]
  borrowRecords BorrowRecord[]

  // Lesson relations
  lessons Lesson[]

  // Student management relations
  studentBatches      StudentBatch[]
  batches             Batch[]
  studentDocuments    StudentDocument[]
  healthRecords       HealthRecord[]
  achievements        Achievement[]
  disciplinaryRecords DisciplinaryRecord[]
  libraryRecords      LibraryRecord[]
  feeRecords          FeeRecord[]

  // Banking relations
  bankAccounts    BankAccount[]
  transactions    Transaction[]
  transfers       Transfer[]
  plaidItems      PlaidItem[]
  dwollaCustomers DwollaCustomer[]

  // Admission relations
  admissionCampaigns  AdmissionCampaign[]
  applications        Application[]
  communications      Communication[]
  admissionInquiries  AdmissionInquiry[]
  admissionTimeSlots  AdmissionTimeSlot[]
  tourBookings        TourBooking[]
  applicationSessions ApplicationSession[]
  admissionSettings   AdmissionSettings?
  admissionOTPs       AdmissionOTP[]
  visits              Visit[]

  // Fees relations
  feeStructures           FeeStructure[]
  feeAssignments          FeeAssignment[]
  payments                Payment[]
  refunds                 Refund[]
  scholarships            Scholarship[]
  scholarshipApplications ScholarshipApplication[]
  fines                   Fine[]

  // Geo-Attendance relations
  geoFences           GeoFence[]
  locationTraces      LocationTrace[]
  geoAttendanceEvents GeoAttendanceEvent[]

  // Billing relations
  billingPaymentMethods BillingPaymentMethod[]
  billingHistory        BillingHistory[]
  usageMetrics          UsageMetrics[]

  // Receipt tracking relations
  expenseReceipts    ExpenseReceipt[]
  creditNotes        CreditNote[]
  billingPreferences BillingPreferences?

  // Enhanced Attendance relations
  studentIdentifiers      StudentIdentifier[]
  attendanceDevices       AttendanceDevice[]
  attendanceSessions      AttendanceSession[]
  attendanceEvents        AttendanceEvent[]
  attendanceExcuses       AttendanceExcuse[]
  qrCodeSessions          QRCodeSession[]
  biometricTemplates      BiometricTemplate[]
  accessCards             AccessCard[]
  bluetoothBeacons        BluetoothBeacon[]
  attendancePolicies      AttendancePolicy[]
  policyTriggers          PolicyTrigger[]
  policyExemptions        PolicyExemption[]
  masterAttendance        MasterAttendance[]
  attendanceReports       AttendanceReport[]
  attendanceInterventions AttendanceIntervention[]
  absenceIntentions       AbsenceIntention[]
  hallPasses              HallPass[]
  kioskSessions           KioskSession[]
  kioskLogs               KioskLog[]
  teacherAbsences         TeacherAbsence[]
  substitutionRecords     SubstitutionRecord[]

  // Gamification relations
  attendanceRewards       AttendanceReward[]
  attendanceBadges        AttendanceBadge[]
  studentBadges           StudentBadge[]
  attendanceStreaks       AttendanceStreak[]
  attendanceCompetitions  AttendanceCompetition[]
  classCompetitionEntries ClassCompetitionEntry[]

  // Quiz relations
  quizGames         QuizGame[]
  quizGameQuestions QuizGameQuestion[]
  quizCategories    QuizCategory[]
  quizCategoryStats QuizCategoryStats[]
  quizAchievements  QuizAchievement[]
  quizLeaderboards  QuizLeaderboard[]

  // Finance Module Relations (NEW)
  chartOfAccounts     ChartOfAccount[]
  fiscalYears         FiscalYear[]
  journalEntries      JournalEntry[]
  ledgerEntries       LedgerEntry[]
  accountBalances     AccountBalance[]
  bankReconciliations BankReconciliation[]
  salaryStructures    SalaryStructure[]
  salaryAllowances    SalaryAllowance[]
  salaryDeductions    SalaryDeduction[]
  payrollRuns         PayrollRun[]
  salarySlips         SalarySlip[]
  timesheetPeriods    TimesheetPeriod[]
  timesheetEntries    TimesheetEntry[]
  wallets             Wallet[]
  walletTransactions  WalletTransaction[]
  budgets             Budget[]
  budgetAllocations   BudgetAllocation[]
  expenseCategories   ExpenseCategory[]
  expenses            Expense[]
  financialReports    FinancialReport[]
  financePermissions  FinancePermission[]

  // QBank Automation relations
  sourceMaterials SourceMaterial[]
  generationJobs  GenerationJob[]

  // Notification relations
  notifications             Notification[]
  notificationPreferences   NotificationPreference[]
  notificationTemplates     NotificationTemplate[]
  notificationBatches       NotificationBatch[]
  notificationSubscriptions NotificationSubscription[]
  notificationSummaries     NotificationSummary[]

  // Messaging relations
  conversations    Conversation[]
  typingIndicators TypingIndicator[]

  // File upload relations
  fileMetadata FileMetadata[]
  uploadQuotas UploadQuota[]
  fileRecords  FileRecord[]

  // Translation cache
  translationCache TranslationCache[]

  // Audit relations
  auditLogs     AuditLog[]
  loginAttempts LoginAttempt[]

  // Sales Module relations
  leads          Lead[]
  leadActivities LeadActivity[]

  // Profile relations (GitHub-style)
  userActivities UserActivity[]
  pinnedItems    PinnedItem[]

  // Exam Paper & Certificate relations
  examPaperConfigs       ExamPaperConfig[]
  generatedPapers        GeneratedPaper[]
  examAnswerKeys         ExamAnswerKey[]
  examCertificateConfigs ExamCertificateConfig[]
  examCertificates       ExamCertificate[]
  examSessions           ExamSession[]
  gradingConfig          SchoolGradingConfig?

  // Curriculum Standards relations
  curriculumStandards CurriculumStandard[]
  questionStandards   QuestionStandard[]

  // Quick Assessment relations
  quickAssessments         QuickAssessment[]
  quickAssessmentResponses QuickAssessmentResponse[]

  // Progress Report relations
  progressReportSchedules  ProgressReportSchedule[]
  generatedProgressReports GeneratedProgressReport[]

  // Academic Structure relations
  academicLevels  AcademicLevel[]
  academicGrades  AcademicGrade[]
  academicStreams  AcademicStream[]

  // Catalog Bridge relations
  schoolSubjectSelections SchoolSubjectSelection[]
  schoolContentOverrides  SchoolContentOverride[]

  // Enrollment relations (catalog)
  catalogEnrollments     Enrollment[]
  catalogCertificates    SubjectCertificate[]

  // Grading Scheme relations
  gradingSchemes GradingScheme[]

  // Lesson Content relations
  lessonVideos LessonVideo[]

  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  QuestionBank          QuestionBank[]
  ExamTemplate          ExamTemplate[]
  GeneratedExam         GeneratedExam[]
  GeneratedExamQuestion GeneratedExamQuestion[]
  QuestionAnalytics     QuestionAnalytics[]
  Rubric                Rubric[]
  RubricCriterion       RubricCriterion[]
  StudentAnswer         StudentAnswer[]
  MarkingResult         MarkingResult[]
  GradeOverride         GradeOverride[]

  @@map("schools")
}

model Subscription {
  id                   String   @id @default(cuid())
  schoolId             String
  stripeSubscriptionId String   @unique
  stripeCustomerId     String
  stripePriceId        String
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean  @default(false)
  status               String // active, past_due, canceled, etc
  tierId               String

  school           School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subscriptionTier SubscriptionTier @relation(fields: [tierId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscriptions")
}

model Invoice {
  id              String   @id @default(cuid())
  schoolId        String
  stripeInvoiceId String   @unique
  amountDue       Int
  amountPaid      Int
  currency        String
  status          String // draft, open, paid, uncollectible, void
  periodStart     DateTime
  periodEnd       DateTime

  school           School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  receipts         Receipt[]
  appliedDiscounts AppliedDiscount[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invoices")
}

model SchoolYear {
  id        String   @id @default(cuid())
  schoolId  String
  yearName  String
  startDate DateTime
  endDate   DateTime

  school            School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  periods           Period[]
  terms             Term[]
  studentYearLevels StudentYearLevel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, yearName]) // Unique year name per school
  @@map("school_years")
}

model Period {
  id        String   @id @default(cuid())
  schoolId  String
  yearId    String
  name      String
  startTime DateTime @db.Time()
  endTime   DateTime @db.Time()

  school         School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolYear     SchoolYear  @relation(fields: [yearId], references: [id], onDelete: Cascade)
  classesAsStart Class[]     @relation("ClassStartPeriod")
  classesAsEnd   Class[]     @relation("ClassEndPeriod")
  timetables     Timetable[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, yearId, name]) // Unique period name per school year
  @@map("periods")
}

model Term {
  id         String   @id @default(cuid())
  schoolId   String
  yearId     String
  termNumber Int
  startDate  DateTime
  endDate    DateTime
  isActive   Boolean  @default(false) // Active term for timetable auto-selection

  school            School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolYear        SchoolYear         @relation(fields: [yearId], references: [id], onDelete: Cascade)
  classes           Class[]
  timetables        Timetable[]
  schoolWeekConfigs SchoolWeekConfig[]
  reportCards       ReportCard[]

  // Timetable optimization relations
  teacherConstraints   TeacherConstraint[]
  roomConstraints      RoomConstraint[]
  timetableTemplates   TimetableTemplate[]   @relation("TemplateSourceTerm")
  templateApplications TemplateApplication[]
  scheduleExceptions   ScheduleException[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, yearId, termNumber]) // Unique term number per school year
  @@index([schoolId, isActive]) // Index for active term lookup
  @@map("terms")
}

model YearLevel {
  id          String  @id @default(cuid())
  schoolId    String
  levelName   String
  lang        String  @default("ar") // Content language
  levelOrder  Int

  school            School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentYearLevels StudentYearLevel[]
  reportCards       ReportCard[]
  batches           Batch[]
  academicGrades    AcademicGrade[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, levelName]) // Unique level name per school
  @@unique([schoolId, levelOrder]) // Unique level order per school
  @@map("year_levels")
}
