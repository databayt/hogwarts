// ============================================================================
// QUESTION BANK (QBANK) SYSTEM - COMPLETE
// ============================================================================
// This file contains all models for the comprehensive QBank system:
// 1. Question Bank - Core question repository
// 2. Question Analytics - Performance tracking
// 3. Exam Templates - Reusable exam blueprints
// 4. Generated Exams - Auto-generated exam instances
// 5. AI Automation - Source materials & generation jobs
// 6. Review System - Quality control workflow
// ============================================================================

// ========== ENUMS ==========

// Question Types
enum QuestionType {
  MULTIPLE_CHOICE // MCQ with multiple options
  TRUE_FALSE // Boolean question
  SHORT_ANSWER // 1-2 sentence response
  ESSAY // Long-form answer
  FILL_BLANK // Fill in the blanks
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

// Bloom's Taxonomy Cognitive Levels
enum BloomLevel {
  REMEMBER // Level 1: Recall facts
  UNDERSTAND // Level 2: Explain concepts
  APPLY // Level 3: Use in new situations
  ANALYZE // Level 4: Draw connections
  EVALUATE // Level 5: Justify decisions
  CREATE // Level 6: Produce new work
}

enum QuestionSource {
  MANUAL // Created manually by teacher
  AI // Generated by AI
  IMPORTED // Imported from external source
}

// AI Automation Enums
enum SourceType {
  PDF_TEXTBOOK
  PDF_STUDY_GUIDE
  WEB_ARTICLE
  VIDEO_TRANSCRIPT
  CURRICULUM_DOCUMENT
  CLINICAL_GUIDELINE
  RESEARCH_PAPER
  LECTURE_NOTES
  PAST_PAPER
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  ARCHIVED
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  PAUSED
}

enum ReviewStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  NEEDS_REVISION
}

// ========== CORE QUESTION BANK ==========

// Question Bank - Reusable question library
model QuestionBank {
  id           String          @id @default(cuid())
  schoolId     String
  subjectId    String
  questionText String          @db.Text
  questionType QuestionType
  difficulty   DifficultyLevel
  bloomLevel   BloomLevel
  points       Decimal         @default(1) @db.Decimal(5, 2)
  timeEstimate Int? // Estimated time in minutes

  // Question-specific data (JSON)
  // For MCQ/True-False: [{text: string, isCorrect: boolean, explanation?: string}]
  // For Fill-in-Blank: {acceptedAnswers: string[], caseSensitive: boolean}
  options Json?

  // For Short Answer/Essay
  sampleAnswer  String? @db.Text
  gradingRubric String? @db.Text

  // Metadata
  tags        String[] // ["cardiology", "heart-failure", "mrcp"]
  explanation String?        @db.Text
  source      QuestionSource @default(MANUAL)
  aiPrompt    String?        @db.Text // For AI-generated questions
  imageUrl    String? // Optional question image

  // AI Generation fields (QBank Automation)
  generationJobId String?
  generationJob   GenerationJob?  @relation(fields: [generationJobId], references: [id])
  sourceId        String?
  sourceMaterial  SourceMaterial? @relation(fields: [sourceId], references: [id])
  aiModel         String? // claude-3-5-sonnet-20241022, gpt-4, etc.
  generatedAt     DateTime?
  validationScore Decimal?        @db.Decimal(5, 2) // 0-100 quality score

  // Relations
  school                 School                  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject                Subject                 @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  generatedExamQuestions GeneratedExamQuestion[]
  analytics              QuestionAnalytics?
  review                 QuestionReview? // AI generation review

  // Marking system relations
  rubrics        Rubric[]
  studentAnswers StudentAnswer[]
  markingResults MarkingResult[]

  // Quiz game relations
  quizGameQuestions QuizGameQuestion[]

  createdBy String // Teacher/System ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance indexes
  @@index([schoolId, subjectId])
  @@index([schoolId, difficulty, bloomLevel])
  @@index([schoolId, questionType])
  @@index([schoolId, createdBy])
  @@index([schoolId, source])
  @@index([schoolId, generationJobId])
  @@index([validationScore])
  @@index([schoolId, subjectId, questionType]) // Composite for subject questions by type
  @@index([schoolId, subjectId, difficulty]) // Composite for difficulty filtering
  @@index([schoolId, tags]) // For tag-based searches
  @@index([createdAt]) // For sorting
  @@index([schoolId, subjectId, bloomLevel]) // Composite for Bloom's taxonomy queries
  // @@fulltext([questionText]) // Full-text search on question content (not supported in PostgreSQL via Prisma)
  @@map("question_bank")
}

// Question Analytics - Track question performance with psychometric analysis
model QuestionAnalytics {
  id         String @id @default(cuid())
  schoolId   String
  questionId String @unique

  timesUsed    Int      @default(0)
  avgScore     Decimal? @db.Decimal(5, 2)
  successRate  Float? // Percentage 0-100
  avgTimeSpent Float? // Average time in minutes

  // Difficulty analysis
  perceivedDifficulty DifficultyLevel? // Based on student performance

  // Psychometric indices (Classical Test Theory)
  difficultyIndex     Decimal? @db.Decimal(5, 4) // p-value (0-1): proportion correct
  discriminationIndex Decimal? @db.Decimal(5, 4) // D-index (-1 to 1): high vs low group diff
  pointBiserial       Decimal? @db.Decimal(5, 4) // Item-total correlation (-1 to 1)

  // Distractor analysis for MCQ (JSON array)
  // Format: [{optionIndex: number, selectedCount: number, highGroupCount: number, lowGroupCount: number, isCorrect: boolean}]
  distractorAnalysis Json?

  // Quality scoring and recommendations
  qualityScore      Int?     // Composite quality score 0-100
  qualityFlags      String[] // ["too_easy", "too_hard", "low_discrimination", "negative_discrimination", "insufficient_data"]
  recommendedAction String?  // "keep", "revise", "retire", "needs_review"
  sampleSize        Int      @default(0) // Number of responses analyzed
  lastAnalyzedAt    DateTime?

  // Relations
  school   School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  question QuestionBank @relation(fields: [questionId], references: [id], onDelete: Cascade)

  lastUsed  DateTime?
  updatedAt DateTime  @updatedAt

  // Performance indexes
  @@index([schoolId, questionId])
  @@index([schoolId, timesUsed])
  @@index([schoolId, successRate])
  @@index([avgScore]) // For identifying problematic questions
  @@index([perceivedDifficulty]) // For difficulty analysis
  @@index([lastUsed]) // For usage frequency analysis
  @@index([schoolId, qualityScore]) // For quality-based filtering
  @@index([schoolId, recommendedAction]) // For action-needed questions
  @@index([difficultyIndex]) // For difficulty distribution
  @@index([discriminationIndex]) // For discrimination analysis
  @@map("question_analytics")
}

// Question Response - Individual responses for psychometric analysis
model QuestionResponse {
  id           String  @id @default(cuid())
  schoolId     String
  questionId   String
  studentId    String
  examId       String

  // Response data
  isCorrect    Boolean
  pointsAwarded Decimal @db.Decimal(5, 2)
  maxPoints    Decimal @db.Decimal(5, 2)
  selectedOptions String[] // For MCQ: which options were selected

  // For discrimination calculation
  studentTotal  Decimal? @db.Decimal(6, 2) // Student's total exam score
  studentRank   Int?     // Student's rank in this exam (for high/low grouping)

  // Timing
  responseTime  Int?     // Time spent on question in seconds
  createdAt     DateTime @default(now())

  // No direct relations to avoid circular dependencies
  // Use questionId, studentId, examId for lookups

  @@unique([examId, questionId, studentId])
  @@index([schoolId])
  @@index([schoolId, questionId])
  @@index([schoolId, examId])
  @@index([schoolId, studentId])
  @@index([schoolId, questionId, isCorrect]) // For difficulty calculation
  @@index([questionId, studentRank]) // For discrimination calculation
  @@map("question_responses")
}

// ========== EXAM GENERATION ==========

// Exam Templates - Reusable exam blueprints
model ExamTemplate {
  id          String  @id @default(cuid())
  schoolId    String
  name        String
  description String? @db.Text
  subjectId   String
  duration    Int // Minutes
  totalMarks  Decimal @db.Decimal(6, 2)

  // Distribution rules (JSON structure)
  // Example: {
  //   "MULTIPLE_CHOICE": {"EASY": 5, "MEDIUM": 3, "HARD": 2},
  //   "SHORT_ANSWER": {"MEDIUM": 3}
  // }
  distribution Json

  // Optional Bloom's distribution
  // Example: {"REMEMBER": 4, "UNDERSTAND": 3, "APPLY": 3}
  bloomDistribution Json?

  // Relations
  school         School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject        Subject         @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  generatedExams GeneratedExam[]

  createdBy String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance indexes
  @@index([schoolId, subjectId])
  @@index([schoolId, isActive])
  @@index([schoolId, createdBy])
  @@index([schoolId, subjectId, isActive]) // Composite for active subject templates
  @@index([createdAt]) // For sorting
  // @@fulltext([name, description]) // Full-text search on template info (not supported in PostgreSQL via Prisma)
  @@map("exam_templates")
}

// Generated Exams - Links templates to actual exams
model GeneratedExam {
  id             String  @id @default(cuid())
  schoolId       String
  examId         String // Links to Exam model
  templateId     String?
  isRandomized   Boolean @default(false)
  seed           String? // For reproducible randomization
  totalQuestions Int     @default(0)

  // Metadata
  generationNotes String? @db.Text

  // Relations
  school    School                  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  exam      Exam                    @relation(fields: [examId], references: [id], onDelete: Cascade)
  template  ExamTemplate?           @relation(fields: [templateId], references: [id], onDelete: SetNull)
  questions GeneratedExamQuestion[]

  // Paper & Answer Key relations
  paperConfig ExamPaperConfig? // Paper configuration (one-to-one)
  answerKey   ExamAnswerKey? // Generated answer key (one-to-one)

  generatedBy String
  createdAt   DateTime @default(now())

  @@unique([examId]) // One generated exam per exam
  // Performance indexes
  @@index([schoolId, examId])
  @@index([schoolId, templateId])
  @@index([schoolId, generatedBy])
  @@index([createdAt]) // For sorting by generation date
  @@index([schoolId, isRandomized]) // For filtering random vs fixed exams
  @@map("generated_exams")
}

// Questions in a Generated Exam
model GeneratedExamQuestion {
  id              String  @id @default(cuid())
  schoolId        String
  generatedExamId String
  questionId      String
  order           Int
  points          Decimal @db.Decimal(5, 2)

  // Optional per-question overrides
  customInstructions String? @db.Text

  // Relations
  school        School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  generatedExam GeneratedExam @relation(fields: [generatedExamId], references: [id], onDelete: Cascade)
  question      QuestionBank  @relation(fields: [questionId], references: [id], onDelete: Restrict)

  @@unique([generatedExamId, order])
  @@unique([generatedExamId, questionId]) // No duplicate questions in same exam
  // Performance indexes
  @@index([schoolId, generatedExamId])
  @@index([schoolId, questionId])
  @@index([order]) // For question sequencing
  @@index([points]) // For points distribution analysis
  @@map("generated_exam_questions")
}

// ========== AI AUTOMATION SYSTEM ==========

// Source Material - PDFs, curricula, textbooks for AI generation
model SourceMaterial {
  id       String @id @default(cuid())
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Source identification
  title    String
  type     SourceType
  url      String? // Original URL if web-based
  filePath String? // Vercel Blob or S3 path for PDFs
  fileName String?
  fileSize Int? // bytes

  // Authorship
  author          String?
  publisher       String?
  publicationDate DateTime?
  isbn            String?

  // Content metadata
  subject  String // Cardiology, Mathematics, etc.
  examType String // MRCP_PART_1, USMLE, SAT, etc.
  language String @default("en")

  // Processing status
  status      ProcessingStatus @default(PENDING)
  processedAt DateTime?
  totalPages  Int?
  totalChunks Int              @default(0)

  // Attribution & licensing
  license     String? // CC-BY, Fair Use, Public Domain, etc.
  attribution String  @db.Text
  sourceUrl   String? // Link back to original

  // Quality & usage
  qualityScore Decimal? @db.Decimal(5, 2) // 0-100
  timesUsed    Int      @default(0)

  // Relations
  chunks    SourceChunk[]
  questions QuestionBank[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance indexes
  @@index([schoolId, examType, subject])
  @@index([status])
  @@index([examType])
  @@index([schoolId, type, status]) // Composite for source type filtering
  @@index([schoolId, subject, status]) // Composite for subject materials
  @@index([qualityScore]) // For quality-based selection
  @@index([timesUsed]) // For usage analytics
  // @@fulltext([title]) // Full-text search on title (not supported in PostgreSQL via Prisma)
  @@map("source_materials")
}

// Source Chunk - Chunked content with embeddings for semantic search
model SourceChunk {
  id       String         @id @default(cuid())
  sourceId String
  source   SourceMaterial @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  // Chunk content
  content      String  @db.Text
  pageNumber   Int?
  sectionTitle String?
  chapterTitle String?

  // Vector embedding for semantic search
  // Stored as JSON array, converted to pgvector in queries
  embedding String? @db.Text // JSON array of floats

  // Metadata
  chunkIndex Int
  tokenCount Int @default(0)

  // Usage tracking
  questionsGenerated Int       @default(0)
  lastUsed           DateTime?

  createdAt DateTime @default(now())

  @@unique([sourceId, chunkIndex])
  @@index([sourceId])
  @@map("source_chunks")
}

// Generation Job - Batch question generation jobs
model GenerationJob {
  id       String @id @default(cuid())
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Job configuration
  name         String? // Optional job name
  targetCount  Int // How many questions to generate
  examType     String // MRCP_PART_1, USMLE, etc.
  subjects     String[] // Which subjects to cover
  distribution Json // Question type & difficulty distribution

  // AI configuration
  aiModel     String  @default("claude-3-5-sonnet-20241022")
  temperature Decimal @default(0.7) @db.Decimal(3, 2)

  // Execution
  status      JobStatus @default(PENDING)
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int? // seconds

  // Results
  questionsGenerated Int @default(0)
  questionsApproved  Int @default(0)
  questionsRejected  Int @default(0)

  // Quality metrics
  avgValidationScore Decimal? @db.Decimal(5, 2)

  // Error handling
  errors     Json?
  retryCount Int   @default(0)
  maxRetries Int   @default(3)

  // Triggered by
  triggeredBy String? // userId or "CRON"

  // Relations
  questions QuestionBank[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance indexes
  @@index([schoolId, status])
  @@index([examType])
  @@index([status, createdAt])
  @@index([schoolId, status, createdAt]) // Composite for job queue
  @@index([schoolId, examType, status]) // Composite for exam type jobs
  @@index([triggeredBy]) // For user job tracking
  @@index([completedAt]) // For completion analysis
  @@map("generation_jobs")
}

// Question Review - Manual review queue for AI-generated questions
model QuestionReview {
  id         String       @id @default(cuid())
  questionId String       @unique
  question   QuestionBank @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // Review status
  status ReviewStatus @default(PENDING)

  // Reviewer
  reviewedBy String?
  reviewer   User?     @relation(fields: [reviewedBy], references: [id])
  reviewedAt DateTime?

  // Review details
  approved       Boolean?
  qualityRating  Int? // 1-5
  accuracyRating Int? // 1-5

  // Feedback
  reviewNotes    String? @db.Text
  suggestedEdits Json?

  // Flags
  flaggedIssues String[] // grammar, accuracy, clarity, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance indexes
  @@index([status])
  @@index([reviewedBy])
  @@index([status, createdAt])
  @@index([status, reviewedAt]) // For review completion tracking
  @@index([qualityRating]) // For quality analysis
  @@index([accuracyRating]) // For accuracy analysis
  @@map("question_reviews")
}
